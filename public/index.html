<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storage Manage Method</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f3f4f6; color: #111827; }
    header { background: #111827; color: white; padding: 0.75rem 1.25rem; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
    header h1 { font-size: 1rem; margin: 0; letter-spacing: 0.03em; }
    header small { display: block; font-size: 0.7rem; opacity: 0.8; }
    .header-right { display: flex; align-items: center; gap: 0.75rem; font-size: 0.8rem; flex-wrap: wrap; }
    .badge { display: inline-flex; align-items: center; padding: 0.15rem 0.6rem; border-radius: 999px; font-size: 0.75rem; background: #e5e7eb; color: #111827; }
    .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 999px; border: none; padding: 0.55rem 1.15rem; font-size: 0.9rem; cursor: pointer; transition: background 0.15s, transform 0.1s; }
    .btn-primary { background: #111827; color: white; }
    .btn-primary:hover { background: #020617; transform: translateY(-1px); }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-secondary:hover { background: #d1d5db; transform: translateY(-1px); }
    .btn-sm { padding: 0.45rem 0.9rem; font-size: 0.82rem; }
    main { padding: 1rem; max-width: 1200px; margin: 0 auto 2rem; }
    .panel { background: white; border-radius: 0.9rem; padding: 0.9rem 1rem; margin-bottom: 0.9rem; box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; gap: 0.75rem; }
    .panel-title { font-size: 0.95rem; font-weight: 600; color: #111827; }
    .panel-subtitle { font-size: 0.75rem; color: #6b7280; }
    .panel-section-title { font-size: 0.85rem; font-weight: 700; margin: 0.8rem 0 0.35rem; }
    .text-muted { color: #9ca3af; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 0.6rem; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.6rem; }
    label { font-size: 0.78rem; display: block; margin-bottom: 0.15rem; color: #374151; }
    input, select, textarea { width: 100%; padding: 0.45rem 0.6rem; border-radius: 0.55rem; border: 1px solid #e5e7eb; font-size: 0.85rem; background: #ffffff; }
    textarea { resize: vertical; min-height: 40px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #111827; box-shadow: 0 0 0 1px #11182711; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th, td { padding: 0.4rem 0.45rem; text-align: left; border-bottom: 1px solid #f3f4f6; white-space: nowrap; }
    th { font-size: 0.72rem; font-weight: 700; color: #6b7280; background: #f9fafb; }
    tr:nth-child(even) td { background: #f9fafb; }
    .pill { display: inline-flex; align-items: center; padding: 0.08rem 0.55rem; border-radius: 999px; font-size: 0.72rem; }
    .pill-status { background: #e5e7eb; color: #111827; }
    .pill-status.pending { background: #fef3c7; color: #92400e; }
    .pill-status.delivered { background: #dcfce7; color: #166534; }
    .pill-open { background: #fef3c7; color: #92400e; }
    .pill-done { background: #dcfce7; color: #166534; }
    .table-wrapper { width: 100%; overflow-x: auto; margin-top: 0.4rem; }
    .danger { color: #b91c1c; font-weight: 700; }
    /* Login card */
    #loginView { max-width: 640px; margin: 2.5rem auto; padding: 0 1rem; }
    .card { background: white; border-radius: 1rem; padding: 1.2rem 1.5rem; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08); }
    .card h2 { margin: 0 0 0.5rem; font-size: 1.2rem; }
    .mt-xs { margin-top: 0.35rem; }
    .mt-sm { margin-top: 0.6rem; }
    .mt-md { margin-top: 0.9rem; }
    .mt-lg { margin-top: 1.2rem; }
    .error-text { margin-top: 0.4rem; font-size: 0.85rem; color: #b91c1c; }
    .summary-row { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 0.6rem; }
    .summary-card { flex: 1 1 160px; background: #f9fafb; border-radius: 0.7rem; padding: 0.6rem 0.8rem; font-size: 0.85rem; }
    .summary-label { font-size: 0.72rem; color: #6b7280; }
    .summary-value { font-size: 0.95rem; font-weight: 800; margin-top: 0.2rem; }

    .toolbar { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:flex-end; }
    .toolbar > div { min-width: 220px; flex: 1 1 220px; }

    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
      main { padding: 0.7rem; }
      .panel { padding: 0.75rem 0.85rem; }
      .grid, .grid-2 { grid-template-columns: minmax(0, 1fr); }
      table { font-size: 0.76rem; }
      th, td { padding: 0.3rem 0.35rem; }
      .btn { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; }
      .btn-sm { width: auto; padding: 0.5rem 0.8rem; font-size: 0.85rem; }
      .toolbar > div { min-width: 100%; }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1 data-i18n="app_title">Storage Manage Method</h1>
    <small data-i18n="app_subtitle">Branch → Storage orders, drivers & analytics</small>
  </div>
  <div class="header-right">
    <span id="headerUserName" class="badge" style="display:none;"></span>
    <span id="headerRole" class="badge" style="display:none;"></span>

    <button id="langBtn" class="btn btn-secondary btn-sm">AR</button>
    <button id="logoutBtn" class="btn btn-secondary btn-sm" style="display:none;" data-i18n="logout">Logout</button>
  </div>
</header>

<!-- LOGIN VIEW -->
<section id="loginView">
  <div class="card">
    <h2 data-i18n="signin_title">Sign in</h2>

    <div class="mt-md grid-2">
      <div>
        <label data-i18n="username">Username</label>
        <input id="loginNameInput" />
      </div>
      <div>
        <label data-i18n="password">Password</label>
        <input id="loginPasswordInput" type="password" />
      </div>
    </div>

    <button id="loginBtn" class="btn btn-primary mt-md" style="width: 100%;" data-i18n="signin_btn">Sign in</button>
    <div id="loginError" class="error-text" style="display:none;"></div>
  </div>
</section>

<!-- APP VIEW -->
<main id="appView" style="display:none;">

  <!-- Inventory panel (Admin & Manager) -->
  <section id="inventoryPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="inventory_title">Inventory</div>
        <div class="panel-subtitle" data-i18n="inventory_subtitle">Admin & Manager can add items and manage inventory. Viewer lets you choose any branch list.</div>
      </div>
    </div>

    <!-- Viewer branch select -->
    <div class="panel-section-title" data-i18n="view_inventory_list">View inventory list</div>
    <div class="toolbar">
      <div>
        <label data-i18n="select_list">Select list</label>
        <select id="inventoryViewBranchSelect"></select>
      </div>
      <div>
        <button id="inventoryRefreshBtn" class="btn btn-secondary" data-i18n="refresh">Refresh</button>
      </div>
    </div>

    <div class="table-wrapper mt-sm">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_name">Name</th>
          <th data-i18n="th_branch">Branch</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_min">Min</th>
          <th data-i18n="th_unit_cost">Unit cost</th>
          <th data-i18n="th_value">Value</th>
        </tr>
        </thead>
        <tbody id="itemsTableBody"></tbody>
      </table>
    </div>

    <div class="summary-row mt-sm">
      <div class="summary-card">
        <div class="summary-label" data-i18n="selected_list_value">Selected list value (KWD)</div>
        <div id="selectedListValue" class="summary-value">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label" data-i18n="main_storage_value">Main Storage value (KWD)</div>
        <div id="storageTotalValue" class="summary-value">0</div>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="restock_alerts">Restock alerts (Main Storage)</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_item">Item</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_min">Min</th>
        </tr>
        </thead>
        <tbody id="alertsTableBody"></tbody>
      </table>
    </div>

    <!-- Add/update items -->
    <div class="panel-section-title mt-md" data-i18n="add_update_items">Add / update items (Admin & Manager)</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="item_id_auto">Item ID (auto)</label>
        <input id="itemIdInput" placeholder="ITM-001" readonly />
      </div>
      <div>
        <label data-i18n="th_name">Name</label>
        <input id="itemNameInput" />
      </div>
      <div>
        <label data-i18n="item_branch_where">Branch (where item lives)</label>
        <select id="itemBranchSelect"></select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="base_quantity">Base quantity</label>
        <input id="itemBaseQtyInput" type="number" min="0" value="0" />
      </div>
      <div>
        <label data-i18n="minimum_quantity">Minimum quantity (alert)</label>
        <input id="itemMinQtyInput" type="number" min="0" value="0" />
      </div>
      <div>
        <label data-i18n="th_unit_cost">Unit cost</label>
        <input id="itemUnitCostInput" type="number" min="0" step="0.001" value="0" />
      </div>
    </div>
    <button id="addItemBtn" class="btn btn-primary mt-sm" data-i18n="save_item">Save item</button>
  </section>

  <!-- Users (Admin) -->
  <section id="usersPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="users_branches">Users & branches</div>
        <div class="panel-subtitle" data-i18n="users_subtitle">Admin can create, edit and delete users and assign them to branches.</div>
      </div>
    </div>

    <div class="panel-section-title" data-i18n="create_user">Create user</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="username">Username</label>
        <input id="newUserName" />
      </div>
      <div>
        <label data-i18n="password">Password</label>
        <input id="newUserPassword" />
      </div>
      <div>
        <label data-i18n="role">Role</label>
        <select id="newUserRole">
          <option value="staff">Staff</option>
          <option value="manager">Manager</option>
          <option value="driver">Driver</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_branch">Branch</label>
        <select id="newUserBranchSelect"></select>
      </div>
      <div></div>
      <div style="display:flex;align-items:flex-end;">
        <button id="addUserBtn" class="btn btn-primary" style="width:100%;" data-i18n="create_user_btn">Create user</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="users_list">Users list</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr><th data-i18n="th_name">Name</th><th data-i18n="role">Role</th><th data-i18n="th_branch">Branch</th></tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </div>

    <div class="panel-section-title mt-md" data-i18n="edit_delete_user">Edit / delete user</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="select_user">Select user</label>
        <select id="editUserSelect"></select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_name">Name</label>
        <input id="editUserName" />
      </div>
      <div>
        <label data-i18n="password_keep">Password (leave empty to keep)</label>
        <input id="editUserPassword" type="password" />
      </div>
      <div>
        <label data-i18n="role">Role</label>
        <select id="editUserRole">
          <option value="staff">Staff</option>
          <option value="manager">Manager</option>
          <option value="driver">Driver</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_branch">Branch</label>
        <select id="editUserBranchSelect"></select>
      </div>
      <div style="display:flex;align-items:flex-end;gap:0.4rem;">
        <button id="saveUserChangesBtn" class="btn btn-primary" style="flex:1;" data-i18n="save_changes">Save changes</button>
        <button id="deleteUserBtn" class="btn btn-secondary" style="flex:1;" data-i18n="delete_user">Delete user</button>
      </div>
    </div>
  </section>

  <!-- Requests (staff/manager/admin) -->
  <section id="requestsPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="branch_requests">Branch requests</div>
        <div class="panel-subtitle" data-i18n="requests_subtitle">Staff / Manager / Admin request items from Main Storage to their own branch.</div>
      </div>
    </div>

    <div class="panel-section-title" data-i18n="new_request">New request</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="from_storage">From storage</label>
        <div id="requestFromBranchLabel" class="text-muted" style="font-size:0.85rem;"></div>
      </div>
      <div>
        <label data-i18n="to_branch">To branch</label>
        <div id="requestToBranchLabel" class="text-muted" style="font-size:0.85rem;"></div>
      </div>
      <div>
        <label data-i18n="item_from_storage">Item (from storage)</label>
        <select id="requestItemSelect"></select>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label data-i18n="quantity">Quantity</label>
        <input id="requestQtyInput" type="number" min="1" value="1" />
      </div>
      <div>
        <label data-i18n="note">Note</label>
        <input id="requestNoteInput" />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="createRequestBtn" class="btn btn-primary" style="width:100%;" data-i18n="create_request">Create request</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="requests_for_my_branch">Requests for my branch</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_item">Item</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_from">From</th>
          <th data-i18n="th_to">To</th>
          <th data-i18n="th_status">Status</th>
          <th data-i18n="th_by">By</th>
          <th data-i18n="th_driver">Driver</th>
        </tr>
        </thead>
        <tbody id="requestsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Driver panel -->
  <section id="driverPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="driver_deliveries">Driver deliveries</div>
        <div class="panel-subtitle" data-i18n="driver_subtitle">Drivers see all pending requests and mark them as delivered.</div>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_item">Item</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_from">From</th>
          <th data-i18n="th_to">To</th>
          <th data-i18n="th_requested_by">Requested by</th>
          <th data-i18n="th_status">Status</th>
          <th data-i18n="th_action">Action</th>
        </tr>
        </thead>
        <tbody id="driverRequestsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Movements (Admin & Manager) -->
  <section id="movementsPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="manual_movements">Manual stock movements</div>
        <div class="panel-subtitle" data-i18n="movements_subtitle">Only Admin & Manager can record IN / OUT movements that change stock.</div>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_item">Item</label>
        <select id="movementItemSelect"></select>
      </div>
      <div>
        <label data-i18n="type">Type</label>
        <select id="movementTypeSelect">
          <option value="IN">IN (add)</option>
          <option value="OUT">OUT (remove)</option>
        </select>
      </div>
      <div>
        <label data-i18n="quantity">Quantity</label>
        <input id="movementQtyInput" type="number" min="1" value="1" />
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="note">Note</label>
        <input id="movementNoteInput" />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="addMovementBtn" class="btn btn-primary" style="width:100%;" data-i18n="save_movement">Save movement</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="recent_movements">Recent movements</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_item">Item</th>
          <th data-i18n="type">Type</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_branch">Branch</th>
          <th data-i18n="th_user">User</th>
          <th data-i18n="th_time">Time</th>
        </tr>
        </thead>
        <tbody id="movementsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Analytics (budget/usage, Admin & Manager) -->
  <section id="analyticsPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="analytics_title">Budget & usage dashboard</div>
        <div class="panel-subtitle" data-i18n="analytics_subtitle">Automatic spend calculation from delivered requests (qty × item price), filter by date and branch.</div>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_branch">Branch</label>
        <select id="analyticsBranchSelect">
          <option value="ALL">All branches</option>
        </select>
      </div>
      <div>
        <label data-i18n="from_date">From date</label>
        <input id="analyticsFromDate" type="date" />
      </div>
      <div>
        <label data-i18n="to_date">To date</label>
        <input id="analyticsToDate" type="date" />
      </div>
    </div>
    <button id="analyticsApplyBtn" class="btn btn-primary mt-sm" data-i18n="apply_filters">Apply filters</button>

    <div class="summary-row mt-sm">
      <div class="summary-card">
        <div class="summary-label" data-i18n="total_spent">Total spent (KWD)</div>
        <div id="analyticsTotalCost" class="summary-value">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label" data-i18n="delivered_requests">Delivered requests</div>
        <div id="analyticsTotalRequests" class="summary-value">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label" data-i18n="total_quantity">Total quantity</div>
        <div id="analyticsTotalQty" class="summary-value">0</div>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="most_ordered">Most ordered items (by cost)</div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th data-i18n="th_item">Item</th>
            <th data-i18n="th_total_qty">Total qty</th>
            <th data-i18n="th_total_cost">Total cost</th>
          </tr>
        </thead>
        <tbody id="analyticsItemsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Vehicle reminders (Admin/Manager/Driver) -->
  <section id="vehiclePanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="vehicle_reminders">Vehicle reminders</div>
        <div class="panel-subtitle" data-i18n="vehicle_subtitle">Oil change, meter, yearly renewal. Admin/Manager can add; Driver can mark done.</div>
      </div>
    </div>

    <div id="vehicleCreateBlock" style="display:none;">
      <div class="panel-section-title" data-i18n="add_vehicle">Add vehicle (Admin/Manager)</div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="vehicle_name">Vehicle name</label>
          <input id="vehNameInput" placeholder="Delivery Car 1" />
        </div>
        <div>
          <label data-i18n="plate_optional">Plate (optional)</label>
          <input id="vehPlateInput" placeholder="KUWAIT-12345" />
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button id="addVehicleBtn" class="btn btn-primary" style="width:100%;" data-i18n="add_vehicle_btn">Add vehicle</button>
        </div>
      </div>

      <div class="panel-section-title mt-md" data-i18n="add_reminder">Add reminder (Admin/Manager)</div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="vehicle">Vehicle</label>
          <select id="remVehicleSelect"></select>
        </div>
        <div>
          <label data-i18n="type">Type</label>
          <select id="remTypeSelect">
            <option value="OIL_CHANGE">Oil change</option>
            <option value="METER">Meter</option>
            <option value="YEARLY_RENEW">Yearly renewal</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        <div>
          <label data-i18n="due_date">Due date</label>
          <input id="remDueDateInput" type="date" />
        </div>
      </div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="due_odometer">Due odometer (km)</label>
          <input id="remDueOdoInput" type="number" min="0" placeholder="e.g. 50000" />
        </div>
        <div>
          <label data-i18n="note">Note</label>
          <input id="remNoteInput" placeholder="Change oil filter too..." />
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button id="addReminderBtn" class="btn btn-primary" style="width:100%;" data-i18n="add_reminder_btn">Add reminder</button>
        </div>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="reminders">Reminders</div>
    <div class="toolbar">
      <div>
        <label data-i18n="filter">Filter</label>
        <select id="remFilterSelect">
          <option value="open">Open</option>
          <option value="all">All</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div>
        <label data-i18n="vehicle">Vehicle</label>
        <select id="remVehicleFilterSelect"></select>
      </div>
      <div>
        <button id="remRefreshBtn" class="btn btn-secondary" data-i18n="refresh">Refresh</button>
      </div>
    </div>

    <div class="table-wrapper mt-sm">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_status">Status</th>
          <th data-i18n="vehicle">Vehicle</th>
          <th data-i18n="type">Type</th>
          <th data-i18n="due">Due</th>
          <th data-i18n="odometer">Odometer</th>
          <th data-i18n="note">Note</th>
          <th data-i18n="th_action">Action</th>
        </tr>
        </thead>
        <tbody id="remindersTableBody"></tbody>
      </table>
    </div>
  </section>

</main>

<script>
  const API_BASE = "/api";

  // ---------- i18n ----------
  const i18n = {
    en: {
      app_title: "Storage Manage Method",
      app_subtitle: "Branch → Storage orders, drivers & analytics",
      logout: "Logout",
      signin_title: "Sign in",
      signin_btn: "Sign in",
      username: "Username",
      password: "Password",

      inventory_title: "Inventory",
      inventory_subtitle: "Admin & Manager can add items and manage inventory. Viewer lets you choose any branch list.",
      view_inventory_list: "View inventory list",
      select_list: "Select list",
      refresh: "Refresh",

      th_id: "ID",
      th_name: "Name",
      th_branch: "Branch",
      th_qty: "Qty",
      th_min: "Min",
      th_unit_cost: "Unit cost",
      th_value: "Value",
      th_item: "Item",
      th_from: "From",
      th_to: "To",
      th_status: "Status",
      th_by: "By",
      th_driver: "Driver",
      th_action: "Action",
      th_user: "User",
      th_time: "Time",
      th_requested_by: "Requested by",
      th_total_qty: "Total qty",
      th_total_cost: "Total cost",

      selected_list_value: "Selected list value (KWD)",
      main_storage_value: "Main Storage value (KWD)",
      restock_alerts: "Restock alerts (Main Storage)",
      add_update_items: "Add / update items (Admin & Manager)",
      item_id_auto: "Item ID (auto)",
      item_branch_where: "Branch (where item lives)",
      base_quantity: "Base quantity",
      minimum_quantity: "Minimum quantity (alert)",
      save_item: "Save item",

      users_branches: "Users & branches",
      users_subtitle: "Admin can create, edit and delete users and assign them to branches.",
      create_user: "Create user",
      role: "Role",
      create_user_btn: "Create user",
      users_list: "Users list",
      edit_delete_user: "Edit / delete user",
      select_user: "Select user",
      password_keep: "Password (leave empty to keep)",
      save_changes: "Save changes",
      delete_user: "Delete user",

      branch_requests: "Branch requests",
      requests_subtitle: "Staff / Manager / Admin request items from Main Storage to their own branch.",
      new_request: "New request",
      from_storage: "From storage",
      to_branch: "To branch",
      item_from_storage: "Item (from storage)",
      quantity: "Quantity",
      note: "Note",
      create_request: "Create request",
      requests_for_my_branch: "Requests for my branch",

      driver_deliveries: "Driver deliveries",
      driver_subtitle: "Drivers see all pending requests and mark them as delivered.",

      manual_movements: "Manual stock movements",
      movements_subtitle: "Only Admin & Manager can record IN / OUT movements that change stock.",
      type: "Type",
      save_movement: "Save movement",
      recent_movements: "Recent movements",

      analytics_title: "Budget & usage dashboard",
      analytics_subtitle: "Automatic spend calculation from delivered requests (qty × item price), filter by date and branch.",
      from_date: "From date",
      to_date: "To date",
      apply_filters: "Apply filters",
      total_spent: "Total spent (KWD)",
      delivered_requests: "Delivered requests",
      total_quantity: "Total quantity",
      most_ordered: "Most ordered items (by cost)",

      vehicle_reminders: "Vehicle reminders",
      vehicle_subtitle: "Oil change, meter, yearly renewal. Admin/Manager can add; Driver can mark done.",
      add_vehicle: "Add vehicle (Admin/Manager)",
      vehicle_name: "Vehicle name",
      plate_optional: "Plate (optional)",
      add_vehicle_btn: "Add vehicle",
      add_reminder: "Add reminder (Admin/Manager)",
      vehicle: "Vehicle",
      due_date: "Due date",
      due_odometer: "Due odometer (km)",
      add_reminder_btn: "Add reminder",
      reminders: "Reminders",
      filter: "Filter",
      due: "Due",
      odometer: "Odometer",

      main_storage: "Main Storage",
      no_items_in: "No items in",
      no_low_stock: "No low stock alerts in Main Storage.",

      // statuses / actions
      pending: "pending",
      delivered: "delivered",
      deliver: "Deliver",

      // alerts / validations (JS)
      enter_user_pass: "Enter username and password.",
      login_failed: "Login failed",
      load_state_failed: "Load state failed",
      next_item_failed: "Failed to get next item id",

      only_admin_create_users: "Only admin can create users.",
      name_password_required: "Name and password required.",
      select_user_first: "Select a user first.",
      delete_user_confirm: "Delete this user?",
      user_updated: "User updated.",
      user_deleted: "User deleted.",

      only_admin_mgr_create_items: "Only admin/manager can create items.",
      item_name_required: "Item name required.",

      only_admin_mgr_movements: "Only admin/manager can record movements.",
      item_qty_required: "Item and quantity required.",

      drivers_cannot_create: "Drivers cannot create requests.",
      user_no_branch: "Your user is not assigned to a branch. Ask admin.",

      mark_delivered_confirm: "Mark this request as delivered?",
      no_requests_yet: "No requests yet.",
      no_pending_requests: "No pending requests.",

      no_movements: "No movements recorded.",
      no_delivered_period: "No delivered requests in this period.",

      vehicle_name_required_msg: "Vehicle name required",
      select_vehicle_msg: "Select a vehicle",
      no_reminders: "No reminders.",

      reopen: "Re-open",
      done: "Done",
      delete_reminder: "Delete",
      delete_reminder_confirm: "Delete this reminder?"
    },
    ar: {
      app_title: "إدارة المخزون",
      app_subtitle: "الفروع → طلبات المخزن، السائقين والتحليلات",
      logout: "تسجيل خروج",
      signin_title: "تسجيل الدخول",
      signin_btn: "دخول",
      username: "اسم المستخدم",
      password: "كلمة المرور",

      inventory_title: "المخزون",
      inventory_subtitle: "المدير والمشرف يمكنهم إضافة الأصناف وإدارة المخزون. العرض يسمح باختيار أي قائمة فرع.",
      view_inventory_list: "عرض قائمة المخزون",
      select_list: "اختر القائمة",
      refresh: "تحديث",

      th_id: "الرقم",
      th_name: "الاسم",
      th_branch: "الفرع",
      th_qty: "الكمية",
      th_min: "الحد الأدنى",
      th_unit_cost: "سعر الوحدة",
      th_value: "القيمة",
      th_item: "الصنف",
      th_from: "من",
      th_to: "إلى",
      th_status: "الحالة",
      th_by: "بواسطة",
      th_driver: "السائق",
      th_action: "إجراء",
      th_user: "المستخدم",
      th_time: "الوقت",
      th_requested_by: "طالب الطلب",
      th_total_qty: "إجمالي الكمية",
      th_total_cost: "إجمالي التكلفة",

      selected_list_value: "قيمة القائمة المختارة (د.ك)",
      main_storage_value: "قيمة المخزن الرئيسي (د.ك)",
      restock_alerts: "تنبيهات إعادة التوريد (المخزن الرئيسي)",
      add_update_items: "إضافة / تعديل الأصناف (مدير/مشرف)",
      item_id_auto: "رقم الصنف (تلقائي)",
      item_branch_where: "الفرع (مكان الصنف)",
      base_quantity: "الكمية الأساسية",
      minimum_quantity: "الحد الأدنى (تنبيه)",
      save_item: "حفظ الصنف",

      users_branches: "المستخدمون والفروع",
      users_subtitle: "المشرف يمكنه إنشاء وتعديل وحذف المستخدمين وربطهم بالفروع.",
      create_user: "إنشاء مستخدم",
      role: "الدور",
      create_user_btn: "إنشاء مستخدم",
      users_list: "قائمة المستخدمين",
      edit_delete_user: "تعديل / حذف مستخدم",
      select_user: "اختر مستخدم",
      password_keep: "كلمة المرور (اتركها فارغة للإبقاء)",
      save_changes: "حفظ التعديل",
      delete_user: "حذف المستخدم",

      branch_requests: "طلبات الفروع",
      requests_subtitle: "الموظف/المدير/المشرف يطلبون أصناف من المخزن الرئيسي إلى فرعهم.",
      new_request: "طلب جديد",
      from_storage: "من المخزن",
      to_branch: "إلى الفرع",
      item_from_storage: "الصنف (من المخزن)",
      quantity: "الكمية",
      note: "ملاحظة",
      create_request: "إنشاء طلب",
      requests_for_my_branch: "طلبات فرعي",

      driver_deliveries: "تسليمات السائق",
      driver_subtitle: "السائق يرى الطلبات المعلّقة ويؤكد التسليم.",

      manual_movements: "حركات مخزون يدوية",
      movements_subtitle: "فقط المشرف/المدير يمكنهم تسجيل إدخال/إخراج يؤثر على المخزون.",
      type: "النوع",
      save_movement: "حفظ الحركة",
      recent_movements: "آخر الحركات",

      analytics_title: "لوحة الميزانية والاستخدام",
      analytics_subtitle: "حساب الصرف تلقائيًا من الطلبات المسلّمة (الكمية × السعر)، مع فلترة بالتاريخ والفرع.",
      from_date: "من تاريخ",
      to_date: "إلى تاريخ",
      apply_filters: "تطبيق الفلاتر",
      total_spent: "إجمالي الصرف (د.ك)",
      delivered_requests: "الطلبات المسلّمة",
      total_quantity: "إجمالي الكمية",
      most_ordered: "الأكثر طلبًا (حسب التكلفة)",

      vehicle_reminders: "تنبيهات المركبات",
      vehicle_subtitle: "تغيير زيت، عداد، تجديد سنوي. المدير/المشرف يضيفون؛ السائق يعلّم منجز.",
      add_vehicle: "إضافة مركبة (مدير/مشرف)",
      vehicle_name: "اسم المركبة",
      plate_optional: "اللوحة (اختياري)",
      add_vehicle_btn: "إضافة مركبة",
      add_reminder: "إضافة تذكير (مدير/مشرف)",
      vehicle: "المركبة",
      due_date: "تاريخ الاستحقاق",
      due_odometer: "عداد الاستحقاق (كم)",
      add_reminder_btn: "إضافة تذكير",
      reminders: "التذكيرات",
      filter: "فلتر",
      due: "الاستحقاق",
      odometer: "العداد",

      main_storage: "المخزن الرئيسي",
      no_items_in: "لا توجد أصناف في",
      no_low_stock: "لا توجد تنبيهات نقص في المخزن الرئيسي.",

      pending: "قيد الانتظار",
      delivered: "تم التسليم",
      deliver: "تسليم",

      enter_user_pass: "اكتب اسم المستخدم وكلمة المرور.",
      login_failed: "فشل تسجيل الدخول",
      load_state_failed: "فشل تحميل البيانات",
      next_item_failed: "فشل جلب رقم الصنف التالي",

      only_admin_create_users: "فقط المشرف يمكنه إنشاء مستخدمين.",
      name_password_required: "الاسم وكلمة المرور مطلوبة.",
      select_user_first: "اختر مستخدم أولاً.",
      delete_user_confirm: "حذف هذا المستخدم؟",
      user_updated: "تم تحديث المستخدم.",
      user_deleted: "تم حذف المستخدم.",

      only_admin_mgr_create_items: "فقط المشرف/المدير يمكنهم إضافة أصناف.",
      item_name_required: "اسم الصنف مطلوب.",

      only_admin_mgr_movements: "فقط المشرف/المدير يمكنهم تسجيل الحركات.",
      item_qty_required: "الصنف والكمية مطلوبة.",

      drivers_cannot_create: "السائق لا يستطيع إنشاء طلب.",
      user_no_branch: "المستخدم غير مرتبط بفرع. اطلب من المشرف.",

      mark_delivered_confirm: "تأكيد تسليم هذا الطلب؟",
      no_requests_yet: "لا توجد طلبات بعد.",
      no_pending_requests: "لا توجد طلبات معلّقة.",

      no_movements: "لا توجد حركات مسجلة.",
      no_delivered_period: "لا توجد طلبات مسلّمة في هذه الفترة.",

      vehicle_name_required_msg: "اسم المركبة مطلوب",
      select_vehicle_msg: "اختر مركبة",
      no_reminders: "لا توجد تذكيرات.",

      reopen: "إعادة فتح",
      done: "تم",
      delete_reminder: "حذف",
      delete_reminder_confirm: "حذف هذا التذكير؟"
    }
  };

  let currentLang = localStorage.getItem("lang") || "en";

  function t(key) {
    return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key;
  }

  function applyTranslations() {
    document.documentElement.lang = currentLang;
    document.documentElement.dir = (currentLang === "ar") ? "rtl" : "ltr";

    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });

    // keep role options translated visually (optional)
    const roleOptions = [
      { value: "staff", en: "Staff", ar: "موظف" },
      { value: "manager", en: "Manager", ar: "مدير" },
      { value: "driver", en: "Driver", ar: "سائق" },
      { value: "admin", en: "Admin", ar: "مشرف" }
    ];
    const roleSelects = [document.getElementById("newUserRole"), document.getElementById("editUserRole")].filter(Boolean);
    roleSelects.forEach(sel => {
      Array.from(sel.options).forEach(opt => {
        const ro = roleOptions.find(r => r.value === opt.value);
        if (ro) opt.textContent = (currentLang === "ar") ? ro.ar : ro.en;
      });
    });

    // movement type options (optional)
    const movementTypeSelect = document.getElementById("movementTypeSelect");
    if (movementTypeSelect) {
      const inOpt = movementTypeSelect.querySelector('option[value="IN"]');
      const outOpt = movementTypeSelect.querySelector('option[value="OUT"]');
      if (inOpt) inOpt.textContent = (currentLang === "ar") ? "إدخال (زيادة)" : "IN (add)";
      if (outOpt) outOpt.textContent = (currentLang === "ar") ? "إخراج (نقص)" : "OUT (remove)";
    }

    // reminders filters (optional)
    const remFilterSelect = document.getElementById("remFilterSelect");
    if (remFilterSelect) {
      const openOpt = remFilterSelect.querySelector('option[value="open"]');
      const allOpt = remFilterSelect.querySelector('option[value="all"]');
      const doneOpt = remFilterSelect.querySelector('option[value="done"]');
      if (openOpt) openOpt.textContent = (currentLang === "ar") ? "مفتوح" : "Open";
      if (allOpt) allOpt.textContent = (currentLang === "ar") ? "الكل" : "All";
      if (doneOpt) doneOpt.textContent = (currentLang === "ar") ? "منجز" : "Done";
    }

    const remTypeSelect = document.getElementById("remTypeSelect");
    if (remTypeSelect) {
      const oil = remTypeSelect.querySelector('option[value="OIL_CHANGE"]');
      const meter = remTypeSelect.querySelector('option[value="METER"]');
      const yearly = remTypeSelect.querySelector('option[value="YEARLY_RENEW"]');
      const other = remTypeSelect.querySelector('option[value="OTHER"]');
      if (oil) oil.textContent = (currentLang === "ar") ? "تغيير زيت" : "Oil change";
      if (meter) meter.textContent = (currentLang === "ar") ? "عداد" : "Meter";
      if (yearly) yearly.textContent = (currentLang === "ar") ? "تجديد سنوي" : "Yearly renewal";
      if (other) other.textContent = (currentLang === "ar") ? "أخرى" : "Other";
    }

    const langBtn = document.getElementById("langBtn");
    if (langBtn) langBtn.textContent = (currentLang === "ar") ? "EN" : "AR";
  }
  // ---------- end i18n ----------

  const state = {
    user: null,
    branches: [],
    users: [],
    items: [],
    movements: [],
    budgets: [],
    requests: [],
    vehicles: [],
    vehicleReminders: []
  };

  // ----- Helpers -----
  function escapeHtml(s) {
    return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function getBranchName(id) {
    const b = state.branches.find((x) => x.id === id);
    return b ? b.name : id || "";
  }
  function getUserName(id) {
    const u = state.users.find((x) => x.id === id);
    return u ? u.name : id || "";
  }
  function getItemById(id) {
    return state.items.find((x) => x.id === id);
  }
  function formatDateTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }
  function getMainStorageId() {
    const byId = state.branches.find((b) => b.id === "B001");
    if (byId) return byId.id;
    const byName = state.branches.find((b) => (b.name || "").toLowerCase().includes("main"));
    if (byName) return byName.id;
    return state.branches[0] ? state.branches[0].id : null;
  }

  function typeLabel(tKey) {
    if (tKey === "OIL_CHANGE") return (currentLang === "ar") ? "تغيير زيت" : "Oil change";
    if (tKey === "METER") return (currentLang === "ar") ? "عداد" : "Meter";
    if (tKey === "YEARLY_RENEW") return (currentLang === "ar") ? "تجديد سنوي" : "Yearly renewal";
    return (currentLang === "ar") ? "أخرى" : "Other";
  }
  function vehicleNameById(id) {
    const v = (state.vehicles || []).find(x => x.id === id);
    if (!v) return id;
    return v.plate ? `${v.name} (${v.plate})` : v.name;
  }

  // ----- API calls -----
  async function apiLogin(name, password) {
    const res = await fetch(`${API_BASE}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, password })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || t("login_failed"));
    return body;
  }

  async function apiLoadState() {
    const res = await fetch(`${API_BASE}/state`);
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || t("load_state_failed"));
    return body;
  }

  async function apiNextItemId() {
    const res = await fetch(`${API_BASE}/next-item-id`);
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || t("next_item_failed"));
    return body.nextId;
  }

  async function apiCreateUser(name, role, password, branchId) {
    const res = await fetch(`${API_BASE}/users`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, role, password, branchId, adminUserId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create user failed");
    return body;
  }

  async function apiUpdateUser(userId, updates) {
    const res = await fetch(`${API_BASE}/users/${userId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ adminUserId: state.user.id, ...updates })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Update user failed");
    return body;
  }

  async function apiDeleteUser(userId) {
    const res = await fetch(`${API_BASE}/users/${userId}`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ adminUserId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Delete user failed");
    return body;
  }

  async function apiCreateItem(data) {
    const res = await fetch(`${API_BASE}/items`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create item failed");
    return body;
  }

  async function apiCreateMovement(itemId, type, qty, note) {
    const res = await fetch(`${API_BASE}/movements`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ itemId, type, qty, note, userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Movement failed");
    return body;
  }

  async function apiCreateRequest(itemId, qty, note) {
    const res = await fetch(`${API_BASE}/requests`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ itemId, qty, note, userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Request failed");
    return body;
  }

  async function apiDeliverRequest(id) {
    const res = await fetch(`${API_BASE}/requests/${id}/deliver`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ driverUserId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Deliver failed");
    return body;
  }

  async function apiCreateVehicle(name, plate) {
    const res = await fetch(`${API_BASE}/vehicles`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, name, plate })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create vehicle failed");
    return body;
  }

  async function apiCreateReminder(data) {
    const res = await fetch(`${API_BASE}/vehicle-reminders`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, ...data })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create reminder failed");
    return body;
  }

  async function apiUpdateReminder(id, patch) {
    const res = await fetch(`${API_BASE}/vehicle-reminders/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, ...patch })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Update reminder failed");
    return body;
  }

  async function apiDeleteReminder(id) {
    const res = await fetch(`${API_BASE}/vehicle-reminders/${id}`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Delete reminder failed");
    return body;
  }

  // ----- Render -----
  function renderHeader() {
    const headerUser = document.getElementById("headerUserName");
    const headerRole = document.getElementById("headerRole");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!state.user) {
      headerUser.style.display = "none";
      headerRole.style.display = "none";
      logoutBtn.style.display = "none";
      return;
    }

    headerUser.textContent = state.user.name;
    headerUser.style.display = "inline-flex";

    const branchText = state.user.branchId ? ` | ${currentLang === "ar" ? "الفرع" : "Branch"}: ${getBranchName(state.user.branchId)}` : "";
    headerRole.textContent = `${currentLang === "ar" ? "الدور" : "Role"}: ${state.user.role}${branchText}`;
    headerRole.style.display = "inline-flex";

    logoutBtn.style.display = "inline-flex";
  }

  function renderBranchSelects() {
    const selects = [
      document.getElementById("itemBranchSelect"),
      document.getElementById("newUserBranchSelect"),
      document.getElementById("editUserBranchSelect")
    ];

    selects.forEach((sel) => {
      if (!sel) return;
      sel.innerHTML = "";
      state.branches.forEach((b, idx) => {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.name;
        if (idx === 0) opt.selected = true;
        sel.appendChild(opt);
      });
    });

    // inventory viewer select
    const invSel = document.getElementById("inventoryViewBranchSelect");
    if (invSel) {
      invSel.innerHTML = "";
      const mainId = getMainStorageId();
      state.branches.forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.id === mainId ? `${b.name} (${t("main_storage")})` : b.name;
        invSel.appendChild(opt);
      });
      if (mainId) invSel.value = mainId;
    }

    const fromLabel = document.getElementById("requestFromBranchLabel");
    const toLabel = document.getElementById("requestToBranchLabel");
    if (fromLabel) fromLabel.textContent = getBranchName(getMainStorageId());
    if (toLabel && state.user && state.user.branchId) toLabel.textContent = getBranchName(state.user.branchId);

    // Analytics branch select
    const analyticsBranchSelect = document.getElementById("analyticsBranchSelect");
    if (analyticsBranchSelect) {
      analyticsBranchSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = (currentLang === "ar") ? "كل الفروع" : "All branches";
      analyticsBranchSelect.appendChild(allOpt);
      state.branches.forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.name;
        analyticsBranchSelect.appendChild(opt);
      });
    }
  }

  function renderInventoryViewer() {
    const tbody = document.getElementById("itemsTableBody");
    const alertsBody = document.getElementById("alertsTableBody");
    const storageTotalEl = document.getElementById("storageTotalValue");
    const selectedValueEl = document.getElementById("selectedListValue");
    const invSel = document.getElementById("inventoryViewBranchSelect");

    tbody.innerHTML = "";
    if (alertsBody) alertsBody.innerHTML = "";

    const mainId = getMainStorageId();
    const selectedBranchId = invSel ? invSel.value : mainId;

    const itemsSelected = (state.items || []).filter(it => it.branchId === selectedBranchId);
    const itemsMain = (state.items || []).filter(it => it.branchId === mainId);

    const selectedTotal = itemsSelected.reduce((sum, it) => sum + (Number(it.baseQty)||0)*(Number(it.unitCost)||0), 0);
    const storageTotal = itemsMain.reduce((sum, it) => sum + (Number(it.baseQty)||0)*(Number(it.unitCost)||0), 0);

    if (selectedValueEl) selectedValueEl.textContent = selectedTotal.toFixed(3);
    if (storageTotalEl) storageTotalEl.textContent = storageTotal.toFixed(3);

    const sorted = [...itemsSelected].sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    if (!sorted.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="text-muted">${t("no_items_in")} ${escapeHtml(getBranchName(selectedBranchId))}.</td>`;
      tbody.appendChild(tr);
    } else {
      sorted.forEach((it) => {
        const value = (Number(it.baseQty)||0) * (Number(it.unitCost)||0);
        const low = it.minQty > 0 && Number(it.baseQty||0) <= Number(it.minQty||0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(it.id)}</td>
          <td>${escapeHtml(it.name)}</td>
          <td>${escapeHtml(getBranchName(it.branchId))}</td>
          <td${low ? ' class="danger"' : ""}>${escapeHtml(it.baseQty)}</td>
          <td>${escapeHtml(it.minQty)}</td>
          <td>${escapeHtml(it.unitCost)}</td>
          <td>${value.toFixed(3)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Alerts ONLY for Main Storage
    if (alertsBody) {
      const lowItems = itemsMain.filter(it => it.minQty > 0 && Number(it.baseQty||0) <= Number(it.minQty||0));
      if (!lowItems.length) {
        const trA = document.createElement("tr");
        trA.innerHTML = `<td colspan="3" class="text-muted">${t("no_low_stock")}</td>`;
        alertsBody.appendChild(trA);
      } else {
        lowItems
          .sort((a,b)=> (Number(a.baseQty||0)-Number(b.baseQty||0)))
          .forEach((it)=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(it.name)}</td>
              <td class="danger">${escapeHtml(it.baseQty)}</td>
              <td>${escapeHtml(it.minQty)}</td>
            `;
            alertsBody.appendChild(tr);
          });
      }
    }

    const moveSelect = document.getElementById("movementItemSelect");
    if (moveSelect) {
      moveSelect.innerHTML = "";
      const all = [...state.items].sort((a,b)=>(a.name||"").localeCompare(b.name||""));
      all.forEach((it, idx) => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = `${it.name} (${getBranchName(it.branchId)})`;
        if (idx === 0) opt.selected = true;
        moveSelect.appendChild(opt);
      });
    }
  }

  function fillRequestItemsFromStorage() {
    const itemSel = document.getElementById("requestItemSelect");
    if (!itemSel) return;
    const storageId = getMainStorageId();
    itemSel.innerHTML = "";
    const items = state.items.filter((it) => it.branchId === storageId);
    items.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    items.forEach((it, idx) => {
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.name} (${t("main_storage")})`;
      if (idx === 0) opt.selected = true;
      itemSel.appendChild(opt);
    });
  }

  function renderUsersTable() {
    const tbody = document.getElementById("usersTableBody");
    tbody.innerHTML = "";
    const users = [...state.users].sort((a, b) => a.name.localeCompare(b.name));
    users.forEach((u) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.role)}</td><td>${escapeHtml(getBranchName(u.branchId))}</td>`;
      tbody.appendChild(tr);
    });

    const editSel = document.getElementById("editUserSelect");
    if (editSel) {
      editSel.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = (currentLang === "ar") ? "اختر مستخدم" : "Select user";
      editSel.appendChild(placeholder);

      users.forEach((u) => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${u.name} (${u.role})`;
        editSel.appendChild(opt);
      });
    }
  }

  function renderRequestsTable() {
    const tbody = document.getElementById("requestsTableBody");
    tbody.innerHTML = "";
    const all = [...state.requests].sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));

    const visible = (state.user.role === "driver")
      ? all
      : all.filter((r) => r.toBranchId === state.user.branchId);

    if (!visible.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="text-muted">${t("no_requests_yet")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    visible.forEach((r) => {
      const item = getItemById(r.itemId);
      const driverName = r.driverUserId ? getUserName(r.driverUserId) : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.id)}</td>
        <td>${escapeHtml(item ? item.name : r.itemId)}</td>
        <td>${escapeHtml(r.qty)}</td>
        <td>${escapeHtml(getBranchName(r.fromBranchId))}</td>
        <td>${escapeHtml(getBranchName(r.toBranchId))}</td>
        <td><span class="pill pill-status ${escapeHtml(r.status)}">${t(r.status)}</span></td>
        <td>${escapeHtml(getUserName(r.createdByUserId))}</td>
        <td>${escapeHtml(driverName)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDriverRequestsTable() {
    const tbody = document.getElementById("driverRequestsTableBody");
    tbody.innerHTML = "";
    const pending = state.requests.filter((r) => r.status === "pending");
    if (!pending.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="text-muted">${t("no_pending_requests")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    pending.forEach((r) => {
      const item = getItemById(r.itemId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(r.id)}</td>
        <td>${escapeHtml(item ? item.name : r.itemId)}</td>
        <td>${escapeHtml(r.qty)}</td>
        <td>${escapeHtml(getBranchName(r.fromBranchId))}</td>
        <td>${escapeHtml(getBranchName(r.toBranchId))}</td>
        <td>${escapeHtml(getUserName(r.createdByUserId))}</td>
        <td><span class="pill pill-status ${escapeHtml(r.status)}">${t(r.status)}</span></td>
        <td><button class="btn btn-primary btn-sm" data-req-id="${escapeHtml(r.id)}">${t("deliver")}</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderMovementsTable() {
    const tbody = document.getElementById("movementsTableBody");
    tbody.innerHTML = "";
    const moves = [...state.movements].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0, 60);

    if (!moves.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="text-muted">${t("no_movements")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    moves.forEach((m) => {
      const item = getItemById(m.itemId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(m.id)}</td>
        <td>${escapeHtml(item ? item.name : m.itemId)}</td>
        <td>${escapeHtml(m.type)}</td>
        <td>${escapeHtml(m.qty)}</td>
        <td>${escapeHtml(getBranchName(m.branchId))}</td>
        <td>${escapeHtml(getUserName(m.userId))}</td>
        <td>${escapeHtml(formatDateTime(m.createdAt))}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ----- Analytics: compute from delivered requests -----
  function computeAnalytics() {
    const branchSel = document.getElementById("analyticsBranchSelect");
    const fromInput = document.getElementById("analyticsFromDate");
    const toInput = document.getElementById("analyticsToDate");

    const branchId = branchSel ? branchSel.value : "ALL";
    const fromDate = fromInput && fromInput.value ? new Date(fromInput.value + "T00:00:00") : null;
    const toDate = toInput && toInput.value ? new Date(toInput.value + "T23:59:59") : null;

    const storageId = getMainStorageId();

    const delivered = state.requests.filter((r) => {
      if (r.status !== "delivered") return false;
      if (branchId !== "ALL" && r.toBranchId !== branchId) return false;
      if (!r.createdAt) return false;
      const d = new Date(r.createdAt);
      if (fromDate && d < fromDate) return false;
      if (toDate && d > toDate) return false;
      return true;
    });

    let totalCost = 0;
    let totalQty = 0;
    const itemStats = new Map();

    delivered.forEach((r) => {
      const storageItem = state.items.find((it) => it.id === r.itemId && it.branchId === storageId);
      const unitCost = storageItem ? Number(storageItem.unitCost || 0) : 0;
      const qty = Number(r.qty || 0);
      const cost = unitCost * qty;
      totalCost += cost;
      totalQty += qty;

      const key = r.itemId;
      let stat = itemStats.get(key);
      if (!stat) {
        stat = { name: storageItem ? storageItem.name : r.itemId, qty: 0, cost: 0 };
        itemStats.set(key, stat);
      }
      stat.qty += qty;
      stat.cost += cost;
    });

    const itemsArray = Array.from(itemStats.values()).sort((a,b)=> b.cost - a.cost);

    return { totalCost, totalQty, totalRequests: delivered.length, items: itemsArray };
  }

  function renderAnalytics() {
    const { totalCost, totalQty, totalRequests, items } = computeAnalytics();

    const totalCostEl = document.getElementById("analyticsTotalCost");
    const totalQtyEl = document.getElementById("analyticsTotalQty");
    const totalReqEl = document.getElementById("analyticsTotalRequests");
    const tbody = document.getElementById("analyticsItemsTableBody");

    if (totalCostEl) totalCostEl.textContent = totalCost.toFixed(3);
    if (totalQtyEl) totalQtyEl.textContent = totalQty;
    if (totalReqEl) totalReqEl.textContent = totalRequests;

    if (!tbody) return;
    tbody.innerHTML = "";
    if (!items.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3" class="text-muted">${t("no_delivered_period")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    items.forEach((it) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${escapeHtml(it.qty)}</td><td>${it.cost.toFixed(3)}</td>`;
      tbody.appendChild(tr);
    });
  }

  // ----- Vehicle reminders -----
  function renderVehiclesUI() {
    const isAdmin = state.user.role === "admin";
    const isManager = state.user.role === "manager";
    const isDriver = state.user.role === "driver";

    const panel = document.getElementById("vehiclePanel");
    const createBlock = document.getElementById("vehicleCreateBlock");

    if (panel) panel.style.display = (isAdmin || isManager || isDriver) ? "block" : "none";
    if (createBlock) createBlock.style.display = (isAdmin || isManager) ? "block" : "none";

    const remVehSel = document.getElementById("remVehicleSelect");
    const remVehFilter = document.getElementById("remVehicleFilterSelect");

    function fillSelect(sel, addAll) {
      if (!sel) return;
      sel.innerHTML = "";
      if (addAll) {
        const all = document.createElement("option");
        all.value = "ALL";
        all.textContent = (currentLang === "ar") ? "كل المركبات" : "All vehicles";
        sel.appendChild(all);
      }
      (state.vehicles || []).forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.plate ? `${v.name} (${v.plate})` : v.name;
        sel.appendChild(opt);
      });
      if (addAll) sel.value = "ALL";
    }

    fillSelect(remVehSel, false);
    fillSelect(remVehFilter, true);

    renderRemindersTable();
  }

  function renderRemindersTable() {
    const tbody = document.getElementById("remindersTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    const filter = document.getElementById("remFilterSelect")?.value || "open";
    const vehFilter = document.getElementById("remVehicleFilterSelect")?.value || "ALL";

    let list = [...(state.vehicleReminders || [])];

    if (filter === "open") list = list.filter(r => r.status === "open");
    if (filter === "done") list = list.filter(r => r.status === "done");
    if (vehFilter !== "ALL") list = list.filter(r => r.vehicleId === vehFilter);

    list.sort((a,b)=>{
      if (a.status !== b.status) return a.status === "open" ? -1 : 1;
      const ad = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
      const bd = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
      return ad - bd;
    });

    if (!list.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="text-muted">${t("no_reminders")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    const isEditor = state.user.role === "admin" || state.user.role === "manager";

    list.forEach((r) => {
      const statusPill = r.status === "done"
        ? `<span class="pill pill-done">${t("done")}</span>`
        : `<span class="pill pill-open">${currentLang === "ar" ? "مفتوح" : "open"}</span>`;

      const dueText = r.dueDate ? r.dueDate : "";
      const odoText = (r.dueOdometer === null || typeof r.dueOdometer === "undefined") ? "" : r.dueOdometer;

      const actionBtns = `
        <button class="btn btn-primary btn-sm" data-rem-done="${escapeHtml(r.id)}">
          ${r.status === "done" ? t("reopen") : t("done")}
        </button>
        ${isEditor ? `<button class="btn btn-secondary btn-sm" data-rem-del="${escapeHtml(r.id)}">${t("delete_reminder")}</button>` : ""}
      `;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${statusPill}</td>
        <td>${escapeHtml(vehicleNameById(r.vehicleId))}</td>
        <td>${escapeHtml(typeLabel(r.type))}</td>
        <td>${escapeHtml(dueText)}</td>
        <td>${escapeHtml(odoText)}</td>
        <td>${escapeHtml(r.note || "")}</td>
        <td style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;">${actionBtns}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ----- UI toggling -----
  function showApp() {
    document.getElementById("loginView").style.display = "none";
    document.getElementById("appView").style.display = "block";

    const isAdmin = state.user.role === "admin";
    const isManager = state.user.role === "manager";
    const isDriver = state.user.role === "driver";

    document.getElementById("usersPanel").style.display = isAdmin ? "block" : "none";
    document.getElementById("driverPanel").style.display = isDriver ? "block" : "none";

    document.getElementById("requestsPanel").style.display = isDriver ? "none" : "block";
    document.getElementById("inventoryPanel").style.display = (isAdmin || isManager) ? "block" : "none";
    document.getElementById("movementsPanel").style.display = (isAdmin || isManager) ? "block" : "none";
    document.getElementById("analyticsPanel").style.display = (isAdmin || isManager) ? "block" : "none";
    document.getElementById("vehiclePanel").style.display = (isAdmin || isManager || isDriver) ? "block" : "none";
  }

  function logout() {
    state.user = null;
    state.branches = [];
    state.users = [];
    state.items = [];
    state.movements = [];
    state.budgets = [];
    state.requests = [];
    state.vehicles = [];
    state.vehicleReminders = [];
    document.getElementById("appView").style.display = "none";
    document.getElementById("loginView").style.display = "block";
    renderHeader();
    document.getElementById("loginNameInput").value = "";
    document.getElementById("loginPasswordInput").value = "";
    const err = document.getElementById("loginError");
    err.style.display = "none";
    err.textContent = "";
  }

  async function refreshAllState() {
    const all = await apiLoadState();
    state.branches = all.branches || [];
    state.users = all.users || [];
    state.items = all.items || [];
    state.movements = all.movements || [];
    state.budgets = all.budgets || [];
    state.requests = all.requests || [];
    state.vehicles = all.vehicles || [];
    state.vehicleReminders = all.vehicleReminders || [];
  }

  async function updateItemIdField() {
    const idInput = document.getElementById("itemIdInput");
    if (!idInput) return;
    try {
      idInput.value = await apiNextItemId();
    } catch {
      idInput.value = "ITM-001";
    }
  }

  // ----- Events -----
  document.getElementById("langBtn").addEventListener("click", () => {
    currentLang = (currentLang === "ar") ? "en" : "ar";
    localStorage.setItem("lang", currentLang);
    applyTranslations();

    // Re-render dynamic texts
    renderBranchSelects();
    fillRequestItemsFromStorage();
    renderInventoryViewer();
    if (state.user) {
      renderUsersTable();
      renderRequestsTable();
      renderDriverRequestsTable();
      renderMovementsTable();
      renderAnalytics();
      renderVehiclesUI();
      renderHeader();
    }
  });

  document.getElementById("loginBtn").addEventListener("click", async () => {
    const name = document.getElementById("loginNameInput").value.trim();
    const password = document.getElementById("loginPasswordInput").value;
    const errorEl = document.getElementById("loginError");
    errorEl.style.display = "none";
    errorEl.textContent = "";

    if (!name || !password) {
      errorEl.textContent = t("enter_user_pass");
      errorEl.style.display = "block";
      return;
    }

    try {
      const user = await apiLogin(name, password);
      state.user = user;

      await refreshAllState();

      applyTranslations();
      renderHeader();
      renderBranchSelects();
      fillRequestItemsFromStorage();
      renderUsersTable();
      renderRequestsTable();
      renderDriverRequestsTable();
      renderMovementsTable();
      renderAnalytics();
      renderVehiclesUI();

      await updateItemIdField();

      showApp();
      renderInventoryViewer();
    } catch (e) {
      errorEl.textContent = e.message;
      errorEl.style.display = "block";
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", logout);

  document.getElementById("inventoryViewBranchSelect").addEventListener("change", () => {
    renderInventoryViewer();
  });

  document.getElementById("inventoryRefreshBtn").addEventListener("click", async () => {
    await refreshAllState();
    renderBranchSelects();
    fillRequestItemsFromStorage();
    renderInventoryViewer();
    renderRequestsTable();
    renderDriverRequestsTable();
    renderMovementsTable();
    renderAnalytics();
    renderVehiclesUI();
    await updateItemIdField();
  });

  // create user
  document.getElementById("addUserBtn").addEventListener("click", async () => {
    if (!state.user || state.user.role !== "admin") {
      alert(t("only_admin_create_users"));
      return;
    }
    const name = document.getElementById("newUserName").value.trim();
    const role = document.getElementById("newUserRole").value;
    const password = document.getElementById("newUserPassword").value.trim();
    const branchId = document.getElementById("newUserBranchSelect").value;

    if (!name || !password) {
      alert(t("name_password_required"));
      return;
    }
    try {
      const newUser = await apiCreateUser(name, role, password, branchId);
      state.users.push(newUser);
      renderUsersTable();
      document.getElementById("newUserName").value = "";
      document.getElementById("newUserPassword").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("editUserSelect").addEventListener("change", () => {
    const id = document.getElementById("editUserSelect").value;
    const user = state.users.find((u) => u.id === id);
    if (!user) {
      document.getElementById("editUserName").value = "";
      document.getElementById("editUserPassword").value = "";
      return;
    }
    document.getElementById("editUserName").value = user.name;
    document.getElementById("editUserPassword").value = "";
    document.getElementById("editUserRole").value = user.role;
    document.getElementById("editUserBranchSelect").value = user.branchId || "";
  });

  document.getElementById("saveUserChangesBtn").addEventListener("click", async () => {
    const id = document.getElementById("editUserSelect").value;
    if (!id) { alert(t("select_user_first")); return; }

    const name = document.getElementById("editUserName").value.trim();
    const password = document.getElementById("editUserPassword").value.trim();
    const role = document.getElementById("editUserRole").value;
    const branchId = document.getElementById("editUserBranchSelect").value;

    const updates = { name, role, branchId };
    if (password) updates.password = password;

    try {
      const updated = await apiUpdateUser(id, updates);
      const idx = state.users.findIndex((u) => u.id === id);
      if (idx >= 0) state.users[idx] = updated;
      renderUsersTable();
      alert(t("user_updated"));
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("deleteUserBtn").addEventListener("click", async () => {
    const id = document.getElementById("editUserSelect").value;
    if (!id) { alert(t("select_user_first")); return; }
    if (!confirm(t("delete_user_confirm"))) return;

    try {
      await apiDeleteUser(id);
      state.users = state.users.filter((u) => u.id !== id);
      renderUsersTable();
      document.getElementById("editUserName").value = "";
      document.getElementById("editUserPassword").value = "";
      alert(t("user_deleted"));
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("addItemBtn").addEventListener("click", async () => {
    if (!state.user || (state.user.role !== "admin" && state.user.role !== "manager")) {
      alert(t("only_admin_mgr_create_items"));
      return;
    }

    const id = document.getElementById("itemIdInput").value.trim();
    const name = document.getElementById("itemNameInput").value.trim();
    const branchId = document.getElementById("itemBranchSelect").value;
    const baseQty = Number(document.getElementById("itemBaseQtyInput").value || "0");
    const minQty = Number(document.getElementById("itemMinQtyInput").value || "0");
    const unitCost = Number(document.getElementById("itemUnitCostInput").value || "0");

    if (!name) { alert(t("item_name_required")); return; }

    try {
      const newItem = await apiCreateItem({
        id,
        name,
        branchId,
        baseQty,
        minQty,
        unitCost,
        managerUserId: state.user.id
      });

      state.items.push(newItem);

      renderInventoryViewer();
      fillRequestItemsFromStorage();

      document.getElementById("itemNameInput").value = "";
      document.getElementById("itemBaseQtyInput").value = "0";
      document.getElementById("itemMinQtyInput").value = "0";
      document.getElementById("itemUnitCostInput").value = "0";

      await updateItemIdField();
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("addMovementBtn").addEventListener("click", async () => {
    if (!state.user || (state.user.role !== "admin" && state.user.role !== "manager")) {
      alert(t("only_admin_mgr_movements"));
      return;
    }

    const itemId = document.getElementById("movementItemSelect").value;
    const type = document.getElementById("movementTypeSelect").value;
    const qty = Number(document.getElementById("movementQtyInput").value || "1");
    const note = document.getElementById("movementNoteInput").value.trim();

    if (!itemId || !qty || qty <= 0) { alert(t("item_qty_required")); return; }

    try {
      await apiCreateMovement(itemId, type, qty, note);
      await refreshAllState();

      renderBranchSelects();
      fillRequestItemsFromStorage();
      renderInventoryViewer();
      renderMovementsTable();
      renderAnalytics();

      document.getElementById("movementQtyInput").value = "1";
      document.getElementById("movementNoteInput").value = "";
      await updateItemIdField();
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("createRequestBtn").addEventListener("click", async () => {
    if (!state.user || state.user.role === "driver") { alert(t("drivers_cannot_create")); return; }
    if (!state.user.branchId) { alert(t("user_no_branch")); return; }

    const itemId = document.getElementById("requestItemSelect").value;
    const qty = Number(document.getElementById("requestQtyInput").value || "1");
    const note = document.getElementById("requestNoteInput").value.trim();

    if (!itemId || !qty || qty <= 0) { alert(t("item_qty_required")); return; }

    try {
      const req = await apiCreateRequest(itemId, qty, note);
      state.requests.push(req);
      renderRequestsTable();
      renderDriverRequestsTable();
      renderAnalytics();
      document.getElementById("requestQtyInput").value = "1";
      document.getElementById("requestNoteInput").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("driverRequestsTableBody").addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-req-id]");
    if (!btn) return;
    const id = btn.getAttribute("data-req-id");

    if (!confirm(t("mark_delivered_confirm"))) return;

    try {
      await apiDeliverRequest(id);
      await refreshAllState();

      renderBranchSelects();
      fillRequestItemsFromStorage();
      renderInventoryViewer();
      renderDriverRequestsTable();
      renderRequestsTable();
      renderMovementsTable();
      renderAnalytics();
    } catch (err) {
      alert(err.message);
    }
  });

  document.getElementById("analyticsApplyBtn").addEventListener("click", () => {
    renderAnalytics();
  });

  document.getElementById("addVehicleBtn").addEventListener("click", async () => {
    const name = document.getElementById("vehNameInput").value.trim();
    const plate = document.getElementById("vehPlateInput").value.trim();
    if (!name) { alert(t("vehicle_name_required_msg")); return; }

    try {
      await apiCreateVehicle(name, plate);
      await refreshAllState();
      renderVehiclesUI();
      document.getElementById("vehNameInput").value = "";
      document.getElementById("vehPlateInput").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("addReminderBtn").addEventListener("click", async () => {
    const vehicleId = document.getElementById("remVehicleSelect").value;
    const type = document.getElementById("remTypeSelect").value;
    const dueDate = document.getElementById("remDueDateInput").value || null;
    const dueOdometerRaw = document.getElementById("remDueOdoInput").value;
    const dueOdometer = dueOdometerRaw === "" ? null : Number(dueOdometerRaw);
    const note = document.getElementById("remNoteInput").value.trim();

    if (!vehicleId) { alert(t("select_vehicle_msg")); return; }

    try {
      await apiCreateReminder({ vehicleId, type, dueDate, dueOdometer, note });
      await refreshAllState();
      renderVehiclesUI();
      document.getElementById("remDueDateInput").value = "";
      document.getElementById("remDueOdoInput").value = "";
      document.getElementById("remNoteInput").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("remRefreshBtn").addEventListener("click", async () => {
    await refreshAllState();
    renderVehiclesUI();
  });

  document.getElementById("remFilterSelect").addEventListener("change", renderRemindersTable);
  document.getElementById("remVehicleFilterSelect").addEventListener("change", renderRemindersTable);

  document.getElementById("remindersTableBody").addEventListener("click", async (e) => {
    const doneBtn = e.target.closest("button[data-rem-done]");
    const delBtn = e.target.closest("button[data-rem-del]");

    if (doneBtn) {
      const id = doneBtn.getAttribute("data-rem-done");
      const r = (state.vehicleReminders || []).find(x => x.id === id);
      if (!r) return;
      try {
        await apiUpdateReminder(id, { status: r.status === "done" ? "open" : "done" });
        await refreshAllState();
        renderVehiclesUI();
      } catch (err) {
        alert(err.message);
      }
    }

    if (delBtn) {
      const id = delBtn.getAttribute("data-rem-del");
      if (!confirm(t("delete_reminder_confirm"))) return;
      try {
        await apiDeleteReminder(id);
        await refreshAllState();
        renderVehiclesUI();
      } catch (err) {
        alert(err.message);
      }
    }
  });

  // initial i18n
  applyTranslations();
</script>
</body>
</html>
