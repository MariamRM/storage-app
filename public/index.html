<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storage Manage Method</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link id="favicon" rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%23111827'/%3E%3Ctext x='50' y='62' font-size='56' text-anchor='middle' fill='white' font-family='Arial, sans-serif'%3ES%3C/text%3E%3C/svg%3E" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { margin: 0; background: #f3f4f6; color: #111827; }
    header { background: #111827; color: white; padding: 0.75rem 1.25rem; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; }
    header h1 { font-size: 1rem; margin: 0; letter-spacing: 0.03em; }
    header small { display: block; font-size: 0.7rem; opacity: 0.8; }
    .header-right { display: flex; align-items: center; gap: 0.75rem; font-size: 0.8rem; flex-wrap: wrap; }
    .badge { display: inline-flex; align-items: center; padding: 0.15rem 0.6rem; border-radius: 999px; font-size: 0.75rem; background: #e5e7eb; color: #111827; }
    .btn { display: inline-flex; align-items: center; justify-content: center; border-radius: 999px; border: none; padding: 0.55rem 1.15rem; font-size: 0.9rem; cursor: pointer; transition: background 0.15s, transform 0.1s; }
    .btn-primary { background: #111827; color: white; }
    .btn-primary:hover { background: #020617; transform: translateY(-1px); }
    .btn-secondary { background: #e5e7eb; color: #111827; }
    .btn-secondary:hover { background: #d1d5db; transform: translateY(-1px); }
    .btn-sm { padding: 0.45rem 0.9rem; font-size: 0.82rem; }
    main { padding: 1rem; max-width: 1200px; margin: 0 auto 2rem; }
    .panel { background: white; border-radius: 0.9rem; padding: 0.9rem 1rem; margin-bottom: 0.9rem; box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06); }
    .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; gap: 0.75rem; }
    .panel-title { font-size: 0.95rem; font-weight: 600; color: #111827; }
    .panel-subtitle { font-size: 0.75rem; color: #6b7280; }
    .panel-section-title { font-size: 0.85rem; font-weight: 700; margin: 0.8rem 0 0.35rem; }
    .text-muted { color: #9ca3af; }
    .grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 0.6rem; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.6rem; }
    label { font-size: 0.78rem; display: block; margin-bottom: 0.15rem; color: #374151; }
    input, select, textarea { width: 100%; padding: 0.45rem 0.6rem; border-radius: 0.55rem; border: 1px solid #e5e7eb; font-size: 0.85rem; background: #ffffff; }
    textarea { resize: vertical; min-height: 40px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #111827; box-shadow: 0 0 0 1px #11182711; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    th, td { padding: 0.4rem 0.45rem; text-align: left; border-bottom: 1px solid #f3f4f6; white-space: nowrap; }
    .transfer-row { background: #fff7ed; }
    .transfer-ready { background: #ecfdf3; }
    th { font-size: 0.72rem; font-weight: 700; color: #6b7280; background: #f9fafb; }
    tr:nth-child(even) td { background: #f9fafb; }
    .pill { display: inline-flex; align-items: center; padding: 0.08rem 0.55rem; border-radius: 999px; font-size: 0.72rem; }
    .pill-status { background: #e5e7eb; color: #111827; }
    .pill-status.pending { background: #fef3c7; color: #92400e; }
    .pill-status.delivered { background: #dcfce7; color: #166534; }
    .pill-status.assigned { background: #dbeafe; color: #1e3a8a; }
    .pill-status.in_transit { background: #fde68a; color: #92400e; }
    .pill-priority { background: #e5e7eb; color: #111827; }
    .pill-priority.urgent { background: #fee2e2; color: #991b1b; }
    .pill-open { background: #fef3c7; color: #92400e; }
    .pill-done { background: #dcfce7; color: #166534; }
    .table-wrapper { width: 100%; overflow-x: auto; margin-top: 0.4rem; }
    .pagination-controls { display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.4rem; }
    .pagination-controls .page-buttons { display: flex; align-items: center; gap: 0.4rem; }
    .danger { color: #b91c1c; font-weight: 700; }
    /* Login card */
    #loginView { max-width: 640px; margin: 2.5rem auto; padding: 0 1rem; }
    .card { background: white; border-radius: 1rem; padding: 1.2rem 1.5rem; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08); }
    .card h2 { margin: 0 0 0.5rem; font-size: 1.2rem; }
    .mt-xs { margin-top: 0.35rem; }
    .mt-sm { margin-top: 0.6rem; }
    .mt-md { margin-top: 0.9rem; }
    .mt-lg { margin-top: 1.2rem; }
    .error-text { margin-top: 0.4rem; font-size: 0.85rem; color: #b91c1c; }
    .summary-row { display: flex; flex-wrap: wrap; gap: 0.6rem; margin-top: 0.6rem; }
    .summary-card { flex: 1 1 160px; background: #f9fafb; border-radius: 0.7rem; padding: 0.6rem 0.8rem; font-size: 0.85rem; }
    .summary-label { font-size: 0.72rem; color: #6b7280; }
    .summary-value { font-size: 0.95rem; font-weight: 800; margin-top: 0.2rem; }

    .toolbar { display:flex; gap:0.6rem; flex-wrap:wrap; align-items:flex-end; }
    .toolbar > div { min-width: 220px; flex: 1 1 220px; }

    .menu { display:flex; gap:0.5rem; flex-wrap:wrap; }
    .menu .btn { border-radius: 0.6rem; }
    .menu .btn.active { background: #111827; color: #fff; }

    body.phone-mode .btn { font-size: 1.05rem; padding: 0.8rem 1.2rem; }
    body.phone-mode table { font-size: 0.95rem; }
    body.phone-mode th, body.phone-mode td { padding: 0.55rem 0.6rem; }
    body.phone-mode .panel { padding: 1rem 1.1rem; }
    body.phone-mode .driver-actions { display: flex; flex-direction: column; gap: 0.5rem; align-items: stretch; }
    body.phone-mode .driver-actions select,
    body.phone-mode .driver-actions input,
    body.phone-mode .driver-actions button { width: 100%; }

    .toast-container { position: fixed; right: 1rem; bottom: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 9999; }
    .toast { background: #111827; color: #fff; padding: 0.6rem 0.9rem; border-radius: 0.6rem; font-size: 0.9rem; box-shadow: 0 8px 20px rgba(0,0,0,0.2); animation: toast-in 0.2s ease-out; }
    @keyframes toast-in { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
      main { padding: 0.7rem; }
      .panel { padding: 0.75rem 0.85rem; }
      .grid, .grid-2 { grid-template-columns: minmax(0, 1fr); }
      table { font-size: 0.76rem; }
      th, td { padding: 0.3rem 0.35rem; }
      .btn { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; }
      .btn-sm { width: auto; padding: 0.5rem 0.8rem; font-size: 0.85rem; }
      .toolbar > div { min-width: 100%; }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1 data-i18n="app_title">Storage Manage Method</h1>
    <small data-i18n="app_subtitle">Branch → Storage orders, drivers & analytics</small>
  </div>
  <div class="header-right">
    <span id="headerUserName" class="badge" style="display:none;"></span>
    <span id="headerRole" class="badge" style="display:none;"></span>

    <button id="phoneModeBtn" class="btn btn-secondary btn-sm" style="display:none;"></button>
    <button id="langBtn" class="btn btn-secondary btn-sm">AR</button>
    <button id="logoutBtn" class="btn btn-secondary btn-sm" style="display:none;" data-i18n="logout">Logout</button>
  </div>
</header>

<nav id="mainMenu" class="panel menu" style="display:none;"></nav>
<div id="toastContainer" class="toast-container"></div>

<!-- LOGIN VIEW -->
<section id="loginView">
  <div class="card">
    <h2 data-i18n="signin_title">Sign in</h2>

    <div class="mt-md grid-2">
      <div>
        <label data-i18n="username">Username</label>
        <input id="loginNameInput" />
      </div>
      <div>
        <label data-i18n="password">Password</label>
        <input id="loginPasswordInput" type="password" />
      </div>
    </div>

    <button id="loginBtn" class="btn btn-primary mt-md" style="width: 100%;" data-i18n="signin_btn">Sign in</button>
    <div id="loginError" class="error-text" style="display:none;"></div>
  </div>
</section>

<!-- APP VIEW -->
<main id="appView" style="display:none;">

  <!-- Inventory panel (Admin & Manager) -->
  <section id="inventoryPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="inventory_title">Inventory</div>
        <div class="panel-subtitle" data-i18n="inventory_subtitle">Admin & Manager can add items and manage inventory. Supervisor can view Main Storage.</div>
      </div>
    </div>

    <!-- Viewer branch select -->
    <div class="panel-section-title" data-i18n="view_inventory_list">View inventory list</div>
    <div class="toolbar">
      <div>
        <label data-i18n="select_list">Select list</label>
        <select id="inventoryViewBranchSelect"></select>
      </div>
      <div>
        <label data-i18n="search_items">Search items</label>
        <input id="inventorySearchInput" />
      </div>
      <div>
        <button id="inventoryRefreshBtn" class="btn btn-secondary" data-i18n="refresh">Refresh</button>
      </div>
    </div>

    <div class="table-wrapper mt-sm">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_name">Name</th>
          <th data-i18n="th_branch">Branch</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_min">Min</th>
          <th data-i18n="th_unit_cost">Unit cost</th>
          <th data-i18n="th_value">Value</th>
        </tr>
        </thead>
        <tbody id="itemsTableBody"></tbody>
      </table>
    </div>
    <div class="pagination-controls">
      <div>
        <label data-i18n="items_per_page">Items per page</label>
        <select id="inventoryPageSizeSelect">
          <option value="20">20</option>
          <option value="40">40</option>
          <option value="80">80</option>
        </select>
      </div>
      <div class="page-buttons">
        <button id="inventoryPrevBtn" class="btn btn-secondary btn-sm">&lt;</button>
        <span id="inventoryPageInfo" class="text-muted"></span>
        <button id="inventoryNextBtn" class="btn btn-secondary btn-sm">&gt;</button>
      </div>
    </div>

    <div class="summary-row mt-sm">
      <div class="summary-card">
        <div class="summary-label" data-i18n="selected_list_value">Selected list value (KWD)</div>
        <div id="selectedListValue" class="summary-value">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label" data-i18n="main_storage_value">Main Storage value (KWD)</div>
        <div id="storageTotalValue" class="summary-value">0</div>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="restock_alerts">Restock alerts (Main Storage)</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_item">Item</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_min">Min</th>
        </tr>
        </thead>
        <tbody id="alertsTableBody"></tbody>
      </table>
    </div>

    <!-- Add/update items -->
    <div id="inventoryManageBlock">
    <div class="panel-section-title mt-md" data-i18n="add_update_items">Add / update items (Admin & Manager)</div>

    <!-- select existing item to edit -->
    <div class="grid mt-xs">
      <div>
        <label data-i18n="search_item_to_edit">Search item to edit</label>
        <input id="itemEditSearchInput" />
      </div>
      <div>
        <label data-i18n="select_item_to_edit">Select item to edit (optional)</label>
        <select id="itemEditSelect"></select>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label data-i18n="item_type">Item type</label>
        <select id="itemTypeSelect">
          <option value="ITEM" data-i18n="item_type_regular">Regular (ITEM)</option>
          <option value="THR" data-i18n="item_type_thread">Thread (THR)</option>
        </select>
      </div>
      <div>
        <label data-i18n="item_id_auto">Item ID (auto)</label>
        <input id="itemIdInput" placeholder="ITEM-001" readonly />
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_name">Name</label>
        <input id="itemNameInput" />
      </div>
      <div>
        <label data-i18n="item_branch_where">Branch (where item lives)</label>
        <select id="itemBranchSelect"></select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="base_quantity">Base quantity</label>
        <input id="itemBaseQtyInput" type="number" min="0" value="0" />
      </div>
      <div>
        <label data-i18n="minimum_quantity">Minimum quantity (alert)</label>
        <input id="itemMinQtyInput" type="number" min="0" value="0" />
      </div>
      <div>
        <label data-i18n="th_unit_cost">Unit cost</label>
        <input id="itemUnitCostInput" type="number" min="0" step="0.001" value="0" />
      </div>
    </div>

    <div class="mt-sm" style="display:flex;gap:0.5rem;flex-wrap:wrap;">
      <button id="addItemBtn" class="btn btn-primary" data-i18n="save_item">Save item</button>
      <button id="updateItemBtn" class="btn btn-secondary" data-i18n="update_item">Update item</button>
      <button id="deleteItemBtn" class="btn btn-secondary" data-i18n="delete_item">Cancel item</button>
    </div>
    </div>
  </section>

  <!-- Users (Admin) -->
  <section id="usersPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="users_branches">Users & branches</div>
        <div class="panel-subtitle" data-i18n="users_subtitle">Admin can create, edit and delete users and assign them to branches.</div>
      </div>
    </div>

    <div class="panel-section-title" data-i18n="create_user">Create user</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="username">Username</label>
        <input id="newUserName" />
      </div>
      <div>
        <label data-i18n="password">Password</label>
        <input id="newUserPassword" />
      </div>
      <div>
        <label data-i18n="role">Role</label>
        <select id="newUserRole">
          <option value="staff">Staff</option>
          <option value="supervisor">Supervisor</option>
          <option value="manager">Manager</option>
          <option value="driver">Driver</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_branch">Branch</label>
        <select id="newUserBranchSelect"></select>
      </div>
      <div></div>
      <div style="display:flex;align-items:flex-end;">
        <button id="addUserBtn" class="btn btn-primary" style="width:100%;" data-i18n="create_user_btn">Create user</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="create_branch">Create branch</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="branch_name">Branch name</label>
        <input id="newBranchName" />
      </div>
      <div></div>
      <div style="display:flex;align-items:flex-end;">
        <button id="addBranchBtn" class="btn btn-primary" style="width:100%;" data-i18n="create_branch_btn">Create branch</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="branches_list">Branches list</div>
    <div class="table-wrapper">
      <table class="driver-table">
        <thead>
        <tr><th data-i18n="th_id">ID</th><th data-i18n="th_name">Name</th></tr>
        </thead>
        <tbody id="branchesTableBody"></tbody>
      </table>
    </div>

    <div class="panel-section-title mt-md" data-i18n="users_list">Users list</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr><th data-i18n="th_name">Name</th><th data-i18n="role">Role</th><th data-i18n="th_branch">Branch</th><th data-i18n="th_access">Access</th></tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </div>

    <div class="panel-section-title mt-md" data-i18n="edit_delete_user">Edit / delete user</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="select_user">Select user</label>
        <select id="editUserSelect"></select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_name">Name</label>
        <input id="editUserName" />
      </div>
      <div>
        <label data-i18n="password_keep">Password (leave empty to keep)</label>
        <input id="editUserPassword" type="password" />
      </div>
      <div>
        <label data-i18n="role">Role</label>
        <select id="editUserRole">
          <option value="staff">Staff</option>
          <option value="supervisor">Supervisor</option>
          <option value="manager">Manager</option>
          <option value="driver">Driver</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_branch">Branch</label>
        <select id="editUserBranchSelect"></select>
      </div>
      <div>
        <label data-i18n="allowed_scope">Allowed scope (Supervisor)</label>
        <select id="editUserAllowedScope">
          <option value="own" data-i18n="scope_own">Own branch only</option>
          <option value="multiple" data-i18n="scope_multiple">Multiple branches</option>
          <option value="all" data-i18n="scope_all">All branches</option>
        </select>
      </div>
      <div>
        <label data-i18n="allowed_branches">Allowed branches (Supervisor)</label>
        <select id="editUserAllowedBranches" multiple size="4"></select>
      </div>
      <div style="display:flex;align-items:flex-end;gap:0.4rem;">
        <button id="saveUserChangesBtn" class="btn btn-primary" style="flex:1;" data-i18n="save_changes">Save changes</button>
        <button id="deleteUserBtn" class="btn btn-secondary" style="flex:1;" data-i18n="delete_user">Delete user</button>
      </div>
    </div>
  </section>

  <!-- Requests (staff/manager/admin) -->
  <section id="requestsPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="branch_requests">Branch requests</div>
        <div class="panel-subtitle" data-i18n="requests_subtitle">Staff / Supervisor / Manager / Admin request items from Main Storage to their own branch.</div>
      </div>
    </div>

    <div class="panel-section-title" data-i18n="new_request">New request</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="from_storage">From storage</label>
        <div id="requestFromBranchLabel" class="text-muted" style="font-size:0.85rem;"></div>
      </div>
      <div>
        <label data-i18n="to_branch">To branch</label>
        <div id="requestToBranchLabel" class="text-muted" style="font-size:0.85rem;"></div>
      </div>
      <div>
        <label data-i18n="item_from_storage">Item (from storage)</label>
        <input id="requestItemSearchInput" placeholder="Type to filter items" style="margin-top:0.25rem;" />
        <select id="requestItemSelect"></select>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label data-i18n="quantity">Quantity</label>
        <input id="requestQtyInput" type="number" min="1" value="1" />
      </div>
      <div>
        <label data-i18n="priority">Priority</label>
        <select id="requestPrioritySelect">
          <option value="normal" data-i18n="priority_normal">Normal</option>
          <option value="urgent" data-i18n="priority_urgent_today">Urgent (today)</option>
        </select>
      </div>
      <div>
        <label data-i18n="urgent_note">Urgent note</label>
        <input id="requestUrgentNoteInput" />
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label data-i18n="note">Note</label>
        <input id="requestNoteInput" />
      </div>
      <div>
        <label data-i18n="request_image">Request image</label>
        <input id="requestImageInput" type="file" accept="image/*" />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="createRequestBtn" class="btn btn-primary" style="width:100%;" data-i18n="create_request">Create request</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="requests_for_my_branch">Requests for my branch</div>
    <div id="requestsFilterBar" class="toolbar mt-xs" style="display:none;">
      <div>
        <label data-i18n="filter_by_branch">Filter by branch</label>
        <select id="requestBranchFilterSelect"></select>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_order">Order #</th>
          <th data-i18n="th_created_at">Created</th>
          <th data-i18n="th_item">Item</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_from">From</th>
          <th data-i18n="th_to">To</th>
          <th data-i18n="th_priority">Priority</th>
          <th data-i18n="th_eta">ETA</th>
          <th data-i18n="th_status">Status</th>
          <th data-i18n="th_by">By</th>
          <th data-i18n="th_driver">Driver</th>
          <th data-i18n="th_note">Note</th>
          <th data-i18n="th_image">Image</th>
          <th data-i18n="th_action">Action</th>
        </tr>
        </thead>
        <tbody id="requestsTableBody"></tbody>
      </table>
    </div>

    <div id="requestsHistoryBlock" class="mt-md" style="display:none;">
      <div class="panel-section-title" data-i18n="requests_history">Requests history</div>
      <div class="toolbar mt-xs">
        <div>
          <label data-i18n="filter_by_branch">Filter by branch</label>
          <select id="requestHistoryBranchSelect"></select>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th data-i18n="th_order">Order #</th>
            <th data-i18n="th_created_at">Created</th>
            <th data-i18n="th_delivered_at">Delivered</th>
            <th data-i18n="th_item">Item</th>
            <th data-i18n="th_qty">Qty</th>
            <th data-i18n="th_from">From</th>
            <th data-i18n="th_to">To</th>
            <th data-i18n="th_priority">Priority</th>
            <th data-i18n="th_by">By</th>
            <th data-i18n="th_driver">Driver</th>
            <th data-i18n="th_note">Note</th>
            <th data-i18n="th_image">Image</th>
          </tr>
          </thead>
          <tbody id="requestsHistoryTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Transfers (bags) -->
  <section id="transferPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="transfer_title">Bags transfer</div>
        <div class="panel-subtitle" data-i18n="transfer_subtitle">Request bags transfer between branches. Supervisor assigns destination. Drivers deliver.</div>
      </div>
    </div>

    <div class="panel-section-title" data-i18n="new_transfer">New transfer</div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="transfer_qty">Quantity of bags</label>
        <input id="transferQtyInput" type="number" min="1" value="1" />
      </div>
      <div>
        <label data-i18n="note">Note</label>
        <input id="transferNoteInput" />
      </div>
      <div>
        <label data-i18n="transfer_image">Transfer image</label>
        <input id="transferImageInput" type="file" accept="image/*" />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="createTransferBtn" class="btn btn-primary" style="width:100%;" data-i18n="create_transfer">Create transfer</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="active_transfers">Active transfers</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_created_at">Created</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_from">From</th>
          <th data-i18n="th_to">To</th>
          <th data-i18n="th_status">Status</th>
          <th data-i18n="th_ready">Ready</th>
          <th data-i18n="th_by">By</th>
          <th data-i18n="th_driver">Driver</th>
          <th data-i18n="th_note">Note</th>
          <th data-i18n="th_image">Image</th>
          <th data-i18n="th_action">Action</th>
        </tr>
        </thead>
        <tbody id="transferTableBody"></tbody>
      </table>
    </div>

    <div class="panel-section-title mt-md" data-i18n="transfer_history">Transfer history</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_created_at">Created</th>
          <th data-i18n="th_delivered_at">Delivered</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_from">From</th>
          <th data-i18n="th_to">To</th>
          <th data-i18n="th_ready">Ready</th>
          <th data-i18n="th_driver">Driver</th>
          <th data-i18n="th_note">Note</th>
          <th data-i18n="th_image">Image</th>
        </tr>
        </thead>
        <tbody id="transferHistoryTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Driver panel -->
  <section id="driverPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="driver_deliveries">Driver deliveries</div>
        <div class="panel-subtitle" data-i18n="driver_subtitle">Drivers see pending requests, can take any request and set ETA (staff confirm receipt).</div>
        <div id="driverNotice" class="summary-row mt-xs"></div>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_order">Order #</th>
          <th data-i18n="th_created_at">Created</th>
          <th data-i18n="th_item">Item</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_from">From</th>
          <th data-i18n="th_to">To</th>
          <th data-i18n="th_priority">Priority</th>
          <th data-i18n="th_eta">ETA</th>
          <th data-i18n="th_note">Note</th>
          <th data-i18n="th_image">Image</th>
          <th data-i18n="th_driver">Driver</th>
          <th data-i18n="th_requested_by">Requested by</th>
          <th data-i18n="th_status">Status</th>
          <th data-i18n="th_action">Action</th>
        </tr>
        </thead>
        <tbody id="driverRequestsTableBody"></tbody>
      </table>
    </div>

    <div class="panel-section-title mt-md" data-i18n="driver_transfers">Driver transfers</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_created_at">Created</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_from">From</th>
          <th data-i18n="th_to">To</th>
          <th data-i18n="th_status">Status</th>
          <th data-i18n="th_ready">Ready</th>
          <th data-i18n="th_note">Note</th>
          <th data-i18n="th_image">Image</th>
          <th data-i18n="th_action">Action</th>
        </tr>
        </thead>
        <tbody id="driverTransfersTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Movements (Admin & Manager) -->
  <section id="movementsPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="manual_movements">Manual stock movements</div>
        <div class="panel-subtitle" data-i18n="movements_subtitle">Only Admin & Manager can record IN / OUT movements that change stock.</div>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_item">Item</label>
        <select id="movementItemSelect"></select>
      </div>
      <div>
        <label data-i18n="type">Type</label>
        <select id="movementTypeSelect">
          <option value="IN">IN (add)</option>
          <option value="OUT">OUT (remove)</option>
        </select>
      </div>
      <div>
        <label data-i18n="quantity">Quantity</label>
        <input id="movementQtyInput" type="number" min="1" value="1" />
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label data-i18n="note">Note</label>
        <input id="movementNoteInput" />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="addMovementBtn" class="btn btn-primary" style="width:100%;" data-i18n="save_movement">Save movement</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="recent_movements">Recent movements</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_id">ID</th>
          <th data-i18n="th_item">Item</th>
          <th data-i18n="type">Type</th>
          <th data-i18n="th_qty">Qty</th>
          <th data-i18n="th_branch">Branch</th>
          <th data-i18n="th_user">User</th>
          <th data-i18n="th_time">Time</th>
        </tr>
        </thead>
        <tbody id="movementsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Analytics (budget/usage, Admin & Manager) -->
  <section id="analyticsPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="analytics_title">Budget & usage dashboard</div>
        <div class="panel-subtitle" data-i18n="analytics_subtitle">Automatic spend calculation from delivered requests (qty × item price), filter by date and branch.</div>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label data-i18n="th_branch">Branch</label>
        <select id="analyticsBranchSelect">
          <option value="ALL">All branches</option>
        </select>
      </div>
      <div>
        <label data-i18n="from_date">From date</label>
        <input id="analyticsFromDate" type="date" />
      </div>
      <div>
        <label data-i18n="to_date">To date</label>
        <input id="analyticsToDate" type="date" />
      </div>
    </div>
    <div style="display:flex;gap:0.6rem;flex-wrap:wrap;margin-top:0.6rem;">
      <button id="analyticsApplyBtn" class="btn btn-primary" data-i18n="apply_filters">Apply filters</button>
      <button id="exportMonthlyReportBtn" class="btn btn-secondary" data-i18n="export_monthly_report">Export monthly report</button>
    </div>

    <div class="summary-row mt-sm">
      <div class="summary-card">
        <div class="summary-label" data-i18n="total_spent">Total spent (KWD)</div>
        <div id="analyticsTotalCost" class="summary-value">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label" data-i18n="delivered_requests">Delivered requests</div>
        <div id="analyticsTotalRequests" class="summary-value">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label" data-i18n="total_quantity">Total quantity</div>
        <div id="analyticsTotalQty" class="summary-value">0</div>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="most_ordered">Most ordered items (by cost)</div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th data-i18n="th_item">Item</th>
            <th data-i18n="th_total_qty">Total qty</th>
            <th data-i18n="th_total_cost">Total cost</th>
          </tr>
        </thead>
        <tbody id="analyticsItemsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Vehicle reminders (Admin/Manager/Driver) -->
  <section id="vehiclePanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title" data-i18n="vehicle_reminders">Vehicle reminders</div>
        <div class="panel-subtitle" data-i18n="vehicle_subtitle">Oil change, meter, yearly renewal. Admin/Manager can add; Driver can mark done.</div>
      </div>
    </div>

    <div id="vehicleCreateBlock" style="display:none;">
      <div class="panel-section-title" data-i18n="add_vehicle">Add vehicle (Admin/Manager)</div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="vehicle_name">Vehicle name</label>
          <input id="vehNameInput" placeholder="Delivery Car 1" />
        </div>
        <div>
          <label data-i18n="plate_optional">Plate (optional)</label>
          <input id="vehPlateInput" placeholder="KUWAIT-12345" />
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button id="addVehicleBtn" class="btn btn-primary" style="width:100%;" data-i18n="add_vehicle_btn">Add vehicle</button>
        </div>
      </div>

      <div id="vehicleManageBlock" class="mt-md" style="display:none;">
        <div class="panel-section-title" data-i18n="manage_vehicles_title">Edit / delete vehicles (Admin/Manager)</div>
        <div class="grid mt-xs">
          <div>
            <label data-i18n="select_vehicle_edit">Select vehicle</label>
            <select id="vehicleEditSelect"></select>
          </div>
        </div>
        <div class="grid mt-xs">
          <div>
            <label data-i18n="vehicle_name">Vehicle name</label>
            <input id="vehEditNameInput" />
          </div>
          <div>
            <label data-i18n="plate_optional">Plate (optional)</label>
            <input id="vehEditPlateInput" />
          </div>
        </div>
        <div class="mt-sm" style="display:flex;gap:0.5rem;flex-wrap:wrap;">
          <button id="updateVehicleBtn" class="btn btn-primary" data-i18n="update_vehicle_btn">Update vehicle</button>
          <button id="deleteVehicleBtn" class="btn btn-secondary danger" data-i18n="delete_vehicle_btn">Delete vehicle</button>
        </div>
      </div>

      <div class="panel-section-title mt-md" data-i18n="add_reminder">Add reminder (Admin/Manager)</div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="vehicle">Vehicle</label>
          <select id="remVehicleSelect"></select>
        </div>
        <div>
          <label data-i18n="type">Type</label>
          <select id="remTypeSelect">
            <option value="OIL_CHANGE">Oil change</option>
            <option value="METER">Meter</option>
            <option value="YEARLY_RENEW">Yearly renewal</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        <div>
          <label data-i18n="due_date">Due date</label>
          <input id="remDueDateInput" type="date" />
        </div>
      </div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="due_odometer">Due odometer (km)</label>
          <input id="remDueOdoInput" type="number" min="0" placeholder="e.g. 50000" />
        </div>
        <div>
          <label data-i18n="note">Note</label>
          <input id="remNoteInput" placeholder="Change oil filter too..." />
        </div>
        <div style="display:flex;align-items:flex-end;">
          <button id="addReminderBtn" class="btn btn-primary" style="width:100%;" data-i18n="add_reminder_btn">Add reminder</button>
        </div>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="vehicle_assignments">Vehicle assignments</div>
    <div class="panel-subtitle" data-i18n="vehicle_assignments_subtitle">Assign drivers to vehicles and keep a hand over log.</div>
    <div class="table-wrapper mt-sm">
      <table>
        <thead>
        <tr>
          <th data-i18n="vehicle">Vehicle</th>
          <th data-i18n="th_driver">Driver</th>
          <th data-i18n="note">Note</th>
          <th data-i18n="assigned_at">Assigned at</th>
          <th data-i18n="assigned_by">Assigned by</th>
        </tr>
        </thead>
        <tbody id="vehicleAssignmentsTableBody"></tbody>
      </table>
    </div>

    <div id="vehicleAssignFormBlock" class="mt-md" style="display:none;">
      <div class="panel-section-title" data-i18n="assign_vehicle_title">Assign / hand over vehicle</div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="vehicle">Vehicle</label>
          <select id="assignVehicleSelect"></select>
        </div>
        <div>
          <label data-i18n="th_driver">Driver</label>
          <select id="assignDriverSelect"></select>
        </div>
        <div>
          <label data-i18n="note">Note</label>
          <input id="assignNoteInput" />
        </div>
      </div>
      <div class="mt-sm" style="display:flex;justify-content:flex-end;">
        <button id="assignVehicleBtn" class="btn btn-primary" data-i18n="assign_vehicle_btn">Assign vehicle</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="reminders">Reminders</div>
    <div class="toolbar">
      <div>
        <label data-i18n="filter">Filter</label>
        <select id="remFilterSelect">
          <option value="attention">Attention</option>
          <option value="open">Open</option>
          <option value="all">All</option>
          <option value="done">Done</option>
        </select>
      </div>
      <div>
        <label data-i18n="vehicle">Vehicle</label>
        <select id="remVehicleFilterSelect"></select>
      </div>
      <div>
        <button id="remRefreshBtn" class="btn btn-secondary" data-i18n="refresh">Refresh</button>
      </div>
    </div>

    <div class="table-wrapper mt-sm">
      <table>
        <thead>
        <tr>
          <th data-i18n="th_status">Status</th>
          <th data-i18n="vehicle">Vehicle</th>
          <th data-i18n="type">Type</th>
          <th data-i18n="due">Due</th>
          <th data-i18n="odometer">Odometer</th>
          <th data-i18n="note">Note</th>
          <th data-i18n="th_action">Action</th>
        </tr>
        </thead>
        <tbody id="remindersTableBody"></tbody>
      </table>
    </div>

    <div class="panel-section-title mt-md" data-i18n="maintenance_records">Maintenance records</div>
    <div class="panel-subtitle" data-i18n="maintenance_records_subtitle">Drivers log costs, invoices and notes. Admin/Manager can review every car.</div>

    <div id="maintenanceFormBlock" class="mt-sm" style="display:none;">
      <div class="grid mt-xs">
        <div>
          <label data-i18n="vehicle">Vehicle</label>
          <select id="maintVehicleSelect"></select>
        </div>
        <div id="maintDriverField">
          <label data-i18n="th_driver">Driver</label>
          <select id="maintDriverSelect"></select>
        </div>
        <div>
          <label data-i18n="maintenance_date">Maintenance date</label>
          <input id="maintDateInput" type="date" />
        </div>
      </div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="next_maintenance_date">Next maintenance date</label>
          <input id="maintNextDateInput" type="date" />
        </div>
        <div>
          <label data-i18n="maintenance_price">Price (KWD)</label>
          <input id="maintPriceInput" type="number" min="0" step="0.001" />
        </div>
        <div>
          <label data-i18n="invoice_number">Invoice number</label>
          <input id="maintInvoiceInput" />
        </div>
      </div>
      <div class="grid mt-xs">
        <div>
          <label data-i18n="maintenance_place">Place / workshop</label>
          <input id="maintPlaceInput" placeholder="Garage name" />
        </div>
        <div>
          <label data-i18n="store_name">Store</label>
          <input id="maintStoreInput" placeholder="Spare parts store" />
        </div>
        <div>
          <label data-i18n="note">Note</label>
          <input id="maintNoteInput" placeholder="Extra details" />
        </div>
      </div>
      <div class="mt-sm" style="display:flex;justify-content:flex-end;">
        <button id="saveMaintenanceBtn" class="btn btn-primary" data-i18n="save_maintenance">Save maintenance</button>
      </div>
    </div>

    <div class="panel-section-title mt-md" data-i18n="maintenance_history">Maintenance history</div>
    <div class="panel-subtitle" data-i18n="maintenance_history_subtitle">Filtered automatically by your role. Drivers see their assigned cars.</div>
    <div class="toolbar">
      <div>
        <label data-i18n="vehicle">Vehicle</label>
        <select id="maintenanceHistoryVehicleSelect"></select>
      </div>
      <div>
        <button id="maintenanceRefreshBtn" class="btn btn-secondary" data-i18n="refresh">Refresh</button>
      </div>
    </div>

    <div class="table-wrapper mt-sm">
      <table>
        <thead>
        <tr>
          <th data-i18n="maintenance_date">Maintenance date</th>
          <th data-i18n="vehicle">Vehicle</th>
          <th data-i18n="th_driver">Driver</th>
          <th data-i18n="maintenance_price">Price (KWD)</th>
          <th data-i18n="invoice_number_short">Invoice #</th>
          <th data-i18n="next_maintenance_date">Next date</th>
          <th data-i18n="note">Note</th>
          <th data-i18n="th_time">Recorded at</th>
        </tr>
        </thead>
        <tbody id="maintenanceTableBody"></tbody>
      </table>
    </div>

    <div id="maintenanceSummaryBlock" class="mt-md" style="display:none;">
      <div class="panel-section-title" data-i18n="maintenance_summary_title">Maintenance budget summary</div>
      <div class="panel-subtitle" data-i18n="maintenance_summary_subtitle">Filter by day or month, then download totals.</div>
      <div class="toolbar">
        <div>
          <label data-i18n="from_date">From date</label>
          <input id="maintenanceSummaryFrom" type="date" />
        </div>
        <div>
          <label data-i18n="to_date">To date</label>
          <input id="maintenanceSummaryTo" type="date" />
        </div>
        <div>
          <label data-i18n="vehicle">Vehicle</label>
          <select id="maintenanceSummaryVehicleSelect"></select>
        </div>
        <div style="display:flex;gap:0.4rem;flex-wrap:wrap;">
          <button id="maintenanceSummaryApplyBtn" class="btn btn-secondary" data-i18n="apply_filters">Apply filters</button>
          <button id="maintenanceExportBtn" class="btn btn-primary" data-i18n="maintenance_export">Export CSV</button>
        </div>
      </div>

      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-label" data-i18n="total_spent">Total spent (KWD)</div>
          <div id="maintenanceSummaryTotal" class="summary-value">0</div>
        </div>
        <div class="summary-card">
          <div class="summary-label" data-i18n="records_count">Records</div>
          <div id="maintenanceSummaryCount" class="summary-value">0</div>
        </div>
      </div>

      <div class="table-wrapper mt-sm">
        <table>
          <thead>
          <tr>
            <th data-i18n="vehicle">Vehicle</th>
            <th data-i18n="th_total_cost">Total cost</th>
          </tr>
          </thead>
          <tbody id="maintenanceSummaryTableBody"></tbody>
        </table>
      </div>
    </div>
  </section>

</main>

<script>
  /**
   * ✅ UPDATED FOR YOUR NEW BACKEND:
   * - API_BASE supports both same-origin (/api) AND external backend via ?api=... or localStorage
   * - item update requires branchId, and edit select uses id::branchId (unique key)
   * - main storage branch id supports override via ?storage=B001 or localStorage (matches env MAIN_STORAGE_BRANCH_ID)
   */

  // ---------- API + Main Storage config ----------
  function normalizeBase(url) {
    if (!url) return "";
    return String(url).replace(/\/+$/, "");
  }

  function getApiBase() {
    // priority: query string ?api= -> localStorage -> same-origin (/api)
    const p = new URLSearchParams(location.search);
    const q = p.get("api");
    if (q) {
      const full = normalizeBase(q);
      localStorage.setItem("API_BASE_OVERRIDE", full);
      return full;
    }
    const saved = localStorage.getItem("API_BASE_OVERRIDE");
    if (saved) return normalizeBase(saved);
    return "/api";
  }

  function getMainStorageOverride() {
    // priority: query string ?storage= -> localStorage -> fallback "B001"
    const p = new URLSearchParams(location.search);
    const q = p.get("storage");
    if (q) {
      localStorage.setItem("MAIN_STORAGE_BRANCH_ID", q);
      return q;
    }
    return localStorage.getItem("MAIN_STORAGE_BRANCH_ID") || "B001";
  }

  const API_BASE = getApiBase();
  const MAIN_STORAGE_BRANCH_ID = getMainStorageOverride();

  // ---------- i18n ----------
  const i18n = {
    en: {
      app_title: "Storage Manage Method",
      app_subtitle: "Branch → Storage orders, drivers & analytics",
      logout: "Logout",
      signin_title: "Sign in",
      signin_btn: "Sign in",
      username: "Username",
      password: "Password",

      inventory_title: "Inventory",
      inventory_subtitle: "Admin & Manager can add items and manage inventory.",
      view_inventory_list: "View inventory list",
      select_list: "Select list",
      search_items: "Search items",
      refresh: "Refresh",
      menu_inventory: "Inventory",
      menu_requests: "Requests",
      menu_transfers: "Transfers",
      menu_driver: "Driver",
      menu_movements: "Movements",
      menu_analytics: "Analytics",
      menu_vehicles: "Vehicles",
      menu_users: "Users",
      phone_mode_on: "Phone mode",
      phone_mode_off: "Phone mode off",
      toast_new_requests: "New requests: {count}",
      toast_new_assigned: "New assigned to you: {count}",

      th_id: "ID",
      th_order: "Order #",
      th_created_at: "Created",
      th_delivered_at: "Delivered",
      th_name: "Name",
      th_branch: "Branch",
      th_qty: "Qty",
      th_min: "Min",
      th_unit_cost: "Unit cost",
      th_value: "Value",
      th_item: "Item",
      th_from: "From",
      th_to: "To",
      th_priority: "Priority",
      th_eta: "ETA",
      th_status: "Status",
      th_ready: "Ready",
      th_by: "By",
      th_driver: "Driver",
      th_note: "Note",
      th_image: "Image",
      th_action: "Action",
      th_user: "User",
      th_time: "Time",
      th_requested_by: "Requested by",
      th_total_qty: "Total qty",
      th_total_cost: "Total cost",
      th_access: "Access",

      selected_list_value: "Selected list value (KWD)",
      main_storage_value: "Main Storage value (KWD)",
      restock_alerts: "Restock alerts (Main Storage)",
      add_update_items: "Add / update items (Admin & Manager)",
      search_item_to_edit: "Search item to edit",
      select_item_to_edit: "Select item to edit (optional)",
      update_item: "Update item",
      delete_item: "Cancel item",
      item_type: "Item type",
      item_type_regular: "Regular (ITEM)",
      item_type_thread: "Thread (THR)",
      item_id_auto: "Item ID (auto)",
      item_branch_where: "Branch (where item lives)",
      base_quantity: "Base quantity",
      minimum_quantity: "Minimum quantity (alert)",
      save_item: "Save item",
      items_per_page: "Items per page",
      page_word: "Page",
      of_word: "of",
      showing: "Showing",
      no_items: "No items",

      users_branches: "Users & branches",
      users_subtitle: "Admin can create, edit and delete users and assign them to branches.",
      create_user: "Create user",
      create_branch: "Create branch",
      branch_name: "Branch name",
      create_branch_btn: "Create branch",
      branches_list: "Branches list",
      role: "Role",
      create_user_btn: "Create user",
      users_list: "Users list",
      edit_delete_user: "Edit / delete user",
      select_user: "Select user",
      password_keep: "Password (leave empty to keep)",
      save_changes: "Save changes",
      delete_user: "Delete user",
      allowed_branches: "Allowed branches (Supervisor)",
      allowed_scope: "Allowed scope (Supervisor)",
      scope_own: "Own branch only",
      scope_multiple: "Multiple branches",
      scope_all: "All branches",

      branch_requests: "Branch requests",
      requests_subtitle: "Staff / Supervisor / Manager / Admin request items from Main Storage to their own branch.",
      new_request: "New request",
      from_storage: "From storage",
      to_branch: "To branch",
      item_from_storage: "Item (from storage)",
      search_items_placeholder: "Type to filter items",
      search_item_edit_placeholder: "Type to search items",
      no_items_match_search: "No items match your search.",
      delete_item_confirm: "Cancel this item?",
      item_deleted: "Item canceled.",
      quantity: "Quantity",
      priority: "Priority",
      priority_normal: "Normal",
      priority_urgent_today: "Urgent (today)",
      priority_urgent: "Urgent",
      urgent_note: "Urgent note",
      urgent_note_label: "Urgent",
      note: "Note",
      request_image: "Request image",
      view_image: "View",
      no_image: "No image available.",
      create_request: "Create request",
      requests_for_my_branch: "Requests for my branch",
      transfer_title: "Bags transfer",
      transfer_subtitle: "Request bags transfer between branches. Supervisor assigns destination. Drivers deliver.",
      new_transfer: "New transfer",
      transfer_qty: "Quantity of bags",
      transfer_image: "Transfer image",
      create_transfer: "Create transfer",
      active_transfers: "Active transfers",
      transfer_history: "Transfer history",
      driver_transfers: "Driver transfers",
      requests_history: "Requests history",
      filter_by_branch: "Filter by branch",
      assign: "Assign",
      assigned_to_you: "Assigned to you",
      unassigned_requests: "Unassigned requests",
      take_request: "Take request",
      set_eta: "Set ETA",
      eta_select: "Select ETA",
      eta_3h: "3 hours",
      eta_tomorrow: "Tomorrow",
      eta_custom: "Custom time",
      eta_select_msg: "Select a delivery ETA option.",
      eta_invalid_msg: "Invalid delivery time.",

      driver_deliveries: "Driver requests",
      driver_subtitle: "Drivers see pending requests, can take any request and set ETA (staff confirm receipt).",

      manual_movements: "Manual stock movements",
      movements_subtitle: "Only Admin & Manager can record IN / OUT movements that change stock.",
      type: "Type",
      save_movement: "Save movement",
      recent_movements: "Recent movements",

      analytics_title: "Budget & usage dashboard",
      analytics_subtitle: "Automatic spend calculation from delivered requests (qty × item price), filter by date and branch.",
      from_date: "From date",
      to_date: "To date",
      apply_filters: "Apply filters",
      total_spent: "Total spent (KWD)",
      delivered_requests: "Delivered requests",
      order_prefix: "Order #",
      total_quantity: "Total quantity",
      most_ordered: "Most ordered items (by cost)",
      export_monthly_report: "Export monthly report",
      report_date_required: "Select both dates before exporting.",
      no_orders_in_range: "No delivered orders in this range.",

      vehicle_reminders: "Vehicle reminders",
      vehicle_subtitle: "Oil change, meter, yearly renewal. Admin/Manager can add; Driver can mark done.",
      vehicle_assignments: "Vehicle assignments",
      vehicle_assignments_subtitle: "Assign drivers or hand over vehicles between drivers.",
      assign_vehicle_title: "Assign / hand over vehicle",
      assign_vehicle_btn: "Assign vehicle",
      assigned_at: "Assigned at",
      assigned_by: "Assigned by",
      no_assignments: "No vehicle assignments yet.",
      add_vehicle: "Add vehicle (Admin/Manager)",
      vehicle_name: "Vehicle name",
      plate_optional: "Plate (optional)",
      add_vehicle_btn: "Add vehicle",
      manage_vehicles_title: "Edit / delete vehicles (Admin/Manager)",
      select_vehicle_edit: "Select vehicle",
      update_vehicle_btn: "Update vehicle",
      delete_vehicle_btn: "Delete vehicle",
      add_reminder: "Add reminder (Admin/Manager)",
      vehicle: "Vehicle",
      due_date: "Due date",
      due_odometer: "Due odometer (km)",
      add_reminder_btn: "Add reminder",
      reminders: "Reminders",
      filter: "Filter",
      due: "Due",
      odometer: "Odometer",
      maintenance_records: "Maintenance records",
      maintenance_records_subtitle: "Admin/Manager record maintenance details. Drivers can view only.",
      maintenance_date: "Maintenance date",
      next_maintenance_date: "Next maintenance date",
      maintenance_price: "Maintenance cost (KWD)",
      invoice_number: "Invoice number",
      invoice_number_short: "Invoice #",
      maintenance_place: "Place / workshop (optional)",
      store_name: "Store (optional)",
      save_maintenance: "Save maintenance record",
      maintenance_history: "Maintenance history",
      maintenance_history_subtitle: "Visible to Admin/Manager and assigned drivers (view only).",
      maintenance_summary_title: "Maintenance budget summary",
      maintenance_summary_subtitle: "Filter by date or vehicle and export totals.",
      maintenance_required_fields: "Vehicle, maintenance date, price and invoice are required.",
      no_maintenance_records: "No maintenance records yet.",
      maintenance_saved: "Maintenance record saved.",
      records_count: "Records",
      maintenance_export: "Export maintenance CSV",
      all_vehicles: "All vehicles",
      main_storage: "Main Storage",
      no_items_in: "No items in",
      no_low_stock: "No low stock alerts in Main Storage.",

      pending: "pending",
      assigned: "assigned",
      in_transit: "in transit",
      delivered: "delivered",
      deliver: "Receive",

      enter_user_pass: "Enter username and password.",
      login_failed: "Login failed",
      load_state_failed: "Load state failed",
      next_item_failed: "Failed to get next item id",

      only_admin_create_users: "Only admin can create users.",
      branch_name_required: "Branch name required.",
      name_password_required: "Name and password required.",
      select_user_first: "Select a user first.",
      delete_user_confirm: "Delete this user?",
      user_updated: "User updated.",
      user_deleted: "User deleted.",

      only_admin_mgr_create_items: "Only admin/manager can create items.",
      item_name_required: "Item name required.",

      only_admin_mgr_movements: "Only admin/manager can record movements.",
      item_qty_required: "Item and quantity required.",

      drivers_cannot_create: "Drivers cannot create requests.",
      user_no_branch: "Your user is not assigned to a branch. Ask admin.",

      mark_delivered_confirm: "Confirm receipt of this request?",
      no_requests_yet: "No requests yet.",
      no_pending_requests: "No pending requests.",
      no_history_requests: "No delivered requests yet.",
      delete_request: "Delete request",
      delete_request_confirm: "Delete this pending request?",
      no_transfers_yet: "No transfers yet.",
      no_transfer_history: "No transfer history yet.",
      ready: "Ready",
      not_ready: "Not ready",

      no_movements: "No movements recorded.",
      no_delivered_period: "No delivered requests in this period.",

      vehicle_name_required_msg: "Vehicle name required",
      select_vehicle_msg: "Select a vehicle",
      select_branch: "Select a branch",
      select_driver_msg: "Select a driver",
      only_admin_mgr_assign: "Only admins/managers or drivers with the vehicle can assign it.",
      handover_not_allowed: "Only admin, manager, or the assigned driver can hand over a vehicle.",
      drivers_only_their_cars: "Drivers can only hand over cars currently assigned to them.",
      select_other_driver: "Select another driver.",
      vehicle_assigned_success: "Vehicle assignment saved.",
      no_reminders: "No reminders.",
      due_soon: "Due soon",
      overdue: "Overdue",
      delete_vehicle_confirm: "Delete this vehicle? Assignments, reminders and maintenance records will be removed.",
      vehicle_updated: "Vehicle updated.",
      vehicle_deleted: "Vehicle deleted.",

      reopen: "Re-open",
      done: "Done",
      delete_reminder: "Delete",
      delete_reminder_confirm: "Delete this reminder?"
    },
    ar: {
      app_title: "إدارة المخزون",
      app_subtitle: "الفروع → طلبات المخزن، السائقين والتحليلات",
      logout: "تسجيل خروج",
      signin_title: "تسجيل الدخول",
      signin_btn: "دخول",
      username: "اسم المستخدم",
      password: "كلمة المرور",

      inventory_title: "المخزون",
      inventory_subtitle: "المدير والمشرف يمكنهم إضافة الأصناف وإدارة المخزون.",
      view_inventory_list: "عرض قائمة المخزون",
      select_list: "اختر القائمة",
      search_items: "بحث عن صنف",
      refresh: "تحديث",
      menu_inventory: "المخزون",
      menu_requests: "الطلبات",
      menu_transfers: "النقل",
      menu_driver: "السائق",
      menu_movements: "الحركات",
      menu_analytics: "التقارير",
      menu_vehicles: "المركبات",
      menu_users: "المستخدمون",
      phone_mode_on: "وضع الهاتف",
      phone_mode_off: "إيقاف وضع الهاتف",
      toast_new_requests: "طلبات جديدة: {count}",
      toast_new_assigned: "طلبات جديدة لك: {count}",

      th_id: "الرقم",
      th_order: "رقم الطلب",
      th_created_at: "تاريخ الإنشاء",
      th_delivered_at: "تاريخ التسليم",
      th_name: "الاسم",
      th_branch: "الفرع",
      th_qty: "الكمية",
      th_min: "الحد الأدنى",
      th_unit_cost: "سعر الوحدة",
      th_value: "القيمة",
      th_item: "الصنف",
      th_from: "من",
      th_to: "إلى",
      th_priority: "الأولوية",
      th_eta: "وقت التسليم",
      th_status: "الحالة",
      th_ready: "الجاهزية",
      th_by: "بواسطة",
      th_driver: "السائق",
      th_note: "ملاحظة",
      th_image: "صورة",
      th_action: "إجراء",
      th_user: "المستخدم",
      th_time: "الوقت",
      th_requested_by: "طالب الطلب",
      th_total_qty: "إجمالي الكمية",
      th_total_cost: "إجمالي التكلفة",
      th_access: "الصلاحية",

      selected_list_value: "قيمة القائمة المختارة (د.ك)",
      main_storage_value: "قيمة المخزن الرئيسي (د.ك)",
      restock_alerts: "تنبيهات إعادة التوريد (المخزن الرئيسي)",
      add_update_items: "إضافة / تعديل الأصناف (مدير/مشرف)",
      search_item_to_edit: "ابحث عن صنف للتعديل",
      select_item_to_edit: "اختر صنف للتعديل (اختياري)",
      update_item: "تحديث الصنف",
      delete_item: "إلغاء الصنف",
      item_type: "نوع الصنف",
      item_type_regular: "عادي (ITEM)",
      item_type_thread: "خيط (THR)",
      item_id_auto: "رقم الصنف (تلقائي)",
      item_branch_where: "الفرع (مكان الصنف)",
      base_quantity: "الكمية الأساسية",
      minimum_quantity: "الحد الأدنى (تنبيه)",
      save_item: "حفظ الصنف",

      users_branches: "المستخدمون والفروع",
      users_subtitle: "المشرف يمكنه إنشاء وتعديل وحذف المستخدمين وربطهم بالفروع.",
      create_user: "إنشاء مستخدم",
      create_branch: "إنشاء فرع",
      branch_name: "اسم الفرع",
      create_branch_btn: "إنشاء فرع",
      branches_list: "قائمة الفروع",
      role: "الدور",
      create_user_btn: "إنشاء مستخدم",
      users_list: "قائمة المستخدمين",
      edit_delete_user: "تعديل / حذف مستخدم",
      select_user: "اختر مستخدم",
      password_keep: "كلمة المرور (اتركها فارغة للإبقاء)",
      save_changes: "حفظ التعديل",
      delete_user: "حذف المستخدم",
      allowed_branches: "الفروع المسموحة (للمراقب)",
      allowed_scope: "نطاق الصلاحية (للمراقب)",
      scope_own: "فرع واحد فقط",
      scope_multiple: "عدة فروع",
      scope_all: "كل الفروع",

      branch_requests: "طلبات الفروع",
      requests_subtitle: "الموظف/المدير/المشرف/المراقب يطلبون أصناف من المخزن الرئيسي إلى فرعهم.",
      new_request: "طلب جديد",
      from_storage: "من المخزن",
      to_branch: "إلى الفرع",
      item_from_storage: "الصنف (من المخزن)",
      search_items_placeholder: "اكتب بعض الحروف لتصفية الأصناف",
      search_item_edit_placeholder: "اكتب للبحث عن الأصناف",
      no_items_match_search: "لا توجد أصناف مطابقة لبحثك.",
      delete_item_confirm: "هل تريد إلغاء هذا الصنف؟",
      item_deleted: "تم إلغاء الصنف.",
      quantity: "الكمية",
      priority: "الأولوية",
      priority_normal: "عادية",
      priority_urgent_today: "عاجل (اليوم)",
      priority_urgent: "عاجل",
      urgent_note: "ملاحظة عاجلة",
      urgent_note_label: "عاجل",
      note: "ملاحظة",
      request_image: "صورة الطلب",
      view_image: "عرض",
      no_image: "لا توجد صورة.",
      create_request: "إنشاء طلب",
      requests_for_my_branch: "طلبات فرعي",
      transfer_title: "نقل الأكياس",
      transfer_subtitle: "طلب نقل الأكياس بين الفروع. المشرف يحدد الوجهة والسائق يسلّم.",
      new_transfer: "طلب نقل جديد",
      transfer_qty: "عدد الأكياس",
      transfer_image: "صورة النقل",
      create_transfer: "إنشاء نقل",
      active_transfers: "عمليات النقل الحالية",
      transfer_history: "سجل نقل الأكياس",
      driver_transfers: "نقل الأكياس للسائق",
      requests_history: "سجل الطلبات",
      filter_by_branch: "تصفية حسب الفرع",
      assign: "تعيين",
      assigned_to_you: "مُعيّن لك",
      unassigned_requests: "غير مُعيّن",
      take_request: "استلام الطلب",
      set_eta: "تحديد الوقت",
      eta_select: "اختر وقت التسليم",
      eta_3h: "بعد 3 ساعات",
      eta_tomorrow: "غدًا",
      eta_custom: "وقت محدد",
      eta_select_msg: "اختر وقت التسليم.",
      eta_invalid_msg: "وقت غير صحيح.",

      driver_deliveries: "طلبات السائق",
      driver_subtitle: "السائق يرى الطلبات المعلّقة ويمكنه استلام الطلب وتحديد وقت التسليم (تأكيد الاستلام من الموظف).",

      manual_movements: "حركات مخزون يدوية",
      movements_subtitle: "فقط المشرف/المدير يمكنهم تسجيل إدخال/إخراج يؤثر على المخزون.",
      type: "النوع",
      save_movement: "حفظ الحركة",
      recent_movements: "آخر الحركات",

      analytics_title: "لوحة الميزانية والاستخدام",
      analytics_subtitle: "حساب الصرف تلقائيًا من الطلبات المسلّمة (الكمية × السعر)، مع فلترة بالتاريخ والفرع.",
      from_date: "من تاريخ",
      to_date: "إلى تاريخ",
      apply_filters: "تطبيق الفلاتر",
      total_spent: "إجمالي الصرف (د.ك)",
      delivered_requests: "الطلبات المسلّمة",
      order_prefix: "طلب #",
      total_quantity: "إجمالي الكمية",
      most_ordered: "الأكثر طلبًا (حسب التكلفة)",

      vehicle_reminders: "تنبيهات المركبات",
      vehicle_subtitle: "تغيير زيت، عداد، تجديد سنوي. المدير/المشرف يضيفون؛ السائق يعلّم منجز.",
      vehicle_assignments: "تسليم المركبات",
      vehicle_assignments_subtitle: "تعيين السائقين وتسليم المركبات بينهم.",
      assign_vehicle_title: "تسليم / نقل مركبة",
      assign_vehicle_btn: "تسليم المركبة",
      assigned_at: "تاريخ التسليم",
      assigned_by: "سُلّمت بواسطة",
      no_assignments: "لا توجد مركبات مسلّمة بعد.",
      add_vehicle: "إضافة مركبة (مدير/مشرف)",
      vehicle_name: "اسم المركبة",
      plate_optional: "اللوحة (اختياري)",
      add_vehicle_btn: "إضافة مركبة",
      manage_vehicles_title: "تعديل / حذف المركبات (مدير/مشرف)",
      select_vehicle_edit: "اختر مركبة",
      update_vehicle_btn: "تحديث المركبة",
      delete_vehicle_btn: "حذف المركبة",
      add_reminder: "إضافة تذكير (مدير/مشرف)",
      vehicle: "المركبة",
      due_date: "تاريخ الاستحقاق",
      due_odometer: "عداد الاستحقاق (كم)",
      add_reminder_btn: "إضافة تذكير",
      reminders: "التذكيرات",
      filter: "فلتر",
      due: "الاستحقاق",
      odometer: "العداد",
      maintenance_records: "سجلات الصيانة",
      maintenance_records_subtitle: "تسجل الإدارة تفاصيل الصيانة، والسائق للعرض فقط.",
      maintenance_date: "تاريخ الصيانة",
      next_maintenance_date: "تاريخ الصيانة التالية",
      maintenance_price: "تكلفة الصيانة (د.ك)",
      invoice_number: "رقم الفاتورة",
      invoice_number_short: "فاتورة #",
      maintenance_place: "الموقع / الورشة (اختياري)",
      store_name: "المتجر (اختياري)",
      save_maintenance: "حفظ سجل الصيانة",
      maintenance_history: "سجل الصيانة",
      maintenance_history_subtitle: "يظهر للإدارة وللسائق المسؤول عن المركبة (عرض فقط).",
      maintenance_summary_title: "ملخص ميزانية الصيانة",
      maintenance_summary_subtitle: "رشّح حسب التاريخ أو المركبة ثم صدّر النتائج.",
      maintenance_required_fields: "يجب إدخال المركبة وتاريخ الصيانة والتكلفة ورقم الفاتورة.",
      no_maintenance_records: "لا توجد سجلات صيانة بعد.",
      maintenance_saved: "تم حفظ سجل الصيانة.",
      records_count: "عدد السجلات",
      maintenance_export: "تصدير ملف الصيانة",
      all_vehicles: "جميع المركبات",

      main_storage: "المخزن الرئيسي",
      no_items_in: "لا توجد أصناف في",
      no_low_stock: "لا توجد تنبيهات نقص في المخزن الرئيسي.",

      pending: "قيد الانتظار",
      assigned: "تم التعيين",
      in_transit: "في الطريق",
      delivered: "تم التسليم",
      deliver: "استلام",

      enter_user_pass: "اكتب اسم المستخدم وكلمة المرور.",
      login_failed: "فشل تسجيل الدخول",
      load_state_failed: "فشل تحميل البيانات",
      next_item_failed: "فشل جلب رقم الصنف التالي",

      only_admin_create_users: "فقط المشرف يمكنه إنشاء مستخدمين.",
      branch_name_required: "اسم الفرع مطلوب.",
      name_password_required: "الاسم وكلمة المرور مطلوبة.",
      select_user_first: "اختر مستخدم أولاً.",
      delete_user_confirm: "حذف هذا المستخدم؟",
      user_updated: "تم تحديث المستخدم.",
      user_deleted: "تم حذف المستخدم.",

      only_admin_mgr_create_items: "فقط المشرف/المدير يمكنهم إضافة أصناف.",
      item_name_required: "اسم الصنف مطلوب.",

      only_admin_mgr_movements: "فقط المشرف/المدير يمكنهم تسجيل الحركات.",
      item_qty_required: "الصنف والكمية مطلوبة.",

      drivers_cannot_create: "السائق لا يستطيع إنشاء طلب.",
      user_no_branch: "المستخدم غير مرتبط بفرع. اطلب من المشرف.",

      mark_delivered_confirm: "تأكيد استلام هذا الطلب؟",
      no_requests_yet: "لا توجد طلبات بعد.",
      no_pending_requests: "لا توجد طلبات معلّقة.",
      no_history_requests: "لا توجد طلبات مسلّمة بعد.",
      delete_request: "حذف الطلب",
      delete_request_confirm: "هل تريد حذف هذا الطلب المعلّق؟",
      no_transfers_yet: "لا توجد عمليات نقل بعد.",
      no_transfer_history: "لا يوجد سجل نقل بعد.",
      ready: "جاهز",
      not_ready: "غير جاهز",

      no_movements: "لا توجد حركات مسجلة.",
      no_delivered_period: "لا توجد طلبات مسلّمة في هذه الفترة.",

      vehicle_name_required_msg: "اسم المركبة مطلوب",
      select_vehicle_msg: "اختر مركبة",
      select_branch: "اختر فرعًا",
      select_driver_msg: "اختر السائق",
      only_admin_mgr_assign: "فقط المدير أو المشرف أو السائق المسؤول يمكنه تسليم المركبة.",
      handover_not_allowed: "لا يمكن تسليم المركبة إلا للمدير أو المشرف أو السائق المعين عليه.",
      drivers_only_their_cars: "يمكن للسائق تسليم المركبات التي هي تحت عهدته فقط.",
      select_other_driver: "اختر سائقاً آخر.",
      vehicle_assigned_success: "تم حفظ تسليم المركبة.",
      no_reminders: "لا توجد تذكيرات.",
      due_soon: "قريب الاستحقاق",
      overdue: "متأخر",
      delete_vehicle_confirm: "حذف هذه المركبة؟ سيتم حذف التسليمات والتنبيهات وسجلات الصيانة المرتبطة بها.",
      vehicle_updated: "تم تحديث المركبة.",
      vehicle_deleted: "تم حذف المركبة.",

      reopen: "إعادة فتح",
      done: "تم",
      delete_reminder: "حذف",
      delete_reminder_confirm: "حذف هذا التذكير؟"
    }
  };

  let currentLang = localStorage.getItem("lang") || "en";

  function t(key) {
    return (i18n[currentLang] && i18n[currentLang][key]) || i18n.en[key] || key;
  }

  function applyTranslations() {
    document.documentElement.lang = currentLang;
    document.documentElement.dir = (currentLang === "ar") ? "rtl" : "ltr";

    document.querySelectorAll("[data-i18n]").forEach(el => {
      const key = el.getAttribute("data-i18n");
      el.textContent = t(key);
    });

    const roleOptions = [
      { value: "staff", en: "Staff", ar: "موظف" },
      { value: "supervisor", en: "Supervisor", ar: "مراقب" },
      { value: "manager", en: "Manager", ar: "مدير" },
      { value: "driver", en: "Driver", ar: "سائق" },
      { value: "admin", en: "Admin", ar: "مشرف" }
    ];
    const roleSelects = [document.getElementById("newUserRole"), document.getElementById("editUserRole")].filter(Boolean);
    roleSelects.forEach(sel => {
      Array.from(sel.options).forEach(opt => {
        const ro = roleOptions.find(r => r.value === opt.value);
        if (ro) opt.textContent = (currentLang === "ar") ? ro.ar : ro.en;
      });
    });

    const movementTypeSelect = document.getElementById("movementTypeSelect");
    if (movementTypeSelect) {
      const inOpt = movementTypeSelect.querySelector('option[value="IN"]');
      const outOpt = movementTypeSelect.querySelector('option[value="OUT"]');
      if (inOpt) inOpt.textContent = (currentLang === "ar") ? "إدخال (زيادة)" : "IN (add)";
      if (outOpt) outOpt.textContent = (currentLang === "ar") ? "إخراج (نقص)" : "OUT (remove)";
    }

    const remFilterSelect = document.getElementById("remFilterSelect");
    if (remFilterSelect) {
      const attentionOpt = remFilterSelect.querySelector('option[value="attention"]');
      const openOpt = remFilterSelect.querySelector('option[value="open"]');
      const allOpt = remFilterSelect.querySelector('option[value="all"]');
      const doneOpt = remFilterSelect.querySelector('option[value="done"]');
      if (attentionOpt) attentionOpt.textContent = (currentLang === "ar") ? "تنبيه" : "Attention";
      if (openOpt) openOpt.textContent = (currentLang === "ar") ? "مفتوح" : "Open";
      if (allOpt) allOpt.textContent = (currentLang === "ar") ? "الكل" : "All";
      if (doneOpt) doneOpt.textContent = (currentLang === "ar") ? "منجز" : "Done";
    }

    const remTypeSelect = document.getElementById("remTypeSelect");
    if (remTypeSelect) {
      const oil = remTypeSelect.querySelector('option[value="OIL_CHANGE"]');
      const meter = remTypeSelect.querySelector('option[value="METER"]');
      const yearly = remTypeSelect.querySelector('option[value="YEARLY_RENEW"]');
      const other = remTypeSelect.querySelector('option[value="OTHER"]');
      if (oil) oil.textContent = (currentLang === "ar") ? "تغيير زيت" : "Oil change";
      if (meter) meter.textContent = (currentLang === "ar") ? "عداد" : "Meter";
      if (yearly) yearly.textContent = (currentLang === "ar") ? "تجديد سنوي" : "Yearly renewal";
      if (other) other.textContent = (currentLang === "ar") ? "أخرى" : "Other";
    }

    const langBtn = document.getElementById("langBtn");
    if (langBtn) langBtn.textContent = (currentLang === "ar") ? "EN" : "AR";

    const requestSearchInput = document.getElementById("requestItemSearchInput");
    if (requestSearchInput) requestSearchInput.placeholder = t("search_items_placeholder");
    const inventorySearchInput = document.getElementById("inventorySearchInput");
    if (inventorySearchInput) inventorySearchInput.placeholder = t("search_items_placeholder");

    const editSearchInput = document.getElementById("itemEditSearchInput");
    if (editSearchInput) editSearchInput.placeholder = t("search_item_edit_placeholder");
  }
  // ---------- end i18n ----------

  const state = {
    user: null,
    branches: [],
    users: [],
    items: [],
    movements: [],
    budgets: [],
    requests: [],
    transfers: [],
    vehicles: [],
    vehicleReminders: [],
    carAssignments: [],
    carMaintenances: [],
    inventoryPage: 1,
    inventoryPageSize: 40,
    requestImageData: "",
    transferImageData: "",
    activePageId: "",
    phoneMode: false,
    lastNotifiedCount: 0
  };
  const SESSION_STORAGE_KEY = "APP_SESSION";
  const PHONE_MODE_KEY = "PHONE_MODE";
  const REQ_SEEN_KEY_PREFIX = "REQ_SEEN_AT_";
  let sessionLogoutTimer = null;
  let audioCtx = null;
  const POLL_INTERVAL_MS = 10000;
  let pollTimer = null;

  function applyPhoneMode() {
    document.body.classList.toggle("phone-mode", !!state.phoneMode);
    const phoneBtn = document.getElementById("phoneModeBtn");
    if (phoneBtn && state.user && state.user.role === "driver") {
      phoneBtn.textContent = state.phoneMode ? t("phone_mode_off") : t("phone_mode_on");
    }
    localStorage.setItem(PHONE_MODE_KEY, state.phoneMode ? "1" : "0");
  }

  function saveSession(user) {
    localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify({ user }));
    if (sessionLogoutTimer) {
      clearTimeout(sessionLogoutTimer);
      sessionLogoutTimer = null;
    }
    return null;
  }

  function loadSession() {
    const raw = localStorage.getItem(SESSION_STORAGE_KEY);
    if (!raw) return null;
    try {
      const parsed = JSON.parse(raw);
      if (!parsed || !parsed.user) return null;
      return { user: parsed.user };
    } catch {
      localStorage.removeItem(SESSION_STORAGE_KEY);
      return null;
    }
  }

  function clearSession() {
    localStorage.removeItem(SESSION_STORAGE_KEY);
    if (sessionLogoutTimer) {
      clearTimeout(sessionLogoutTimer);
      sessionLogoutTimer = null;
    }
  }

  function scheduleSessionLogout(expiresAt) {
    if (!expiresAt) return;
    if (sessionLogoutTimer) clearTimeout(sessionLogoutTimer);
    const ms = Math.max(0, expiresAt - Date.now());
    sessionLogoutTimer = setTimeout(() => {
      logout();
    }, ms);
  }

  function escapeHtml(s) {
    return String(s || "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function getBranchName(id) {
    const b = state.branches.find((x) => x.id === id);
    return b ? b.name : id || "";
  }
  function getUserName(id) {
    const u = state.users.find((x) => x.id === id);
    return u ? u.name : id || "";
  }
  function getUserRoleById(id) {
    const u = state.users.find((x) => x.id === id);
    return u ? u.role : "";
  }
  function getSupervisorAllowedBranches(user) {
    if (!user || user.role !== "supervisor") return [];
    const scope = getSupervisorAllowedScope(user);
    if (scope === "all") return (state.branches || []).map((b) => b.id);
    if (scope === "multiple") {
      const list = Array.isArray(user.allowedBranchIds) ? user.allowedBranchIds.filter(Boolean) : [];
      if (list.length) return list;
    }
    return user.branchId ? [user.branchId] : [];
  }
  function getSupervisorAllowedScope(user) {
    if (!user || user.role !== "supervisor") return "own";
    return user.allowedBranchScope || "own";
  }
  function getSupervisorAccessLabel(user) {
    if (!user || user.role !== "supervisor") return "-";
    const scope = getSupervisorAllowedScope(user);
    if (scope === "all") return t("scope_all");
    if (scope === "multiple") {
      const names = getSupervisorAllowedBranches(user).map((id) => getBranchName(id));
      return names.length ? names.join(", ") : t("scope_multiple");
    }
    return user.branchId ? getBranchName(user.branchId) : t("scope_own");
  }
  function applySupervisorAccessUI(role, scope, branchId, allowedIds) {
    const scopeSel = document.getElementById("editUserAllowedScope");
    const allowedSel = document.getElementById("editUserAllowedBranches");
    const scopeWrap = scopeSel ? scopeSel.closest("div") : null;
    const allowedWrap = allowedSel ? allowedSel.closest("div") : null;

    const isSupervisor = role === "supervisor";
    if (scopeWrap) scopeWrap.style.display = isSupervisor ? "block" : "none";
    if (allowedWrap) allowedWrap.style.display = isSupervisor ? "block" : "none";

    if (!isSupervisor) {
      if (allowedSel) {
        allowedSel.disabled = true;
        Array.from(allowedSel.options).forEach((opt) => { opt.selected = false; });
      }
      return;
    }

    const nextScope = scope || "own";
    if (scopeSel) scopeSel.value = nextScope;

    if (allowedSel) {
      if (nextScope === "multiple") {
        allowedSel.disabled = false;
        const allowedSet = new Set(allowedIds || []);
        Array.from(allowedSel.options).forEach((opt) => {
          opt.selected = allowedSet.has(opt.value);
        });
      } else if (nextScope === "all") {
        allowedSel.disabled = true;
        Array.from(allowedSel.options).forEach((opt) => { opt.selected = false; });
      } else {
        allowedSel.disabled = true;
        Array.from(allowedSel.options).forEach((opt) => {
          opt.selected = branchId ? opt.value === branchId : false;
        });
      }
    }
  }
  function getDriverOptionsHtml(selectedId) {
    const drivers = (state.users || []).filter((u) => u.role === "driver");
    const placeholder = currentLang === "ar" ? "اختر سائق" : "Select driver";
    let html = `<option value="">${escapeHtml(placeholder)}</option>`;
    drivers.forEach((d) => {
      const sel = d.id === selectedId ? " selected" : "";
      html += `<option value="${escapeHtml(d.id)}"${sel}>${escapeHtml(d.name)}</option>`;
    });
    return html;
  }
  function getBranchOptionsHtml(selectedId) {
    const placeholder = currentLang === "ar" ? "اختر فرع" : "Select branch";
    let html = `<option value="">${escapeHtml(placeholder)}</option>`;
    (state.branches || []).forEach((b) => {
      const sel = b.id === selectedId ? " selected" : "";
      html += `<option value="${escapeHtml(b.id)}"${sel}>${escapeHtml(b.name)}</option>`;
    });
    return html;
  }
  function getItemById(id) {
    return state.items.find((x) => x.id === id);
  }
  function getItemTypeFromId(id) {
    if (!id) return "ITEM";
    return String(id).toUpperCase().startsWith("THR-") ? "THR" : "ITEM";
  }
  function formatDateTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }
  function buildRequestOrderMap(requests) {
    const map = new Map();
    const byBranch = new Map();
    (requests || []).forEach((r) => {
      const key = r.toBranchId || "";
      if (!byBranch.has(key)) byBranch.set(key, []);
      byBranch.get(key).push(r);
    });
    byBranch.forEach((list) => {
      list.sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0));
      list.forEach((r, idx) => {
        map.set(r.id, idx + 1);
      });
    });
    return map;
  }
  function getRequestOrderLabel(req, orderMap) {
    const n = Number.isFinite(Number(req.orderNo)) ? Number(req.orderNo) : (orderMap ? orderMap.get(req.id) : null);
    if (!n) return req.id ? String(req.id) : "";
    return `${t("order_prefix")}${n}`;
  }
  function formatEta(req) {
    if (!req) return "";
    if (req.deliveryEtaLabel) return req.deliveryEtaLabel;
    if (req.deliveryEta) return formatDateTime(req.deliveryEta);
    return "";
  }
  function priorityText(priority) {
    return priority === "urgent" ? t("priority_urgent") : t("priority_normal");
  }
  function getRequestImageButton(r) {
    if (!r || !r.imageData) return "";
    const useIcons = state.phoneMode && state.user && state.user.role === "driver";
    const label = useIcons ? "🖼" : t("view_image");
    return `<button class="btn btn-secondary btn-sm" data-view-image="${escapeHtml(r.id)}">${label}</button>`;
  }
  function getRelevantRequestsForNotify() {
    if (!state.user) return [];
    const role = state.user.role;
    const list = state.requests || [];
    if (role === "driver") {
      return list.filter((r) => (r.status === "pending" || r.status === "assigned") && r.driverUserId === state.user.id);
    }
    if (role === "admin" || role === "manager") {
      return list.filter((r) => r.status === "pending" || r.status === "assigned");
    }
    if (role === "staff" || role === "supervisor") {
      return list.filter((r) => r.toBranchId === state.user.branchId && (r.status === "pending" || r.status === "assigned"));
    }
    return [];
  }
  function updateFaviconBadge(count) {
    const favicon = document.getElementById("favicon");
    if (!favicon) return;
    const size = 100;
    const canvas = document.createElement("canvas");
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext("2d");
    ctx.fillStyle = "#111827";
    ctx.fillRect(0, 0, size, size);
    ctx.fillStyle = "#ffffff";
    ctx.font = "64px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("S", 50, 58);
    if (count > 0) {
      const badgeText = count > 99 ? "99+" : String(count);
      ctx.fillStyle = "#ef4444";
      ctx.beginPath();
      ctx.arc(78, 22, 20, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#ffffff";
      ctx.font = "18px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(badgeText, 78, 22);
    }
    favicon.href = canvas.toDataURL("image/png");
  }
  function showToast(message) {
    const container = document.getElementById("toastContainer");
    if (!container) return;
    const div = document.createElement("div");
    div.className = "toast";
    div.textContent = message;
    container.appendChild(div);
    setTimeout(() => {
      div.remove();
    }, 3500);
  }
  function playNotificationSound() {
    try {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume().catch(() => {});
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = 880;
      g.gain.value = 0.08;
      o.connect(g);
      g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + 0.15);
    } catch {}
  }
  function formatToastMessage(count) {
    const key = (state.user && state.user.role === "driver") ? "toast_new_assigned" : "toast_new_requests";
    return t(key).replace("{count}", String(count));
  }
  function updateRequestNotifications(opts = {}) {
    const notify = opts.notify !== false;
    if (!state.user) return;
    const key = REQ_SEEN_KEY_PREFIX + state.user.id;
    const seenAt = Number(localStorage.getItem(key) || "0");
    const relevant = getRelevantRequestsForNotify();
    const newCount = relevant.filter((r) => {
      const created = r.createdAt ? new Date(r.createdAt).getTime() : 0;
      return created > seenAt;
    }).length;

    const baseTitle = t("app_title");
    document.title = newCount > 0 ? `${baseTitle} (${newCount})` : baseTitle;
    updateFaviconBadge(newCount);

    if ("setAppBadge" in navigator && typeof navigator.setAppBadge === "function") {
      if (newCount > 0) navigator.setAppBadge(newCount).catch(() => {});
      else if (navigator.clearAppBadge) navigator.clearAppBadge().catch(() => {});
    }

    if (notify && newCount > state.lastNotifiedCount) {
      const diff = newCount - state.lastNotifiedCount;
      showToast(formatToastMessage(diff));
      playNotificationSound();
    }
    state.lastNotifiedCount = newCount;
  }
  function markRequestsSeen() {
    if (!state.user) return;
    const key = REQ_SEEN_KEY_PREFIX + state.user.id;
    localStorage.setItem(key, String(Date.now()));
    state.lastNotifiedCount = 0;
    updateRequestNotifications({ notify: false });
  }
  function isPageAllowed(pageId) {
    if (!state.user) return false;
    const role = state.user.role;
    const rules = {
      inventoryPanel: ["admin", "manager"],
      requestsPanel: ["staff", "supervisor", "manager", "admin"],
      transferPanel: ["staff", "supervisor", "manager", "admin"],
      driverPanel: ["driver"],
      movementsPanel: ["admin", "manager"],
      analyticsPanel: ["admin", "manager"],
      vehiclePanel: ["admin", "manager", "driver"],
      usersPanel: ["admin"]
    };
    return (rules[pageId] || []).includes(role);
  }
  function getDefaultPageForRole(role) {
    if (role === "driver") return "driverPanel";
    if (role === "supervisor") return "requestsPanel";
    if (role === "staff") return "requestsPanel";
    return "inventoryPanel";
  }
  function setActivePage(pageId) {
    state.activePageId = pageId;
    const panelIds = [
      "inventoryPanel",
      "requestsPanel",
      "transferPanel",
      "driverPanel",
      "movementsPanel",
      "analyticsPanel",
      "vehiclePanel",
      "usersPanel"
    ];
    panelIds.forEach((id) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = (id === pageId && isPageAllowed(id)) ? "block" : "none";
    });
    const menu = document.getElementById("mainMenu");
    if (menu) {
      menu.querySelectorAll("button[data-page]").forEach((btn) => {
        btn.classList.toggle("active", btn.getAttribute("data-page") === pageId);
      });
    }
    if (pageId === "requestsPanel" || pageId === "driverPanel") {
      markRequestsSeen();
    }
    if (pageId === "transferPanel") {
      renderTransferTables();
    }
  }
  function renderMenu() {
    const menu = document.getElementById("mainMenu");
    if (!menu || !state.user) return;
    const items = [
      { id: "inventoryPanel", label: "menu_inventory" },
      { id: "requestsPanel", label: "menu_requests" },
      { id: "transferPanel", label: "menu_transfers" },
      { id: "driverPanel", label: "menu_driver" },
      { id: "movementsPanel", label: "menu_movements" },
      { id: "analyticsPanel", label: "menu_analytics" },
      { id: "vehiclePanel", label: "menu_vehicles" },
      { id: "usersPanel", label: "menu_users" }
    ];
    menu.innerHTML = "";
    let firstAllowed = "";
    items.forEach((item) => {
      if (!isPageAllowed(item.id)) return;
      if (!firstAllowed) firstAllowed = item.id;
      const btn = document.createElement("button");
      btn.className = "btn btn-secondary btn-sm";
      btn.setAttribute("data-page", item.id);
      btn.textContent = t(item.label);
      btn.addEventListener("click", () => setActivePage(item.id));
      menu.appendChild(btn);
    });
    menu.style.display = firstAllowed ? "flex" : "none";
    const target = isPageAllowed(state.activePageId) ? state.activePageId : (firstAllowed || getDefaultPageForRole(state.user.role));
    if (target) setActivePage(target);
  }
  function computeEta(type, customValue) {
    const now = new Date();
    if (type === "3h") {
      const eta = new Date(now.getTime() + 3 * 60 * 60 * 1000);
      return { iso: eta.toISOString(), label: t("eta_3h") };
    }
    if (type === "tomorrow") {
      const eta = new Date(now.getTime() + 24 * 60 * 60 * 1000);
      return { iso: eta.toISOString(), label: t("eta_tomorrow") };
    }
    if (type === "custom") {
      if (!customValue) return null;
      const eta = new Date(customValue);
      if (Number.isNaN(eta.getTime())) return null;
      return { iso: eta.toISOString(), label: formatDateTime(eta.toISOString()) };
    }
    return null;
  }
  function openRequestImageById(id) {
    const req = (state.requests || []).find((r) => r.id === id);
    const trf = (state.transfers || []).find((t) => t.id === id);
    const imageData = (req && req.imageData) || (trf && trf.imageData) || "";
    if (!imageData) {
      alert(t("no_image"));
      return;
    }
    const w = window.open();
    if (!w) return;
    w.document.write(`<img src="${imageData}" style="max-width:100%;height:auto;" />`);
  }

  async function compressImageToDataUrl(file, maxDim = 1280, quality = 0.7) {
    const dataUrl = await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result || ""));
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });

    const img = await new Promise((resolve, reject) => {
      const image = new Image();
      image.onload = () => resolve(image);
      image.onerror = reject;
      image.src = dataUrl;
    });

    const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
    const w = Math.round(img.width * scale);
    const h = Math.round(img.height * scale);

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    if (!ctx) return dataUrl;
    ctx.drawImage(img, 0, 0, w, h);

    return canvas.toDataURL("image/jpeg", quality);
  }

  // ✅ UPDATED: uses MAIN_STORAGE_BRANCH_ID override (matches your server env)
  function getMainStorageId() {
    const preferred = MAIN_STORAGE_BRANCH_ID || "B001";
    const byId = state.branches.find((b) => b.id === preferred);
    if (byId) return byId.id;

    const byName = state.branches.find((b) => (b.name || "").toLowerCase().includes("main"));
    if (byName) return byName.id;

    return state.branches[0] ? state.branches[0].id : null;
  }

  function typeLabel(tKey) {
    if (tKey === "OIL_CHANGE") return (currentLang === "ar") ? "تغيير زيت" : "Oil change";
    if (tKey === "METER") return (currentLang === "ar") ? "عداد" : "Meter";
    if (tKey === "YEARLY_RENEW") return (currentLang === "ar") ? "تجديد سنوي" : "Yearly renewal";
    return (currentLang === "ar") ? "أخرى" : "Other";
  }
  function vehicleNameById(id) {
    const v = (state.vehicles || []).find(x => x.id === id);
    if (!v) return id;
    return v.plate ? `${v.name} (${v.plate})` : v.name;
  }

  function vehicleOptionLabel(vehicle) {
    if (!vehicle) return "";
    return vehicle.plate ? `${vehicle.name} (${vehicle.plate})` : vehicle.name;
  }

  function setVehicleEditInputs(vehicleId) {
    const nameInput = document.getElementById("vehEditNameInput");
    const plateInput = document.getElementById("vehEditPlateInput");
    if (!nameInput || !plateInput) return;
    const vehicle = (state.vehicles || []).find((v) => v.id === vehicleId);
    if (vehicle) {
      nameInput.value = vehicle.name || "";
      plateInput.value = vehicle.plate || "";
    } else {
      nameInput.value = "";
      plateInput.value = "";
    }
  }

  function getDriverVehicleIds(userId) {
    if (!userId) return [];
    return (state.carAssignments || [])
      .filter((a) => a.driverUserId === userId)
      .map((a) => a.vehicleId);
  }

  function getVehiclesForCurrentUser() {
    if (!state.user) return [];
    if (state.user.role === "admin" || state.user.role === "manager") {
      return [...(state.vehicles || [])];
    }
    const ids = new Set(getDriverVehicleIds(state.user.id));
    return (state.vehicles || []).filter((v) => ids.has(v.id));
  }

  function getVisibleMaintenanceEntries() {
    const list = [...(state.carMaintenances || [])];
    if (!state.user) return [];
    if (state.user.role !== "driver") return list;
    const allowedVehicles = new Set(getDriverVehicleIds(state.user.id));
    return list.filter(
      (entry) =>
        entry.driverUserId === state.user.id ||
        allowedVehicles.has(entry.vehicleId)
    );
  }

  function maintenanceEntryTimestamp(entry) {
    if (entry.maintenanceDate) {
      const d = new Date(entry.maintenanceDate + "T00:00:00");
      if (!Number.isNaN(d.getTime())) return d.getTime();
    }
    if (entry.createdAt) {
      const d = new Date(entry.createdAt);
      if (!Number.isNaN(d.getTime())) return d.getTime();
    }
    return null;
  }

  // ----- API calls -----
  async function apiLogin(name, password) {
    const res = await fetch(`${API_BASE}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, password })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || t("login_failed"));
    return body;
  }

  async function apiLoadState() {
    const res = await fetch(`${API_BASE}/state`);
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || t("load_state_failed"));
    return body;
  }

  async function apiNextItemId() {
    const res = await fetch(`${API_BASE}/next-item-id`);
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || t("next_item_failed"));
    return body.nextId;
  }

  async function apiCreateUser(name, role, password, branchId) {
    const res = await fetch(`${API_BASE}/users`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, role, password, branchId, adminUserId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create user failed");
    return body;
  }

  async function apiUpdateUser(userId, updates) {
    const res = await fetch(`${API_BASE}/users/${userId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ adminUserId: state.user.id, ...updates })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Update user failed");
    return body;
  }

  async function apiDeleteUser(userId) {
    const res = await fetch(`${API_BASE}/users/${userId}`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ adminUserId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Delete user failed");
    return body;
  }

  async function apiCreateBranch(name) {
    const res = await fetch(`${API_BASE}/branches`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, adminUserId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create branch failed");
    return body;
  }

  async function apiCreateItem(data) {
    const res = await fetch(`${API_BASE}/items`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create item failed");
    return body;
  }

  async function apiUpdateItem(id, data) {
    const res = await fetch(`${API_BASE}/items/${encodeURIComponent(id)}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Update item failed");
    return body;
  }
  async function apiDeleteItem(id, data) {
    const res = await fetch(`${API_BASE}/items/${encodeURIComponent(id)}`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data || {})
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Delete item failed");
    return body;
  }

  async function apiCreateMovement(itemId, type, qty, note) {
    const res = await fetch(`${API_BASE}/movements`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ itemId, type, qty, note, userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Movement failed");
    return body;
  }

  async function apiCreateRequest(itemId, qty, note, priority, urgentNote, imageData) {
    const res = await fetch(`${API_BASE}/requests`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ itemId, qty, note, priority, urgentNote, imageData, userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Request failed");
    return body;
  }

  async function apiAssignRequest(id, driverUserId) {
    const res = await fetch(`${API_BASE}/requests/${id}/assign`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, driverUserId })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Assign request failed");
    return body;
  }

  async function apiCreateTransfer(qty, note, imageData) {
    const res = await fetch(`${API_BASE}/transfers`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ qty, note, imageData, userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create transfer failed");
    return body;
  }

  async function apiAssignTransfer(id, toBranchId) {
    const res = await fetch(`${API_BASE}/transfers/${id}/assign`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, toBranchId })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Assign transfer failed");
    return body;
  }

  async function apiPickupTransfer(id) {
    const res = await fetch(`${API_BASE}/transfers/${id}/pickup`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Pickup transfer failed");
    return body;
  }

  async function apiDeliverTransfer(id) {
    const res = await fetch(`${API_BASE}/transfers/${id}/deliver`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Deliver transfer failed");
    return body;
  }

  async function apiReadyTransfer(id, readyStatus) {
    const res = await fetch(`${API_BASE}/transfers/${id}/ready`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, readyStatus })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Ready transfer failed");
    return body;
  }

  async function apiClaimRequest(id, deliveryEta, deliveryEtaLabel) {
    const res = await fetch(`${API_BASE}/requests/${id}/claim`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, deliveryEta, deliveryEtaLabel })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Claim request failed");
    return body;
  }

  async function apiUpdateRequestEta(id, deliveryEta, deliveryEtaLabel) {
    const res = await fetch(`${API_BASE}/requests/${id}/eta`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, deliveryEta, deliveryEtaLabel })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Update ETA failed");
    return body;
  }

  async function apiDeliverRequest(id) {
    const res = await fetch(`${API_BASE}/requests/${id}/deliver`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Deliver failed");
    return body;
  }

  async function apiDeleteRequest(id) {
    const res = await fetch(`${API_BASE}/requests/${id}`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Delete request failed");
    return body;
  }

  async function apiCreateVehicle(name, plate) {
    const res = await fetch(`${API_BASE}/vehicles`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, name, plate })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create vehicle failed");
    return body;
  }

  async function apiUpdateVehicle(id, data) {
    const res = await fetch(`${API_BASE}/vehicles/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, ...data })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Update vehicle failed");
    return body;
  }

  async function apiDeleteVehicle(id) {
    const res = await fetch(`${API_BASE}/vehicles/${id}`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Delete vehicle failed");
    return body;
  }

  async function apiAssignVehicle(vehicleId, driverUserId, note) {
    const res = await fetch(`${API_BASE}/car-assignments`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, vehicleId, driverUserId, note })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Assign vehicle failed");
    return body;
  }

  async function apiCreateReminder(data) {
    const res = await fetch(`${API_BASE}/vehicle-reminders`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, ...data })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create reminder failed");
    return body;
  }

  async function apiUpdateReminder(id, patch) {
    const res = await fetch(`${API_BASE}/vehicle-reminders/${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, ...patch })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Update reminder failed");
    return body;
  }

  async function apiDeleteReminder(id) {
    const res = await fetch(`${API_BASE}/vehicle-reminders/${id}`, {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Delete reminder failed");
    return body;
  }

  async function apiCreateMaintenance(data) {
    const res = await fetch(`${API_BASE}/car-maintenances`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userId: state.user.id, ...data })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Save maintenance failed");
    return body;
  }

  async function apiMaintenanceSummary(params = {}) {
    const query = new URLSearchParams({ userId: state.user.id });
    if (params.vehicleId) query.set("vehicleId", params.vehicleId);
    if (params.from) query.set("from", params.from);
    if (params.to) query.set("to", params.to);
    const res = await fetch(`${API_BASE}/maintenance-summary?${query.toString()}`);
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Summary failed");
    return body;
  }

  // ----- Render -----
  function renderHeader() {
    const headerUser = document.getElementById("headerUserName");
    const headerRole = document.getElementById("headerRole");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!state.user) {
      headerUser.style.display = "none";
      headerRole.style.display = "none";
      logoutBtn.style.display = "none";
      return;
    }

    headerUser.textContent = state.user.name;
    headerUser.style.display = "inline-flex";

    const branchText = state.user.branchId ? ` | ${currentLang === "ar" ? "الفرع" : "Branch"}: ${getBranchName(state.user.branchId)}` : "";
    headerRole.textContent = `${currentLang === "ar" ? "الدور" : "Role"}: ${state.user.role}${branchText}`;
    headerRole.style.display = "inline-flex";

    logoutBtn.style.display = "inline-flex";
  }

  function renderBranchSelects() {
    const selects = [
      document.getElementById("itemBranchSelect"),
      document.getElementById("newUserBranchSelect"),
      document.getElementById("editUserBranchSelect")
    ];

    selects.forEach((sel) => {
      if (!sel) return;
      sel.innerHTML = "";
      state.branches.forEach((b, idx) => {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.name;
        if (idx === 0) opt.selected = true;
        sel.appendChild(opt);
      });
    });

    const allowedSel = document.getElementById("editUserAllowedBranches");
    if (allowedSel) {
      const prev = new Set(Array.from(allowedSel.selectedOptions || []).map((o) => o.value));
      allowedSel.innerHTML = "";
      (state.branches || []).forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.name;
        if (prev.has(b.id)) opt.selected = true;
        allowedSel.appendChild(opt);
      });
    }

    const invSel = document.getElementById("inventoryViewBranchSelect");
    if (invSel) {
      invSel.innerHTML = "";
      const mainId = getMainStorageId();
      state.branches.forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.id === mainId ? `${b.name} (${t("main_storage")})` : b.name;
        invSel.appendChild(opt);
      });
      if (mainId) invSel.value = mainId;
      if (state.user && state.user.role === "supervisor") {
        invSel.disabled = true;
      } else {
        invSel.disabled = false;
      }
    }

    const fromLabel = document.getElementById("requestFromBranchLabel");
    const toLabel = document.getElementById("requestToBranchLabel");
    if (fromLabel) fromLabel.textContent = getBranchName(getMainStorageId());
    if (toLabel && state.user && state.user.branchId) toLabel.textContent = getBranchName(state.user.branchId);

    const analyticsBranchSelect = document.getElementById("analyticsBranchSelect");
    if (analyticsBranchSelect) {
      analyticsBranchSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = (currentLang === "ar") ? "كل الفروع" : "All branches";
      analyticsBranchSelect.appendChild(allOpt);
      state.branches.forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.name;
        analyticsBranchSelect.appendChild(opt);
      });
    }
  }

  // ✅ IMPORTANT: value is id::branchId (because update requires branchId + item id not unique across branches)
  function renderItemEditSelect() {
    const sel = document.getElementById("itemEditSelect");
    if (!sel) return;
    const searchInput = document.getElementById("itemEditSearchInput");
    const query = (searchInput && searchInput.value ? searchInput.value : "")
      .trim()
      .toLowerCase();
    const storageId = getMainStorageId();
    const currentValue = sel.value;

    sel.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = (currentLang === "ar")
      ? "اختر صنف للتعديل"
      : "Select item to edit";
    sel.appendChild(placeholder);

    const all = (state.items || [])
      .filter((it) => it.branchId === storageId)
      .sort((a, b) => (a.name || "").localeCompare(b.name || ""));

    const filtered = query
      ? all.filter((it) => {
          const haystack = [
            it.id,
            it.name,
            it.nameEn,
            it.nameAr
          ]
            .map((v) => String(v || "").toLowerCase());
          return haystack.some((v) => v.includes(query));
        })
      : all;

    if (!filtered.length) {
      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = t("no_items_match_search");
      empty.disabled = true;
      sel.appendChild(empty);
    } else {
      filtered.forEach((it) => {
        const opt = document.createElement("option");
        opt.value = `${it.id}::${it.branchId}`;
        opt.textContent = `${it.name} (${getBranchName(it.branchId)})`;
        sel.appendChild(opt);
      });
    }

    if (currentValue && filtered.some((it) => `${it.id}::${it.branchId}` === currentValue)) {
      sel.value = currentValue;
    } else {
      sel.value = "";
    }
    applyItemEditSelection();
  }

  function applyItemEditSelection() {
    const sel = document.getElementById("itemEditSelect");
    const typeSelect = document.getElementById("itemTypeSelect");
    const val = sel ? sel.value : "";

    if (!val) {
      document.getElementById("itemNameInput").value = "";
      document.getElementById("itemBaseQtyInput").value = "0";
      document.getElementById("itemMinQtyInput").value = "0";
      document.getElementById("itemUnitCostInput").value = "0";
      if (typeSelect) {
        typeSelect.disabled = false;
        if (!["ITEM", "THR"].includes(typeSelect.value)) {
          typeSelect.value = "ITEM";
        }
      }
      updateItemIdField();
      return;
    }

    const [id, branchId] = val.split("::");
    const item = state.items.find(
      (it) => it.id === id && it.branchId === branchId
    );
    if (!item) return;

    document.getElementById("itemIdInput").value = item.id;
    document.getElementById("itemNameInput").value = item.name || "";
    document.getElementById("itemBranchSelect").value = item.branchId || "";
    document.getElementById("itemBaseQtyInput").value = item.baseQty ?? 0;
    document.getElementById("itemMinQtyInput").value = item.minQty ?? 0;
    document.getElementById("itemUnitCostInput").value = item.unitCost ?? 0;

    if (typeSelect) {
      typeSelect.value = getItemTypeFromId(item.id);
      typeSelect.disabled = true;
    }
  }

  function renderInventoryViewer() {
    const tbody = document.getElementById("itemsTableBody");
    const alertsBody = document.getElementById("alertsTableBody");
    const storageTotalEl = document.getElementById("storageTotalValue");
    const selectedValueEl = document.getElementById("selectedListValue");
    const invSel = document.getElementById("inventoryViewBranchSelect");
    const searchInput = document.getElementById("inventorySearchInput");

    tbody.innerHTML = "";
    if (alertsBody) alertsBody.innerHTML = "";

    const mainId = getMainStorageId();
    const selectedBranchId = invSel ? invSel.value : mainId;

    const itemsSelected = (state.items || []).filter(it => it.branchId === selectedBranchId);
    const itemsMain = (state.items || []).filter(it => it.branchId === mainId);

    const query = (searchInput && searchInput.value ? searchInput.value : "").trim().toLowerCase();
    const filteredSelected = query
      ? itemsSelected.filter((it) => {
          const haystack = [
            it.id,
            it.name,
            it.nameEn,
            it.nameAr
          ].map((v) => String(v || "").toLowerCase());
          return haystack.some((v) => v.includes(query));
        })
      : itemsSelected;

    const selectedTotal = itemsSelected.reduce((sum, it) => sum + (Number(it.baseQty)||0)*(Number(it.unitCost)||0), 0);
    const storageTotal = itemsMain.reduce((sum, it) => sum + (Number(it.baseQty)||0)*(Number(it.unitCost)||0), 0);

    if (selectedValueEl) selectedValueEl.textContent = selectedTotal.toFixed(3);
    if (storageTotalEl) storageTotalEl.textContent = storageTotal.toFixed(3);

    const sorted = [...filteredSelected].sort((a,b)=> (a.name||"").localeCompare(b.name||""));

    const pageSize = Number(state.inventoryPageSize) || 40;
    const pageSizeSelect = document.getElementById("inventoryPageSizeSelect");
    if (pageSizeSelect) pageSizeSelect.value = String(pageSize);

    let totalPages = Math.max(1, Math.ceil(sorted.length / pageSize || 1));
    if (!sorted.length) totalPages = 1;
    if (state.inventoryPage > totalPages) state.inventoryPage = totalPages;
    if (state.inventoryPage < 1) state.inventoryPage = 1;

    const startIdx = (state.inventoryPage - 1) * pageSize;
    const paged = sorted.slice(startIdx, startIdx + pageSize);

    const pageInfo = document.getElementById("inventoryPageInfo");
    const prevBtn = document.getElementById("inventoryPrevBtn");
    const nextBtn = document.getElementById("inventoryNextBtn");

    if (!sorted.length) {
      const tr = document.createElement("tr");
      const emptyMsg = query ? t("no_items_match_search") : `${t("no_items_in")} ${escapeHtml(getBranchName(selectedBranchId))}.`;
      tr.innerHTML = `<td colspan="7" class="text-muted">${emptyMsg}</td>`;
      tbody.appendChild(tr);
      if (pageInfo) pageInfo.textContent = t("no_items");
      if (prevBtn) prevBtn.disabled = true;
      if (nextBtn) nextBtn.disabled = true;
    } else {
      paged.forEach((it) => {
        const value = (Number(it.baseQty)||0) * (Number(it.unitCost)||0);
        const low = it.minQty > 0 && Number(it.baseQty||0) <= Number(it.minQty||0);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(it.id)}</td>
          <td>${escapeHtml(it.name)}</td>
          <td>${escapeHtml(getBranchName(it.branchId))}</td>
          <td${low ? ' class="danger"' : ""}>${escapeHtml(it.baseQty)}</td>
          <td>${escapeHtml(it.minQty)}</td>
          <td>${escapeHtml(it.unitCost)}</td>
          <td>${value.toFixed(3)}</td>
        `;
        tbody.appendChild(tr);
      });
      if (pageInfo) {
        const startNum = startIdx + 1;
        const endNum = startIdx + paged.length;
        pageInfo.textContent = `${t("page_word")} ${state.inventoryPage} ${t("of_word")} ${totalPages} • ${t("showing")} ${startNum}-${endNum} ${t("of_word")} ${sorted.length}`;
      }
      if (prevBtn) prevBtn.disabled = state.inventoryPage <= 1;
      if (nextBtn) nextBtn.disabled = state.inventoryPage >= totalPages;
    }

    if (alertsBody) {
      const lowItems = itemsMain.filter(it => it.minQty > 0 && Number(it.baseQty||0) <= Number(it.minQty||0));
      if (!lowItems.length) {
        const trA = document.createElement("tr");
        trA.innerHTML = `<td colspan="3" class="text-muted">${t("no_low_stock")}</td>`;
        alertsBody.appendChild(trA);
      } else {
        lowItems
          .sort((a,b)=> (Number(a.baseQty||0)-Number(b.baseQty||0)))
          .forEach((it)=>{
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(it.name)}</td>
              <td class="danger">${escapeHtml(it.baseQty)}</td>
              <td>${escapeHtml(it.minQty)}</td>
            `;
            alertsBody.appendChild(tr);
          });
      }
    }

    const moveSelect = document.getElementById("movementItemSelect");
    if (moveSelect) {
      moveSelect.innerHTML = "";
      const all = [...state.items].sort((a,b)=>(a.name||"").localeCompare(b.name||""));
      all.forEach((it, idx) => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = `${it.name} (${getBranchName(it.branchId)})`;
        if (idx === 0) opt.selected = true;
        moveSelect.appendChild(opt);
      });
    }

    renderItemEditSelect();
  }

  function fillRequestItemsFromStorage() {
    const itemSel = document.getElementById("requestItemSelect");
    if (!itemSel) return;
    const storageId = getMainStorageId();
    const searchInput = document.getElementById("requestItemSearchInput");
    const term = (searchInput?.value || "").trim().toLowerCase();
    const prev = itemSel.value;

    const items = state.items.filter((it) => it.branchId === storageId);
    items.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
    const filtered = term
      ? items.filter((it) => {
          const hay = `${it.id || ""} ${it.name || ""}`.toLowerCase();
          return hay.includes(term);
        })
      : items;

    itemSel.innerHTML = "";

    if (!filtered.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = items.length ? t("no_items_match_search") : `${t("no_items_in")} ${getBranchName(storageId)}`;
      opt.disabled = true;
      opt.selected = true;
      itemSel.appendChild(opt);
      return;
    }

    let selectedValue = "";
    filtered.forEach((it) => {
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.name} (${t("main_storage")})`;
      if (it.id === prev) selectedValue = prev;
      itemSel.appendChild(opt);
    });

    if (selectedValue) {
      itemSel.value = selectedValue;
    } else {
      itemSel.value = filtered[0].id;
    }
  }

  function renderUsersTable() {
    const tbody = document.getElementById("usersTableBody");
    tbody.innerHTML = "";
    const users = [...state.users].sort((a, b) => a.name.localeCompare(b.name));
    users.forEach((u) => {
      const tr = document.createElement("tr");
      const accessLabel = getSupervisorAccessLabel(u);
      tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.role)}</td><td>${escapeHtml(getBranchName(u.branchId))}</td><td>${escapeHtml(accessLabel)}</td>`;
      tbody.appendChild(tr);
    });

    const editSel = document.getElementById("editUserSelect");
    if (editSel) {
      editSel.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = (currentLang === "ar") ? "اختر مستخدم" : "Select user";
      editSel.appendChild(placeholder);

      users.forEach((u) => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${u.name} (${u.role})`;
        editSel.appendChild(opt);
      });
    }
  }

  function setupRequestBranchFilters() {
    if (!state.user) return;

    const filterBar = document.getElementById("requestsFilterBar");
    const filterSelect = document.getElementById("requestBranchFilterSelect");
    if (filterBar && filterSelect) {
      const canFilter = ["admin", "manager", "supervisor"].includes(state.user.role);
      filterBar.style.display = canFilter ? "flex" : "none";

      if (canFilter) {
        const prev = filterSelect.value;
        filterSelect.innerHTML = "";
        if (state.user.role === "supervisor") {
          const allowed = getSupervisorAllowedBranches(state.user);
          allowed.forEach((id) => {
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = getBranchName(id);
            filterSelect.appendChild(opt);
          });
          if (allowed.length > 1) {
            const allOpt = document.createElement("option");
            allOpt.value = "ALL";
            allOpt.textContent = (currentLang === "ar") ? "كل الفروع" : "All branches";
            filterSelect.insertBefore(allOpt, filterSelect.firstChild);
            filterSelect.disabled = false;
            if (prev && filterSelect.querySelector(`option[value="${prev}"]`)) {
              filterSelect.value = prev;
            } else {
              filterSelect.value = "ALL";
            }
          } else {
            const only = allowed[0] || "";
            filterSelect.value = only;
            filterSelect.disabled = true;
          }
        } else {
          const allOpt = document.createElement("option");
          allOpt.value = "ALL";
          allOpt.textContent = (currentLang === "ar") ? "كل الفروع" : "All branches";
          filterSelect.appendChild(allOpt);
          (state.branches || []).forEach((b) => {
            const opt = document.createElement("option");
            opt.value = b.id;
            opt.textContent = b.name;
            filterSelect.appendChild(opt);
          });
          filterSelect.disabled = false;
          if (prev && filterSelect.querySelector(`option[value="${prev}"]`)) {
            filterSelect.value = prev;
          } else {
            filterSelect.value = "ALL";
          }
        }
      }
    }

    const historySelect = document.getElementById("requestHistoryBranchSelect");
    const historyBlock = document.getElementById("requestsHistoryBlock");
    if (historySelect && historyBlock) {
      if (!["admin", "manager", "supervisor"].includes(state.user.role)) {
        historyBlock.style.display = "none";
        return;
      }
      const prev = historySelect.value;
      historySelect.innerHTML = "";
      if (state.user.role === "supervisor") {
        const allowed = getSupervisorAllowedBranches(state.user);
        allowed.forEach((id) => {
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = getBranchName(id);
          historySelect.appendChild(opt);
        });
        if (allowed.length > 1) {
          const allOpt = document.createElement("option");
          allOpt.value = "ALL";
          allOpt.textContent = (currentLang === "ar") ? "كل الفروع" : "All branches";
          historySelect.insertBefore(allOpt, historySelect.firstChild);
          historySelect.disabled = false;
          if (prev && historySelect.querySelector(`option[value="${prev}"]`)) {
            historySelect.value = prev;
          } else {
            historySelect.value = "ALL";
          }
        } else {
          const only = allowed[0] || "";
          historySelect.value = only;
          historySelect.disabled = true;
        }
      } else {
        const allOpt = document.createElement("option");
        allOpt.value = "ALL";
        allOpt.textContent = (currentLang === "ar") ? "كل الفروع" : "All branches";
        historySelect.appendChild(allOpt);
        (state.branches || []).forEach((b) => {
          const opt = document.createElement("option");
          opt.value = b.id;
          opt.textContent = b.name;
          historySelect.appendChild(opt);
        });
        historySelect.disabled = false;
        if (prev && historySelect.querySelector(`option[value="${prev}"]`)) {
          historySelect.value = prev;
        } else {
          historySelect.value = "ALL";
        }
      }
    }
  }

  function renderRequestsTable() {
    const tbody = document.getElementById("requestsTableBody");
    tbody.innerHTML = "";
    if (!state.user) return;
    setupRequestBranchFilters();
    const orderMap = buildRequestOrderMap(state.requests || []);
    const all = [...state.requests].sort(
      (a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0)
    );

    let visible;

    if (state.user.role === "driver") {
      visible = all; // (driver normally uses driver panel, but keep safe)
    } else if (state.user.role === "admin" || state.user.role === "manager") {
      // Admin & Manager see all non-delivered requests
      visible = all.filter((r) => r.status !== "delivered");
    } else if (state.user.role === "supervisor") {
      const allowed = getSupervisorAllowedBranches(state.user);
      visible = all.filter((r) => r.status !== "delivered" && allowed.includes(r.toBranchId));
    } else {
      // Staff: requests for their own branch (non-delivered)
      visible = all.filter((r) => r.toBranchId === state.user.branchId && r.status !== "delivered");
    }

    const canDelete = state.user.role === "admin" || state.user.role === "manager";
    const canAssign = state.user.role === "admin" || state.user.role === "manager";
    const canReceive = ["staff", "supervisor"].includes(state.user.role);
    const canFilter = ["admin", "manager", "supervisor"].includes(state.user.role);
    const filterSelect = document.getElementById("requestBranchFilterSelect");
    const filterValue = canFilter && filterSelect ? filterSelect.value : "ALL";
    if (canFilter && filterValue && filterValue !== "ALL") {
      visible = visible.filter((r) => r.toBranchId === filterValue);
    }

    if (!visible.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="14" class="text-muted">${
        ["admin", "manager"].includes(state.user.role) ? t("no_pending_requests") : t("no_requests_yet")
      }</td>`;
      tbody.appendChild(tr);
      return;
    }

    visible.forEach((r) => {
      const item = getItemById(r.itemId);
      const driverName = r.driverUserId ? getUserName(r.driverUserId) : "";
      const etaText = formatEta(r);
      const orderLabel = getRequestOrderLabel(r, orderMap);
      const priority = r.priority === "urgent" ? "urgent" : "normal";
      const priorityPill = `<span class="pill pill-priority ${priority === "urgent" ? "urgent" : ""}">${escapeHtml(priorityText(priority))}</span>`;
      const noteText = [r.urgentNote ? `${t("urgent_note_label")}: ${r.urgentNote}` : "", r.note || ""]
        .filter(Boolean)
        .join(" | ");

      const actionParts = [];
      const imageBtn = getRequestImageButton(r);
      if (canAssign && r.status !== "delivered") {
        actionParts.push(
          `<select data-assign-driver="${escapeHtml(r.id)}">${getDriverOptionsHtml(r.driverUserId)}</select>`
        );
        actionParts.push(`<button class="btn btn-primary btn-sm" data-assign-request="${escapeHtml(r.id)}">${t("assign")}</button>`);
      }
      if (canDelete && r.status === "pending") {
        actionParts.push(`<button class="btn btn-secondary btn-sm" data-delete-request="${escapeHtml(r.id)}">${t("delete_request")}</button>`);
      }
      if (canReceive && r.status !== "delivered" && r.toBranchId === state.user.branchId) {
        actionParts.push(`<button class="btn btn-primary btn-sm" data-receive-request="${escapeHtml(r.id)}">${t("deliver")}</button>`);
      }
      const actionBtns = actionParts.join(" ");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td title="${escapeHtml(r.id)}">${escapeHtml(orderLabel)}</td>
        <td>${escapeHtml(formatDateTime(r.createdAt))}</td>
        <td>${escapeHtml(item ? item.name : r.itemId)}</td>
        <td>${escapeHtml(r.qty)}</td>
        <td>${escapeHtml(getBranchName(r.fromBranchId))}</td>
        <td>${escapeHtml(getBranchName(r.toBranchId))}</td>
        <td>${priorityPill}</td>
        <td>${escapeHtml(etaText)}</td>
        <td><span class="pill pill-status ${escapeHtml(r.status)}">${t(r.status)}</span></td>
        <td>${escapeHtml(getUserName(r.createdByUserId))}</td>
        <td>${escapeHtml(driverName)}</td>
        <td>${escapeHtml(noteText)}</td>
        <td>${imageBtn || "-"}</td>
        <td>${actionBtns}</td>
      `;
      tbody.appendChild(tr);
    });
    renderRequestsHistoryTable();
  }

  function renderRequestsHistoryTable() {
    const block = document.getElementById("requestsHistoryBlock");
    const tbody = document.getElementById("requestsHistoryTableBody");
    if (!block || !tbody) return;

    if (!state.user || !["admin", "manager", "supervisor"].includes(state.user.role)) {
      block.style.display = "none";
      return;
    }
    block.style.display = "block";
    tbody.innerHTML = "";

    const orderMap = buildRequestOrderMap(state.requests || []);
    const historySelect = document.getElementById("requestHistoryBranchSelect");
    const filterValue = historySelect ? historySelect.value : "ALL";
    let list = (state.requests || []).filter((r) => r.status === "delivered");

    if (state.user.role === "supervisor") {
      const allowed = getSupervisorAllowedBranches(state.user);
      list = list.filter((r) => allowed.includes(r.toBranchId));
      if (filterValue && filterValue !== "ALL") {
        list = list.filter((r) => r.toBranchId === filterValue);
      }
    } else if (filterValue && filterValue !== "ALL") {
      list = list.filter((r) => r.toBranchId === filterValue);
    }

    list.sort((a, b) => new Date(b.deliveredAt || b.createdAt || 0) - new Date(a.deliveredAt || a.createdAt || 0));

    if (!list.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="12" class="text-muted">${t("no_history_requests")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    list.forEach((r) => {
      const item = getItemById(r.itemId);
      const orderLabel = getRequestOrderLabel(r, orderMap);
      const priority = r.priority === "urgent" ? "urgent" : "normal";
      const priorityPill = `<span class="pill pill-priority ${priority === "urgent" ? "urgent" : ""}">${escapeHtml(priorityText(priority))}</span>`;
      const noteText = [r.urgentNote ? `${t("urgent_note_label")}: ${r.urgentNote}` : "", r.note || ""]
        .filter(Boolean)
        .join(" | ");
      const imageBtn = getRequestImageButton(r);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td title="${escapeHtml(r.id)}">${escapeHtml(orderLabel)}</td>
        <td>${escapeHtml(formatDateTime(r.createdAt))}</td>
        <td>${escapeHtml(formatDateTime(r.deliveredAt))}</td>
        <td>${escapeHtml(item ? item.name : r.itemId)}</td>
        <td>${escapeHtml(r.qty)}</td>
        <td>${escapeHtml(getBranchName(r.fromBranchId))}</td>
        <td>${escapeHtml(getBranchName(r.toBranchId))}</td>
        <td>${priorityPill}</td>
        <td>${escapeHtml(getUserName(r.createdByUserId))}</td>
        <td>${escapeHtml(r.driverUserId ? getUserName(r.driverUserId) : "")}</td>
        <td>${escapeHtml(noteText)}</td>
        <td>${imageBtn || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderTransferTables() {
    renderTransferRequestsTable();
    renderTransferHistoryTable();
  }

  function getVisibleTransfersForUser(list) {
    if (!state.user) return [];
    const role = state.user.role;
    if (role === "admin" || role === "manager") return list;
    if (role === "supervisor") {
      const allowed = getSupervisorAllowedBranches(state.user);
      return list.filter((t) => allowed.includes(t.fromBranchId) || allowed.includes(t.toBranchId));
    }
    if (role === "staff") {
      return list.filter((t) => t.fromBranchId === state.user.branchId || t.toBranchId === state.user.branchId);
    }
    return [];
  }

  function renderTransferRequestsTable() {
    const tbody = document.getElementById("transferTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!state.user) return;

    const all = [...(state.transfers || [])];
    const active = all.filter((t) => t.status !== "delivered");
    const visible = getVisibleTransfersForUser(active);

    if (!visible.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="12" class="text-muted">${t("no_transfers_yet")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    visible.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

    visible.forEach((t) => {
      const canAssign = ["admin", "manager", "supervisor"].includes(state.user.role);
      const canReady = ["admin", "manager", "supervisor", "staff"].includes(state.user.role)
        && t.status === "delivered"
        && t.toBranchId
        && (state.user.branchId === t.toBranchId || ["admin", "manager"].includes(state.user.role));

      const assignSelect = canAssign && t.status === "pending"
        ? `<select data-transfer-assign="${escapeHtml(t.id)}">${getBranchOptionsHtml(t.toBranchId)}</select>`
        : `<span>${escapeHtml(getBranchName(t.toBranchId))}</span>`;

      const readyLabel = t.readyStatus === "ready" ? t("ready") : t("not_ready");
      const readyBtn = canReady
        ? `<button class="btn btn-secondary btn-sm" data-transfer-ready="${escapeHtml(t.id)}">${t.readyStatus === "ready" ? t("not_ready") : t("ready")}</button>`
        : "";

      const actionParts = [];
      if (canAssign && t.status === "pending") {
        actionParts.push(`<button class="btn btn-primary btn-sm" data-transfer-assign-btn="${escapeHtml(t.id)}">${t("assign")}</button>`);
      }
      if (readyBtn) actionParts.push(readyBtn);
      const actionBtns = actionParts.join(" ");

      const imageBtn = getRequestImageButton(t);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(t.id)}</td>
        <td>${escapeHtml(formatDateTime(t.createdAt))}</td>
        <td>${escapeHtml(t.qty)}</td>
        <td>${escapeHtml(getBranchName(t.fromBranchId))}</td>
        <td>${assignSelect}</td>
        <td><span class="pill pill-status ${escapeHtml(t.status)}">${t(t.status)}</span></td>
        <td>${escapeHtml(readyLabel)}</td>
        <td>${escapeHtml(getUserName(t.createdByUserId))}</td>
        <td>${escapeHtml(t.driverUserId ? getUserName(t.driverUserId) : "")}</td>
        <td>${escapeHtml(t.note || "")}</td>
        <td>${imageBtn || "-"}</td>
        <td>${actionBtns || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderTransferHistoryTable() {
    const tbody = document.getElementById("transferHistoryTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!state.user) return;

    const history = (state.transfers || []).filter((t) => t.status === "delivered");
    const visible = getVisibleTransfersForUser(history);

    if (!visible.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" class="text-muted">${t("no_transfer_history")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    visible.sort((a, b) => new Date(b.deliveredAt || b.createdAt || 0) - new Date(a.deliveredAt || a.createdAt || 0));

    visible.forEach((t) => {
      const readyLabel = t.readyStatus === "ready" ? t("ready") : t("not_ready");
      const imageBtn = getRequestImageButton(t);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(t.id)}</td>
        <td>${escapeHtml(formatDateTime(t.createdAt))}</td>
        <td>${escapeHtml(formatDateTime(t.deliveredAt))}</td>
        <td>${escapeHtml(t.qty)}</td>
        <td>${escapeHtml(getBranchName(t.fromBranchId))}</td>
        <td>${escapeHtml(getBranchName(t.toBranchId))}</td>
        <td>${escapeHtml(readyLabel)}</td>
        <td>${escapeHtml(t.driverUserId ? getUserName(t.driverUserId) : "")}</td>
        <td>${escapeHtml(t.note || "")}</td>
        <td>${imageBtn || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }


  function renderDriverRequestsTable() {
    const tbody = document.getElementById("driverRequestsTableBody");
    tbody.innerHTML = "";
    const orderMap = buildRequestOrderMap(state.requests || []);
    const pending = state.requests
      .filter((r) => r.status === "pending" || r.status === "assigned")
      .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

    const notice = document.getElementById("driverNotice");
    if (notice && state.user) {
      const assignedToMe = pending.filter((r) => r.driverUserId === state.user.id).length;
      const unassigned = pending.filter((r) => !r.driverUserId).length;
      notice.innerHTML = `
        <div class="summary-card">
          <div class="summary-label">${t("assigned_to_you")}</div>
          <div class="summary-value">${assignedToMe}</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">${t("unassigned_requests")}</div>
          <div class="summary-value">${unassigned}</div>
        </div>
      `;
    }

    if (!pending.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="14" class="text-muted">${t("no_pending_requests")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    pending.forEach((r) => {
      const item = getItemById(r.itemId);
      const etaText = formatEta(r);
      const orderLabel = getRequestOrderLabel(r, orderMap);
      const priority = r.priority === "urgent" ? "urgent" : "normal";
      const priorityPill = `<span class="pill pill-priority ${priority === "urgent" ? "urgent" : ""}">${escapeHtml(priorityText(priority))}</span>`;
      const noteText = [r.urgentNote ? `${t("urgent_note_label")}: ${r.urgentNote}` : "", r.note || ""]
        .filter(Boolean)
        .join(" | ");
      const imageBtn = getRequestImageButton(r);
      const isMine = state.user && r.driverUserId === state.user.id;
      const assignedByRole = getUserRoleById(r.assignedByUserId);
      const canShowEta = isMine && ["admin", "manager"].includes(assignedByRole);
      const useIcons = state.phoneMode && state.user && state.user.role === "driver";
      const claimLabel = useIcons ? "🚚" : t("take_request");
      const etaLabel = useIcons ? "⏱" : t("set_eta");
      const claimBtn = !r.driverUserId ? `<button class="btn btn-primary btn-sm" data-claim-request="${escapeHtml(r.id)}">${claimLabel}</button>` : "";
      const etaSelect = canShowEta ? `
        <select data-eta-type="${escapeHtml(r.id)}">
          <option value="">${t("eta_select")}</option>
          <option value="3h">${t("eta_3h")}</option>
          <option value="tomorrow">${t("eta_tomorrow")}</option>
          <option value="custom">${t("eta_custom")}</option>
        </select>
        <input type="datetime-local" data-eta-custom="${escapeHtml(r.id)}" style="display:none;" />
      ` : "";
      const etaBtn = canShowEta ? `<button class="btn btn-secondary btn-sm" data-set-eta="${escapeHtml(r.id)}">${etaLabel}</button>` : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td title="${escapeHtml(r.id)}">${escapeHtml(orderLabel)}</td>
        <td>${escapeHtml(formatDateTime(r.createdAt))}</td>
        <td>${escapeHtml(item ? item.name : r.itemId)}</td>
        <td>${escapeHtml(r.qty)}</td>
        <td>${escapeHtml(getBranchName(r.fromBranchId))}</td>
        <td>${escapeHtml(getBranchName(r.toBranchId))}</td>
        <td>${priorityPill}</td>
        <td>${escapeHtml(etaText)}</td>
        <td>${escapeHtml(noteText)}</td>
        <td>${imageBtn || "-"}</td>
        <td>${escapeHtml(r.driverUserId ? getUserName(r.driverUserId) : "")}</td>
        <td>${escapeHtml(getUserName(r.createdByUserId))}</td>
        <td><span class="pill pill-status ${escapeHtml(r.status)}">${t(r.status)}</span></td>
        <td><div class="driver-actions">${claimBtn} ${etaSelect} ${etaBtn}</div></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDriverTransfersTable() {
    const tbody = document.getElementById("driverTransfersTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!state.user) return;

    const list = (state.transfers || []).filter((t) => {
      if (t.status === "assigned" || t.status === "in_transit") return true;
      if (t.status === "delivered" && t.readyStatus === "ready") return true;
      return false;
    }).sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

    if (!list.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" class="text-muted">${t("no_transfers_yet")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    list.forEach((t) => {
      const readyLabel = t.readyStatus === "ready" ? t("ready") : t("not_ready");
      const imageBtn = getRequestImageButton(t);
      const rowClass = t.readyStatus === "ready" ? "transfer-ready" : "transfer-row";
      const actionParts = [];
      if (t.status === "assigned") {
        actionParts.push(`<button class="btn btn-primary btn-sm" data-transfer-pickup="${escapeHtml(t.id)}">${t("take_request")}</button>`);
      }
      if (t.status === "in_transit") {
        actionParts.push(`<button class="btn btn-primary btn-sm" data-transfer-deliver="${escapeHtml(t.id)}">${t("deliver")}</button>`);
      }
      const tr = document.createElement("tr");
      tr.className = rowClass;
      tr.innerHTML = `
        <td>${escapeHtml(t.id)}</td>
        <td>${escapeHtml(formatDateTime(t.createdAt))}</td>
        <td>${escapeHtml(t.qty)}</td>
        <td>${escapeHtml(getBranchName(t.fromBranchId))}</td>
        <td>${escapeHtml(getBranchName(t.toBranchId))}</td>
        <td><span class="pill pill-status ${escapeHtml(t.status)}">${t(t.status)}</span></td>
        <td>${escapeHtml(readyLabel)}</td>
        <td>${escapeHtml(t.note || "")}</td>
        <td>${imageBtn || "-"}</td>
        <td>${actionParts.join(" ") || "-"}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderMovementsTable() {
    const tbody = document.getElementById("movementsTableBody");
    tbody.innerHTML = "";
    const moves = [...state.movements].sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).slice(0, 60);

    if (!moves.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="text-muted">${t("no_movements")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    moves.forEach((m) => {
      const item = getItemById(m.itemId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(m.id)}</td>
        <td>${escapeHtml(item ? item.name : m.itemId)}</td>
        <td>${escapeHtml(m.type)}</td>
        <td>${escapeHtml(m.qty)}</td>
        <td>${escapeHtml(getBranchName(m.branchId))}</td>
        <td>${escapeHtml(getUserName(m.userId))}</td>
        <td>${escapeHtml(formatDateTime(m.createdAt))}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function computeAnalytics() {
    const branchSel = document.getElementById("analyticsBranchSelect");
    const fromInput = document.getElementById("analyticsFromDate");
    const toInput = document.getElementById("analyticsToDate");

    const branchId = branchSel ? branchSel.value : "ALL";
    const fromDate = fromInput && fromInput.value ? new Date(fromInput.value + "T00:00:00") : null;
    const toDate = toInput && toInput.value ? new Date(toInput.value + "T23:59:59") : null;

    const storageId = getMainStorageId();

    const delivered = state.requests.filter((r) => {
      if (r.status !== "delivered") return false;
      if (branchId !== "ALL" && r.toBranchId !== branchId) return false;
      if (!r.createdAt) return false;
      const d = new Date(r.createdAt);
      if (fromDate && d < fromDate) return false;
      if (toDate && d > toDate) return false;
      return true;
    });

    let totalCost = 0;
    let totalQty = 0;
    const itemStats = new Map();

    delivered.forEach((r) => {
      const storageItem = state.items.find((it) => it.id === r.itemId && it.branchId === storageId);
      const unitCost = storageItem ? Number(storageItem.unitCost || 0) : 0;
      const qty = Number(r.qty || 0);
      const cost = unitCost * qty;
      totalCost += cost;
      totalQty += qty;

      const key = r.itemId;
      let stat = itemStats.get(key);
      if (!stat) {
        stat = { name: storageItem ? storageItem.name : r.itemId, qty: 0, cost: 0 };
        itemStats.set(key, stat);
      }
      stat.qty += qty;
      stat.cost += cost;
    });

    const itemsArray = Array.from(itemStats.values()).sort((a,b)=> b.cost - a.cost);
    return { totalCost, totalQty, totalRequests: delivered.length, items: itemsArray };
  }

  function csvEscape(value) {
    const str = String(value ?? "");
    if (/[",\n]/.test(str)) {
      return `"${str.replace(/"/g, '""')}"`;
    }
    return str;
  }

  function exportMonthlyReport() {
    const fromInput = document.getElementById("analyticsFromDate");
    const toInput = document.getElementById("analyticsToDate");
    if (!fromInput || !toInput || !fromInput.value || !toInput.value) {
      alert(t("report_date_required"));
      return;
    }

    const fromDate = new Date(fromInput.value + "T00:00:00");
    const toDate = new Date(toInput.value + "T23:59:59");
    if (Number.isNaN(fromDate.getTime()) || Number.isNaN(toDate.getTime()) || fromDate > toDate) {
      alert(t("report_date_required"));
      return;
    }

    const storageId = getMainStorageId();
    const filtered = (state.requests || []).filter((r) => {
      if (r.status !== "delivered" || !r.createdAt) return false;
      const created = new Date(r.createdAt);
      if (Number.isNaN(created.getTime())) return false;
      return created >= fromDate && created <= toDate;
    });

    if (!filtered.length) {
      alert(t("no_orders_in_range"));
      return;
    }

    const header = [
      "Request ID",
      "Created At",
      "Delivered At",
      "Branch",
      "Item",
      "Qty",
      "Unit Cost",
      "Total Cost",
      "Driver",
      "Note"
    ];
    const rows = [header];

    let totalQty = 0;
    let totalCost = 0;

    filtered.forEach((r) => {
      const branchName = getBranchName(r.toBranchId);
      const item = state.items.find((it) => it.id === r.itemId && it.branchId === storageId) || getItemById(r.itemId) || {};
      const unitCost = Number(item.unitCost || 0);
      const qty = Number(r.qty || 0);
      const cost = unitCost * qty;
      totalQty += qty;
      totalCost += cost;

      rows.push([
        r.id,
        formatDateTime(r.createdAt),
        r.deliveredAt ? formatDateTime(r.deliveredAt) : "",
        branchName,
        item.name || r.itemId,
        qty,
        unitCost.toFixed(3),
        cost.toFixed(3),
        r.driverUserId ? getUserName(r.driverUserId) : "",
        r.note || ""
      ]);
    });

    rows.push([]);
    rows.push(["Totals", "", "", "", "", totalQty, "", totalCost.toFixed(3), "", ""]);

    const csvContent = rows.map((row) => row.map(csvEscape).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `monthly-orders-${fromInput.value}-to-${toInput.value}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function renderAnalytics() {
    const { totalCost, totalQty, totalRequests, items } = computeAnalytics();

    const totalCostEl = document.getElementById("analyticsTotalCost");
    const totalQtyEl = document.getElementById("analyticsTotalQty");
    const totalReqEl = document.getElementById("analyticsTotalRequests");
    const tbody = document.getElementById("analyticsItemsTableBody");

    if (totalCostEl) totalCostEl.textContent = totalCost.toFixed(3);
    if (totalQtyEl) totalQtyEl.textContent = totalQty;
    if (totalReqEl) totalReqEl.textContent = totalRequests;

    if (!tbody) return;
    tbody.innerHTML = "";
    if (!items.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="3" class="text-muted">${t("no_delivered_period")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    items.forEach((it) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${escapeHtml(it.qty)}</td><td>${it.cost.toFixed(3)}</td>`;
      tbody.appendChild(tr);
    });
  }

  function renderVehiclesUI() {
    if (!state.user) return;
    const isAdmin = state.user.role === "admin";
    const isManager = state.user.role === "manager";
    const isDriver = state.user.role === "driver";

    const panel = document.getElementById("vehiclePanel");
    const createBlock = document.getElementById("vehicleCreateBlock");
    const assignForm = document.getElementById("vehicleAssignFormBlock");
    const manageBlock = document.getElementById("vehicleManageBlock");

    if (panel && !(isAdmin || isManager || isDriver)) panel.style.display = "none";
    if (createBlock) createBlock.style.display = (isAdmin || isManager) ? "block" : "none";
    if (assignForm) assignForm.style.display = (isAdmin || isManager || isDriver) ? "block" : "none";
    if (manageBlock) manageBlock.style.display = (isAdmin || isManager) ? "block" : "none";

    const remVehSel = document.getElementById("remVehicleSelect");
    const remVehFilter = document.getElementById("remVehicleFilterSelect");
    const assignVehicleSelect = document.getElementById("assignVehicleSelect");
    const assignDriverSelect = document.getElementById("assignDriverSelect");
    const myVehicleIds = state.user
      ? (state.carAssignments || [])
          .filter((a) => a.driverUserId === state.user.id)
          .map((a) => a.vehicleId)
      : [];

    function fillSelect(sel, addAll) {
      if (!sel) return;
      sel.innerHTML = "";
      if (addAll) {
        const all = document.createElement("option");
        all.value = "ALL";
        all.textContent = t("all_vehicles");
        sel.appendChild(all);
      }
      (state.vehicles || []).forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.plate ? `${v.name} (${v.plate})` : v.name;
        sel.appendChild(opt);
      });
      if (addAll) sel.value = "ALL";
    }

    const vehicleEditSelect = document.getElementById("vehicleEditSelect");
    if (vehicleEditSelect) {
      const prev = vehicleEditSelect.value;
      vehicleEditSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = t("select_vehicle_msg");
      vehicleEditSelect.appendChild(placeholder);
      (state.vehicles || []).forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = vehicleOptionLabel(v);
        vehicleEditSelect.appendChild(opt);
      });
      let next = "";
      if (prev && (state.vehicles || []).some((v) => v.id === prev)) {
        next = prev;
      }
      vehicleEditSelect.value = next;
      setVehicleEditInputs(next);
    } else {
      setVehicleEditInputs("");
    }

    fillSelect(remVehSel, false);
    fillSelect(remVehFilter, true);

    if (assignVehicleSelect) {
      const prev = assignVehicleSelect.value;
      assignVehicleSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = t("select_vehicle_msg");
      assignVehicleSelect.appendChild(placeholder);
      const availableVehicles = (state.vehicles || []).filter((v) => {
        if (isAdmin || isManager) return true;
        return myVehicleIds.includes(v.id);
      });
      availableVehicles.forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.plate ? `${v.name} (${v.plate})` : v.name;
        assignVehicleSelect.appendChild(opt);
      });
      let nextValue = "";
      if (availableVehicles.some((v) => v.id === prev)) nextValue = prev;
      else if (availableVehicles.length === 1) nextValue = availableVehicles[0].id;
      assignVehicleSelect.value = nextValue;
    }

    if (assignDriverSelect) {
      const prevDriver = assignDriverSelect.value;
      assignDriverSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = t("select_driver_msg");
      assignDriverSelect.appendChild(placeholder);
      const drivers = (state.users || [])
        .filter((u) => u.role === "driver" && (!isDriver || u.id !== state.user.id))
        .sort((a, b) => a.name.localeCompare(b.name));
      drivers.forEach((driver) => {
        const opt = document.createElement("option");
        opt.value = driver.id;
        opt.textContent = driver.name;
        assignDriverSelect.appendChild(opt);
      });
      assignDriverSelect.value = drivers.some((d) => d.id === prevDriver) ? prevDriver : "";
    }

    renderVehicleAssignmentsTable();
    renderRemindersTable();
    renderMaintenanceForm();
    renderMaintenanceHistoryTable();
    renderMaintenanceSummaryBlock();
  }

  function renderVehicleAssignmentsTable() {
    const tbody = document.getElementById("vehicleAssignmentsTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!state.user) return;

    const canSeeAll = state.user.role === "admin" || state.user.role === "manager";
    let list = state.carAssignments || [];
    list = canSeeAll ? [...list] : list.filter((a) => a.driverUserId === state.user.id);

    if (!list.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="5" class="text-muted">${t("no_assignments")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    list.sort((a, b) => {
      const ad = a.assignedAt ? new Date(a.assignedAt).getTime() : 0;
      const bd = b.assignedAt ? new Date(b.assignedAt).getTime() : 0;
      return bd - ad;
    });

    list.forEach((assign) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(vehicleNameById(assign.vehicleId))}</td>
        <td>${escapeHtml(getUserName(assign.driverUserId))}</td>
        <td>${escapeHtml(assign.note || "")}</td>
        <td>${escapeHtml(formatDateTime(assign.assignedAt))}</td>
        <td>${escapeHtml(getUserName(assign.assignedByUserId))}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderRemindersTable() {
    const tbody = document.getElementById("remindersTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    const filter = document.getElementById("remFilterSelect")?.value || "attention";
    const vehFilter = document.getElementById("remVehicleFilterSelect")?.value || "ALL";

    let list = [...(state.vehicleReminders || [])];

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const soon = new Date(today.getTime());
    const REMINDER_SOON_DAYS = 7;
    soon.setDate(soon.getDate() + REMINDER_SOON_DAYS);

    const isAttention = (r) => {
      if (r.status !== "open") return false;
      if (r.dueDate) {
        const due = new Date(r.dueDate + "T00:00:00");
        if (Number.isNaN(due.getTime())) return false;
        return due <= soon;
      }
      return !!r.dueOdometer;
    };

    if (filter === "attention") list = list.filter(isAttention);
    if (filter === "open") list = list.filter(r => r.status === "open");
    if (filter === "done") list = list.filter(r => r.status === "done");
    if (vehFilter !== "ALL") list = list.filter(r => r.vehicleId === vehFilter);

    list.sort((a,b)=>{
      if (a.status !== b.status) return a.status === "open" ? -1 : 1;
      const ad = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
      const bd = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
      return ad - bd;
    });

    if (!list.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="7" class="text-muted">${t("no_reminders")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    const isEditor = state.user?.role === "admin" || state.user?.role === "manager";

    list.forEach((r) => {
      const statusPill = r.status === "done"
        ? `<span class="pill pill-done">${t("done")}</span>`
        : `<span class="pill pill-open">${currentLang === "ar" ? "مفتوح" : "open"}</span>`;

      const dueText = r.dueDate ? r.dueDate : "";
      const dueDateObj = r.dueDate ? new Date(r.dueDate + "T00:00:00") : null;
      const isOverdue = dueDateObj && dueDateObj < today;
      const isSoon = dueDateObj && dueDateObj <= soon;
      const dueBadge = isOverdue ? t("overdue") : (isSoon ? t("due_soon") : "");
      const odoText = (r.dueOdometer === null || typeof r.dueOdometer === "undefined") ? "" : r.dueOdometer;

      const actionBtns = isEditor ? `
        <button class="btn btn-primary btn-sm" data-rem-done="${escapeHtml(r.id)}">
          ${r.status === "done" ? t("reopen") : t("done")}
        </button>
        <button class="btn btn-secondary btn-sm" data-rem-del="${escapeHtml(r.id)}">${t("delete_reminder")}</button>
      ` : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${statusPill}</td>
        <td>${escapeHtml(vehicleNameById(r.vehicleId))}</td>
        <td>${escapeHtml(typeLabel(r.type))}</td>
        <td${isOverdue ? ' class="danger"' : ""}>${escapeHtml(dueText)}${dueBadge ? ` <span class="pill pill-priority urgent">${escapeHtml(dueBadge)}</span>` : ""}</td>
        <td>${escapeHtml(odoText)}</td>
        <td>${escapeHtml(r.note || "")}</td>
        <td style="display:flex;gap:0.4rem;align-items:center;flex-wrap:wrap;">${actionBtns}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderMaintenanceForm() {
    const block = document.getElementById("maintenanceFormBlock");
    if (!block) return;
    if (!state.user) {
      block.style.display = "none";
      return;
    }
    const isAdmin = state.user.role === "admin";
    const isManager = state.user.role === "manager";
    const isDriver = state.user.role === "driver";
    const availableVehicles = getVehiclesForCurrentUser();
    const showForm = isAdmin || isManager;
    block.style.display = showForm ? "block" : "none";

    const driverField = document.getElementById("maintDriverField");
    if (driverField) driverField.style.display = (isAdmin || isManager) ? "block" : "none";

    const vehicleSelect = document.getElementById("maintVehicleSelect");
    if (vehicleSelect) {
      const prev = vehicleSelect.value;
      vehicleSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = t("select_vehicle_msg");
      vehicleSelect.appendChild(placeholder);
      availableVehicles.forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = vehicleOptionLabel(v);
        vehicleSelect.appendChild(opt);
      });
      if (prev && availableVehicles.some((v) => v.id === prev)) {
        vehicleSelect.value = prev;
      } else if (availableVehicles.length === 1) {
        vehicleSelect.value = availableVehicles[0].id;
      } else {
        vehicleSelect.value = "";
      }
    }

    const driverSelect = document.getElementById("maintDriverSelect");
    if (driverSelect) {
      if (isAdmin || isManager) {
        const prev = driverSelect.value;
        driverSelect.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = t("select_driver_msg");
        driverSelect.appendChild(placeholder);
        (state.users || [])
          .filter((u) => u.role === "driver")
          .sort((a, b) => a.name.localeCompare(b.name))
          .forEach((driver) => {
            const opt = document.createElement("option");
            opt.value = driver.id;
            opt.textContent = driver.name;
            driverSelect.appendChild(opt);
          });
        if (prev && driverSelect.querySelector(`option[value="${prev}"]`)) {
          driverSelect.value = prev;
        } else {
          driverSelect.value = "";
        }
      } else {
        driverSelect.innerHTML = "";
      }
    }
  }

  function renderMaintenanceHistoryTable() {
    const tbody = document.getElementById("maintenanceTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (!state.user) return;

    const filterSelect = document.getElementById("maintenanceHistoryVehicleSelect");
    if (filterSelect) {
      const prev = filterSelect.value;
      filterSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = t("all_vehicles");
      filterSelect.appendChild(allOpt);
      getVehiclesForCurrentUser().forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = vehicleOptionLabel(v);
        filterSelect.appendChild(opt);
      });
      if (prev && filterSelect.querySelector(`option[value="${prev}"]`)) {
        filterSelect.value = prev;
      } else {
        filterSelect.value = "ALL";
      }
    }

    const filterValue = filterSelect ? filterSelect.value : "ALL";
    let list = getVisibleMaintenanceEntries();
    if (filterValue && filterValue !== "ALL") {
      list = list.filter((entry) => entry.vehicleId === filterValue);
    }

    list.sort((a, b) => {
      const aTime = maintenanceEntryTimestamp(a) || 0;
      const bTime = maintenanceEntryTimestamp(b) || 0;
      return bTime - aTime;
    });

    if (!list.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" class="text-muted">${t("no_maintenance_records")}</td>`;
      tbody.appendChild(tr);
      return;
    }

    list.forEach((entry) => {
      const noteParts = [];
      if (entry.note) noteParts.push(entry.note);
      if (entry.storeName) noteParts.push(entry.storeName);
      if (entry.place) noteParts.push(entry.place);
      const noteText = noteParts.join(" • ");
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(entry.maintenanceDate || "")}</td>
        <td>${escapeHtml(vehicleNameById(entry.vehicleId))}</td>
        <td>${escapeHtml(getUserName(entry.driverUserId))}</td>
        <td>${Number(entry.price || 0).toFixed(3)}</td>
        <td>${escapeHtml(entry.invoiceNo || "")}</td>
        <td>${escapeHtml(entry.nextMaintenanceDate || "")}</td>
        <td>${escapeHtml(noteText)}</td>
        <td>${escapeHtml(formatDateTime(entry.createdAt))}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderMaintenanceSummaryBlock() {
    const block = document.getElementById("maintenanceSummaryBlock");
    if (!block) return;
    const canSee = state.user && (state.user.role === "admin" || state.user.role === "manager");
    block.style.display = canSee ? "block" : "none";
    if (!canSee) return;

    const select = document.getElementById("maintenanceSummaryVehicleSelect");
    if (select) {
      const prev = select.value;
      select.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "ALL";
      allOpt.textContent = t("all_vehicles");
      select.appendChild(allOpt);
      (state.vehicles || []).forEach((v) => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = vehicleOptionLabel(v);
        select.appendChild(opt);
      });
      if (prev && select.querySelector(`option[value="${prev}"]`)) {
        select.value = prev;
      } else {
        select.value = "ALL";
      }
    }
    refreshMaintenanceSummary();
  }

  async function refreshMaintenanceSummary() {
    if (!state.user || (state.user.role !== "admin" && state.user.role !== "manager")) return;
    const totalEl = document.getElementById("maintenanceSummaryTotal");
    const countEl = document.getElementById("maintenanceSummaryCount");
    const tbody = document.getElementById("maintenanceSummaryTableBody");
    if (tbody) tbody.innerHTML = "";
    if (totalEl) totalEl.textContent = "...";
    if (countEl) countEl.textContent = "...";

    const fromInput = document.getElementById("maintenanceSummaryFrom");
    const toInput = document.getElementById("maintenanceSummaryTo");
    const vehicleSelect = document.getElementById("maintenanceSummaryVehicleSelect");
    const vehicleId = vehicleSelect && vehicleSelect.value !== "ALL" ? vehicleSelect.value : undefined;

    try {
      const summary = await apiMaintenanceSummary({
        from: fromInput && fromInput.value ? fromInput.value : undefined,
        to: toInput && toInput.value ? toInput.value : undefined,
        vehicleId
      });

      if (totalEl) totalEl.textContent = Number(summary.total || 0).toFixed(3);
      if (countEl) countEl.textContent = summary.count || 0;

      if (tbody) {
        const entries = Object.entries(summary.byCar || {});
        if (!entries.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td colspan="2" class="text-muted">${t("no_maintenance_records")}</td>`;
          tbody.appendChild(tr);
        } else {
          entries
            .sort((a, b) => Number(b[1]) - Number(a[1]))
            .forEach(([vehicleIdKey, total]) => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${escapeHtml(vehicleNameById(vehicleIdKey))}</td>
                <td>${Number(total || 0).toFixed(3)}</td>
              `;
              tbody.appendChild(tr);
            });
        }
      }
    } catch (err) {
      if (totalEl) totalEl.textContent = "0";
      if (countEl) countEl.textContent = "0";
      if (tbody) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="2" class="text-muted">${escapeHtml(err.message || "Error")}</td>`;
        tbody.appendChild(tr);
      }
      alert(err.message);
    }
  }

  function exportMaintenanceCsv() {
    if (!state.user || (state.user.role !== "admin" && state.user.role !== "manager")) return;
    const vehicleSelect = document.getElementById("maintenanceSummaryVehicleSelect");
    const fromInput = document.getElementById("maintenanceSummaryFrom");
    const toInput = document.getElementById("maintenanceSummaryTo");
    const vehicleId = vehicleSelect && vehicleSelect.value !== "ALL" ? vehicleSelect.value : null;
    const from = fromInput && fromInput.value ? fromInput.value : "";
    const to = toInput && toInput.value ? toInput.value : "";

    let list = [...(state.carMaintenances || [])];
    if (vehicleId) list = list.filter((entry) => entry.vehicleId === vehicleId);

    const fromDate = from ? new Date(from + "T00:00:00") : null;
    const toDate = to ? new Date(to + "T23:59:59") : null;

    list = list.filter((entry) => {
      const ts = maintenanceEntryTimestamp(entry);
      if (ts === null) return true;
      if (fromDate && ts < fromDate.getTime()) return false;
      if (toDate && ts > toDate.getTime()) return false;
      return true;
    });

    if (!list.length) {
      alert(t("no_maintenance_records"));
      return;
    }

    list.sort((a, b) => {
      const aTime = maintenanceEntryTimestamp(a) || 0;
      const bTime = maintenanceEntryTimestamp(b) || 0;
      return aTime - bTime;
    });

    const header = [
      t("maintenance_date"),
      t("vehicle"),
      t("th_driver"),
      t("maintenance_price"),
      t("invoice_number"),
      t("next_maintenance_date"),
      t("store_name"),
      t("maintenance_place"),
      t("note"),
      t("th_time")
    ];

    const rows = [header];
    list.forEach((entry) => {
      rows.push([
        entry.maintenanceDate || "",
        vehicleNameById(entry.vehicleId),
        getUserName(entry.driverUserId),
        Number(entry.price || 0).toFixed(3),
        entry.invoiceNo || "",
        entry.nextMaintenanceDate || "",
        entry.storeName || "",
        entry.place || "",
        entry.note || "",
        formatDateTime(entry.createdAt)
      ]);
    });

    const csvContent = rows.map((row) => row.map(csvEscape).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");

    const nameParts = ["maintenance-report"];
    if (from) nameParts.push(`from-${from}`);
    if (to) nameParts.push(`to-${to}`);
    link.href = url;
    link.download = `${nameParts.join("-")}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  function showApp() {
    document.getElementById("loginView").style.display = "none";
    document.getElementById("appView").style.display = "block";

    const isAdmin = state.user.role === "admin";
    const isManager = state.user.role === "manager";
    const isDriver = state.user.role === "driver";
    const isSupervisor = state.user.role === "supervisor";

    const inventoryManageBlock = document.getElementById("inventoryManageBlock");
    if (inventoryManageBlock) {
      inventoryManageBlock.style.display = (isAdmin || isManager) ? "block" : "none";
    }

    const phoneBtn = document.getElementById("phoneModeBtn");
    if (phoneBtn) {
      phoneBtn.style.display = isDriver ? "inline-flex" : "none";
      phoneBtn.textContent = state.phoneMode ? t("phone_mode_off") : t("phone_mode_on");
    }

    renderMenu();
  }

  function logout() {
    clearSession();
    state.user = null;
    state.branches = [];
    state.users = [];
    state.items = [];
    state.movements = [];
    state.budgets = [];
    state.requests = [];
    state.vehicles = [];
    state.vehicleReminders = [];
    state.carAssignments = [];
    state.carMaintenances = [];
    state.inventoryPage = 1;
    state.inventoryPageSize = 40;
    state.phoneMode = false;
    applyPhoneMode();
    updateFaviconBadge(0);
    document.title = t("app_title");
    if ("clearAppBadge" in navigator && typeof navigator.clearAppBadge === "function") {
      navigator.clearAppBadge().catch(() => {});
    }
    document.getElementById("appView").style.display = "none";
    document.getElementById("loginView").style.display = "block";
    const menu = document.getElementById("mainMenu");
    if (menu) menu.style.display = "none";
    renderHeader();
    document.getElementById("loginNameInput").value = "";
    document.getElementById("loginPasswordInput").value = "";
    const err = document.getElementById("loginError");
    err.style.display = "none";
    err.textContent = "";
  }

  async function refreshAllState() {
    const all = await apiLoadState();
    state.branches = all.branches || [];
    state.users = all.users || [];
    state.items = all.items || [];
    state.movements = all.movements || [];
    state.budgets = all.budgets || [];
    state.requests = all.requests || [];
    state.transfers = all.transfers || [];
    state.vehicles = all.vehicles || [];
    state.vehicleReminders = all.vehicleReminders || [];
    state.carAssignments = all.carAssignments || [];
    state.carMaintenances = all.carMaintenances || [];
  }

  function parseThreadNumber(id) {
    const m = /^THR-(\d+)$/i.exec(String(id || "").trim());
    if (!m) return null;
    const n = parseInt(m[1], 10);
    return Number.isFinite(n) ? n : null;
  }

  function getNextThreadId() {
    let max = 0;
    for (const it of state.items || []) {
      const n = parseThreadNumber(it.id);
      if (n && n > max) max = n;
    }
    const next = max + 1;
    return `THR-${String(next).padStart(3, "0")}`;
  }

  async function updateItemIdField() {
    const idInput = document.getElementById("itemIdInput");
    if (!idInput) return;
    const editSel = document.getElementById("itemEditSelect");
    if (editSel && editSel.value) return;
    const typeSelect = document.getElementById("itemTypeSelect");
    const type = typeSelect ? typeSelect.value : "ITEM";
    if (type === "THR") {
      idInput.value = getNextThreadId();
      return;
    }
    try {
      idInput.value = await apiNextItemId();
    } catch {
      idInput.value = "ITEM-001";
    }
  }

  function renderBranchesTable() {
    const tbody = document.getElementById("branchesTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";
    const branches = [...(state.branches || [])].sort((a, b) => (a.name || "").localeCompare(b.name || ""));
    branches.forEach((b) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${escapeHtml(b.id)}</td><td>${escapeHtml(b.name)}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function initFromSession() {
    const session = loadSession();
    if (!session) return;
    state.user = session.user;
    scheduleSessionLogout(session.expiresAt);
    state.phoneMode = localStorage.getItem(PHONE_MODE_KEY) === "1";
    applyPhoneMode();
    try {
      await refreshAllState();

      applyTranslations();
      renderHeader();
      renderBranchSelects();
      fillRequestItemsFromStorage();
      renderInventoryViewer();
      renderUsersTable();
      renderBranchesTable();
      renderRequestsTable();
      renderTransferTables();
      renderDriverRequestsTable();
      renderDriverTransfersTable();
      renderMovementsTable();
      renderAnalytics();
      renderVehiclesUI();
      updateRequestNotifications({ notify: false });

      await updateItemIdField();
      showApp();
    } catch {
      logout();
    }
  }

  // ----- Events -----
  document.getElementById("langBtn").addEventListener("click", () => {
    currentLang = (currentLang === "ar") ? "en" : "ar";
    localStorage.setItem("lang", currentLang);
    applyTranslations();

    renderBranchSelects();
    fillRequestItemsFromStorage();
    renderInventoryViewer();
    if (state.user) {
      renderUsersTable();
      renderBranchesTable();
      renderRequestsTable();
      renderDriverRequestsTable();
      renderMovementsTable();
      renderAnalytics();
      renderVehiclesUI();
      renderHeader();
      renderMenu();
      applyPhoneMode();
    }
  });

  async function handleLoginSubmit() {
    const name = document.getElementById("loginNameInput").value.trim();
    const password = document.getElementById("loginPasswordInput").value;
    const errorEl = document.getElementById("loginError");
    errorEl.style.display = "none";
    errorEl.textContent = "";

    if (!name || !password) {
      errorEl.textContent = t("enter_user_pass");
      errorEl.style.display = "block";
      return;
    }

    try {
      const user = await apiLogin(name, password);
      state.user = user;
      saveSession(user);
      state.phoneMode = localStorage.getItem(PHONE_MODE_KEY) === "1";
      applyPhoneMode();

      await refreshAllState();

      applyTranslations();
      renderHeader();
      renderBranchSelects();
      fillRequestItemsFromStorage();
      renderInventoryViewer();
      renderUsersTable();
      renderBranchesTable();
      renderRequestsTable();
      renderDriverRequestsTable();
      renderMovementsTable();
      renderAnalytics();
      renderVehiclesUI();
      updateRequestNotifications({ notify: false });

      await updateItemIdField();
      showApp();
    } catch (e) {
      errorEl.textContent = e.message;
      errorEl.style.display = "block";
    }
  }

  document.getElementById("loginBtn").addEventListener("click", handleLoginSubmit);
  ["loginNameInput", "loginPasswordInput"].forEach((id) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        handleLoginSubmit();
      }
    });
  });

  document.getElementById("logoutBtn").addEventListener("click", logout);
  document.getElementById("phoneModeBtn").addEventListener("click", () => {
    state.phoneMode = !state.phoneMode;
    applyPhoneMode();
    renderDriverRequestsTable();
  });

  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    if (!state.user) return;
    try {
      await refreshAllState();
      updateRequestNotifications({ notify: true });
      if (state.activePageId === "requestsPanel") renderRequestsTable();
      if (state.activePageId === "transferPanel") renderTransferTables();
      if (state.activePageId === "driverPanel") renderDriverRequestsTable();
      if (state.activePageId === "driverPanel") renderDriverTransfersTable();
    } catch {}
  }, POLL_INTERVAL_MS);

  document.getElementById("inventoryViewBranchSelect").addEventListener("change", () => {
    state.inventoryPage = 1;
    renderInventoryViewer();
  });

  document.getElementById("inventorySearchInput").addEventListener("input", () => {
    state.inventoryPage = 1;
    renderInventoryViewer();
  });

  document.getElementById("requestItemSearchInput").addEventListener("input", () => {
    fillRequestItemsFromStorage();
  });

  document.getElementById("requestImageInput").addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) {
      state.requestImageData = "";
      return;
    }
    try {
      state.requestImageData = await compressImageToDataUrl(file, 1280, 0.7);
    } catch {
      state.requestImageData = "";
    }
  });

  const transferImageInput = document.getElementById("transferImageInput");
  if (transferImageInput) {
    transferImageInput.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        state.transferImageData = "";
        return;
      }
      try {
        state.transferImageData = await compressImageToDataUrl(file, 1280, 0.7);
      } catch {
        state.transferImageData = "";
      }
    });
  }

  const prioritySelectEl = document.getElementById("requestPrioritySelect");
  const urgentNoteEl = document.getElementById("requestUrgentNoteInput");
  if (prioritySelectEl && urgentNoteEl) {
    const toggleUrgent = () => {
      urgentNoteEl.style.display = prioritySelectEl.value === "urgent" ? "block" : "none";
    };
    prioritySelectEl.addEventListener("change", toggleUrgent);
    toggleUrgent();
  }

  document.getElementById("itemEditSearchInput").addEventListener("input", () => {
    renderItemEditSelect();
  });

  document.getElementById("itemTypeSelect").addEventListener("change", () => {
    updateItemIdField();
  });

  document.getElementById("inventoryRefreshBtn").addEventListener("click", async () => {
    await refreshAllState();
    state.inventoryPage = 1;
    renderBranchSelects();
    fillRequestItemsFromStorage();
    renderInventoryViewer();
    renderRequestsTable();
    renderDriverRequestsTable();
    renderMovementsTable();
    renderAnalytics();
    renderVehiclesUI();
    await updateItemIdField();
  });

  document.getElementById("inventoryPrevBtn").addEventListener("click", () => {
    if (state.inventoryPage > 1) {
      state.inventoryPage -= 1;
      renderInventoryViewer();
    }
  });

  document.getElementById("inventoryNextBtn").addEventListener("click", () => {
    state.inventoryPage += 1;
    renderInventoryViewer();
  });

  document.getElementById("inventoryPageSizeSelect").addEventListener("change", (e) => {
    const val = Number(e.target.value) || 40;
    state.inventoryPageSize = val;
    state.inventoryPage = 1;
    renderInventoryViewer();
  });

  // create user
  document.getElementById("addUserBtn").addEventListener("click", async () => {
    if (!state.user || state.user.role !== "admin") {
      alert(t("only_admin_create_users"));
      return;
    }
    const name = document.getElementById("newUserName").value.trim();
    const role = document.getElementById("newUserRole").value;
    const password = document.getElementById("newUserPassword").value.trim();
    const branchId = document.getElementById("newUserBranchSelect").value;

    if (!name || !password) {
      alert(t("name_password_required"));
      return;
    }
    try {
      const newUser = await apiCreateUser(name, role, password, branchId);
      state.users.push(newUser);
      renderUsersTable();
      document.getElementById("newUserName").value = "";
      document.getElementById("newUserPassword").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("editUserSelect").addEventListener("change", () => {
    const id = document.getElementById("editUserSelect").value;
    const user = state.users.find((u) => u.id === id);
    if (!user) {
      document.getElementById("editUserName").value = "";
      document.getElementById("editUserPassword").value = "";
      applySupervisorAccessUI("", "own", "", []);
      return;
    }
    document.getElementById("editUserName").value = user.name;
    document.getElementById("editUserPassword").value = "";
    document.getElementById("editUserRole").value = user.role;
    document.getElementById("editUserBranchSelect").value = user.branchId || "";
    applySupervisorAccessUI(
      user.role,
      getSupervisorAllowedScope(user),
      user.branchId,
      getSupervisorAllowedBranches(user)
    );
  });

  document.getElementById("saveUserChangesBtn").addEventListener("click", async () => {
    const id = document.getElementById("editUserSelect").value;
    if (!id) { alert(t("select_user_first")); return; }

    const name = document.getElementById("editUserName").value.trim();
    const password = document.getElementById("editUserPassword").value.trim();
    const role = document.getElementById("editUserRole").value;
    const branchId = document.getElementById("editUserBranchSelect").value;
    const allowedSel = document.getElementById("editUserAllowedBranches");
    const scopeSel = document.getElementById("editUserAllowedScope");
    const allowedBranchScope = role === "supervisor" ? (scopeSel ? scopeSel.value : "own") : "";
    const selectedIds = role === "supervisor"
      ? Array.from(allowedSel ? allowedSel.selectedOptions : []).map((o) => o.value).filter(Boolean)
      : [];
    const allowedBranchIds = (role === "supervisor" && allowedBranchScope === "multiple") ? selectedIds : [];

    const updates = { name, role, branchId, allowedBranchScope, allowedBranchIds };
    if (password) updates.password = password;

    try {
      const updated = await apiUpdateUser(id, updates);
      const idx = state.users.findIndex((u) => u.id === id);
      if (idx >= 0) state.users[idx] = updated;
      renderUsersTable();
      alert(t("user_updated"));
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("deleteUserBtn").addEventListener("click", async () => {
    const id = document.getElementById("editUserSelect").value;
    if (!id) { alert(t("select_user_first")); return; }
    if (!confirm(t("delete_user_confirm"))) return;

    try {
      await apiDeleteUser(id);
      state.users = state.users.filter((u) => u.id !== id);
      renderUsersTable();
      document.getElementById("editUserName").value = "";
      document.getElementById("editUserPassword").value = "";
      alert(t("user_deleted"));
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("addItemBtn").addEventListener("click", async () => {
    if (!state.user || (state.user.role !== "admin" && state.user.role !== "manager")) {
      alert(t("only_admin_mgr_create_items"));
      return;
    }

    const id = document.getElementById("itemIdInput").value.trim();
    const name = document.getElementById("itemNameInput").value.trim();
    const branchId = document.getElementById("itemBranchSelect").value;
    const baseQty = Number(document.getElementById("itemBaseQtyInput").value || "0");
    const minQty = Number(document.getElementById("itemMinQtyInput").value || "0");
    const unitCost = Number(document.getElementById("itemUnitCostInput").value || "0");

    if (!name) { alert(t("item_name_required")); return; }

    try {
      const newItem = await apiCreateItem({
        id,
        name,
        branchId,
        baseQty,
        minQty,
        unitCost,
        managerUserId: state.user.id
      });

      state.items.push(newItem);

      renderInventoryViewer();
      fillRequestItemsFromStorage();

      document.getElementById("itemNameInput").value = "";
      document.getElementById("itemBaseQtyInput").value = "0";
      document.getElementById("itemMinQtyInput").value = "0";
      document.getElementById("itemUnitCostInput").value = "0";

      await updateItemIdField();
      document.getElementById("itemEditSelect").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  // ✅ Updated: selection uses "id::branchId"
  document.getElementById("itemEditSelect").addEventListener("change", () => {
    applyItemEditSelection();
  });

  document.getElementById("editUserRole").addEventListener("change", () => {
    const role = document.getElementById("editUserRole").value;
    const branchId = document.getElementById("editUserBranchSelect").value;
    applySupervisorAccessUI(role, "own", branchId, []);
  });

  const editUserAllowedScope = document.getElementById("editUserAllowedScope");
  if (editUserAllowedScope) {
    editUserAllowedScope.addEventListener("change", () => {
      const role = document.getElementById("editUserRole").value;
      const branchId = document.getElementById("editUserBranchSelect").value;
      const scope = editUserAllowedScope.value;
      const allowedSel = document.getElementById("editUserAllowedBranches");
      const selectedIds = Array.from(allowedSel ? allowedSel.selectedOptions : []).map((o) => o.value);
      applySupervisorAccessUI(role, scope, branchId, selectedIds);
    });
  }

  // ✅ IMPORTANT FIX: PATCH /items/:id requires branchId in body
  document.getElementById("updateItemBtn").addEventListener("click", async () => {
    if (!state.user || (state.user.role !== "admin" && state.user.role !== "manager")) {
      alert(t("only_admin_mgr_create_items"));
      return;
    }

    const id = document.getElementById("itemIdInput").value.trim();
    const name = document.getElementById("itemNameInput").value.trim();
    const branchId = document.getElementById("itemBranchSelect").value; // ✅ required
    const baseQty = Number(document.getElementById("itemBaseQtyInput").value || "0");
    const minQty = Number(document.getElementById("itemMinQtyInput").value || "0");
    const unitCost = Number(document.getElementById("itemUnitCostInput").value || "0");

    if (!id) {
      alert(currentLang === "ar" ? "اختاري صنف من القائمة أولاً" : "Select an item first");
      return;
    }

    try {
      const updatedItem = await apiUpdateItem(id, {
        userId: state.user.id,
        branchId, // ✅ required by backend
        name,
        baseQty,
        minQty,
        unitCost
      });

      const idx = state.items.findIndex(
        (it) => it.id === updatedItem.id && it.branchId === updatedItem.branchId
      );
      if (idx >= 0) state.items[idx] = updatedItem;

      renderInventoryViewer();
      fillRequestItemsFromStorage();
      renderItemEditSelect();

      alert(currentLang === "ar" ? "تم تحديث الصنف" : "Item updated");
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("addMovementBtn").addEventListener("click", async () => {
    if (!state.user || (state.user.role !== "admin" && state.user.role !== "manager")) {
      alert(t("only_admin_mgr_movements"));
      return;
    }

    const itemId = document.getElementById("movementItemSelect").value;
    const type = document.getElementById("movementTypeSelect").value;
    const qty = Number(document.getElementById("movementQtyInput").value || "1");
    const note = document.getElementById("movementNoteInput").value.trim();

    if (!itemId || !qty || qty <= 0) { alert(t("item_qty_required")); return; }

    try {
      await apiCreateMovement(itemId, type, qty, note);
      await refreshAllState();

      renderBranchSelects();
      fillRequestItemsFromStorage();
      renderInventoryViewer();
      renderMovementsTable();
      renderAnalytics();

      document.getElementById("movementQtyInput").value = "1";
      document.getElementById("movementNoteInput").value = "";
      await updateItemIdField();
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("createRequestBtn").addEventListener("click", async () => {
    if (!state.user || state.user.role === "driver") { alert(t("drivers_cannot_create")); return; }
    if (!state.user.branchId) { alert(t("user_no_branch")); return; }

    const itemId = document.getElementById("requestItemSelect").value;
    const qty = Number(document.getElementById("requestQtyInput").value || "1");
    const note = document.getElementById("requestNoteInput").value.trim();
    const priority = document.getElementById("requestPrioritySelect").value;
    const urgentNote = document.getElementById("requestUrgentNoteInput").value.trim();

    if (!itemId || !qty || qty <= 0) { alert(t("item_qty_required")); return; }

    try {
      const req = await apiCreateRequest(itemId, qty, note, priority, urgentNote, state.requestImageData);
      state.requests.push(req);
      renderRequestsTable();
      renderDriverRequestsTable();
      renderAnalytics();
      document.getElementById("requestQtyInput").value = "1";
      document.getElementById("requestNoteInput").value = "";
      document.getElementById("requestUrgentNoteInput").value = "";
      document.getElementById("requestPrioritySelect").value = "normal";
      document.getElementById("requestImageInput").value = "";
      state.requestImageData = "";
    } catch (e) {
      alert(e.message);
    }
  });

  const createTransferBtn = document.getElementById("createTransferBtn");
  if (createTransferBtn) {
    createTransferBtn.addEventListener("click", async () => {
      if (!state.user || state.user.role === "driver") { alert(t("drivers_cannot_create")); return; }
      if (!state.user.branchId) { alert(t("user_no_branch")); return; }

      const qty = Number(document.getElementById("transferQtyInput").value || "1");
      const note = document.getElementById("transferNoteInput").value.trim();

      if (!qty || qty <= 0) { alert(t("item_qty_required")); return; }

      try {
        const transfer = await apiCreateTransfer(qty, note, state.transferImageData);
        state.transfers.push(transfer);
        renderTransferTables();
        renderDriverTransfersTable();
        document.getElementById("transferQtyInput").value = "1";
        document.getElementById("transferNoteInput").value = "";
        if (document.getElementById("transferImageInput")) document.getElementById("transferImageInput").value = "";
        state.transferImageData = "";
      } catch (e) {
        alert(e.message);
      }
    });
  }

  document.getElementById("deleteItemBtn").addEventListener("click", async () => {
    if (!state.user || (state.user.role !== "admin" && state.user.role !== "manager")) {
      alert(t("only_admin_mgr_create_items"));
      return;
    }

    const id = document.getElementById("itemIdInput").value.trim();
    const branchId = document.getElementById("itemBranchSelect").value;

    if (!id) {
      alert(currentLang === "ar" ? "اختر صنفًا أولًا" : "Select an item first");
      return;
    }
    if (!confirm(t("delete_item_confirm"))) return;

    try {
      await apiDeleteItem(id, { userId: state.user.id, branchId });
      state.items = state.items.filter((it) => !(it.id === id && it.branchId === branchId));
      renderInventoryViewer();
      fillRequestItemsFromStorage();
      renderItemEditSelect();

      document.getElementById("itemEditSelect").value = "";
      document.getElementById("itemNameInput").value = "";
      document.getElementById("itemBaseQtyInput").value = "0";
      document.getElementById("itemMinQtyInput").value = "0";
      document.getElementById("itemUnitCostInput").value = "0";
      await updateItemIdField();

      alert(t("item_deleted"));
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("addBranchBtn").addEventListener("click", async () => {
    if (!state.user || state.user.role !== "admin") {
      alert(t("only_admin_create_users"));
      return;
    }
    const name = document.getElementById("newBranchName").value.trim();
    if (!name) { alert(t("branch_name_required")); return; }
    try {
      const branch = await apiCreateBranch(name);
      state.branches.push(branch);
      renderBranchesTable();
      renderBranchSelects();
      document.getElementById("newBranchName").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("requestsTableBody").addEventListener("click", async (e) => {
    const viewBtn = e.target.closest("button[data-view-image]");
    if (viewBtn) {
      const id = viewBtn.getAttribute("data-view-image");
      openRequestImageById(id);
      return;
    }
    const assignBtn = e.target.closest("button[data-assign-request]");
    if (assignBtn) {
      const id = assignBtn.getAttribute("data-assign-request");
      const select = document.querySelector(`select[data-assign-driver="${CSS.escape(id)}"]`);
      const driverUserId = select ? select.value : "";
      if (!driverUserId) { alert(t("select_driver_msg")); return; }
      try {
        const updated = await apiAssignRequest(id, driverUserId);
        const idx = state.requests.findIndex((r) => r.id === id);
        if (idx >= 0) state.requests[idx] = updated;
        renderRequestsTable();
        renderDriverRequestsTable();
      } catch (err) {
        alert(err.message);
      }
      return;
    }

    const receiveBtn = e.target.closest("button[data-receive-request]");
    if (receiveBtn) {
      const id = receiveBtn.getAttribute("data-receive-request");
      if (!confirm(t("mark_delivered_confirm"))) return;
      try {
        await apiDeliverRequest(id);
        await refreshAllState();

        renderBranchSelects();
        fillRequestItemsFromStorage();
        renderInventoryViewer();
        renderRequestsTable();
        renderDriverRequestsTable();
        renderMovementsTable();
        renderAnalytics();
      } catch (err) {
        alert(err.message);
      }
      return;
    }

    const btn = e.target.closest("button[data-delete-request]");
    if (!btn) return;
    const id = btn.getAttribute("data-delete-request");
    if (!confirm(t("delete_request_confirm"))) return;
    try {
      await apiDeleteRequest(id);
      await refreshAllState();

      renderBranchSelects();
      fillRequestItemsFromStorage();
      renderInventoryViewer();
      renderRequestsTable();
      renderDriverRequestsTable();
      renderMovementsTable();
      renderAnalytics();
    } catch (err) {
      alert(err.message);
    }
  });

  const transferTableBody = document.getElementById("transferTableBody");
  if (transferTableBody) {
    transferTableBody.addEventListener("click", async (e) => {
      const viewBtn = e.target.closest("button[data-view-image]");
      if (viewBtn) {
        const id = viewBtn.getAttribute("data-view-image");
        openRequestImageById(id);
        return;
      }
      const assignBtn = e.target.closest("button[data-transfer-assign-btn]");
      if (assignBtn) {
        const id = assignBtn.getAttribute("data-transfer-assign-btn");
        const select = document.querySelector(`select[data-transfer-assign="${CSS.escape(id)}"]`);
        const toBranchId = select ? select.value : "";
        if (!toBranchId) { alert(t("select_branch")); return; }
        try {
          const updated = await apiAssignTransfer(id, toBranchId);
          const idx = state.transfers.findIndex((t) => t.id === id);
          if (idx >= 0) state.transfers[idx] = updated;
          renderTransferTables();
          renderDriverTransfersTable();
        } catch (err) {
          alert(err.message);
        }
      }
      const readyBtn = e.target.closest("button[data-transfer-ready]");
      if (readyBtn) {
        const id = readyBtn.getAttribute("data-transfer-ready");
        const tItem = (state.transfers || []).find((t) => t.id === id);
        if (!tItem) return;
        const next = tItem.readyStatus === "ready" ? "not_ready" : "ready";
        try {
          const updated = await apiReadyTransfer(id, next);
          const idx = state.transfers.findIndex((t) => t.id === id);
          if (idx >= 0) state.transfers[idx] = updated;
          renderTransferTables();
          renderDriverTransfersTable();
        } catch (err) {
          alert(err.message);
        }
      }
    });
  }

  const transferHistoryTableBody = document.getElementById("transferHistoryTableBody");
  if (transferHistoryTableBody) {
    transferHistoryTableBody.addEventListener("click", (e) => {
      const viewBtn = e.target.closest("button[data-view-image]");
      if (!viewBtn) return;
      const id = viewBtn.getAttribute("data-view-image");
      openRequestImageById(id);
    });
  }

  const requestBranchFilterSelect = document.getElementById("requestBranchFilterSelect");
  if (requestBranchFilterSelect) {
    requestBranchFilterSelect.addEventListener("change", renderRequestsTable);
  }
  const requestHistoryBranchSelect = document.getElementById("requestHistoryBranchSelect");
  if (requestHistoryBranchSelect) {
    requestHistoryBranchSelect.addEventListener("change", renderRequestsHistoryTable);
  }

  document.getElementById("driverRequestsTableBody").addEventListener("change", (e) => {
    const sel = e.target.closest("select[data-eta-type]");
    if (!sel) return;
    const id = sel.getAttribute("data-eta-type");
    const input = document.querySelector(`input[data-eta-custom="${CSS.escape(id)}"]`);
    if (!input) return;
    input.style.display = sel.value === "custom" ? "inline-flex" : "none";
  });

  document.getElementById("driverRequestsTableBody").addEventListener("click", async (e) => {
    const viewBtn = e.target.closest("button[data-view-image]");
    if (viewBtn) {
      const id = viewBtn.getAttribute("data-view-image");
      openRequestImageById(id);
      return;
    }
    const claimBtn = e.target.closest("button[data-claim-request]");
    if (claimBtn) {
      const id = claimBtn.getAttribute("data-claim-request");
      try {
        const updated = await apiClaimRequest(id);
        const idx = state.requests.findIndex((r) => r.id === id);
        if (idx >= 0) state.requests[idx] = updated;
        renderRequestsTable();
        renderDriverRequestsTable();
      } catch (err) {
        alert(err.message);
      }
      return;
    }

    const etaBtn = e.target.closest("button[data-set-eta]");
    if (etaBtn) {
      const id = etaBtn.getAttribute("data-set-eta");
      const typeSel = document.querySelector(`select[data-eta-type="${CSS.escape(id)}"]`);
      const customInput = document.querySelector(`input[data-eta-custom="${CSS.escape(id)}"]`);
      const type = typeSel ? typeSel.value : "";
      const customValue = customInput ? customInput.value : "";
      if (!type) { alert(t("eta_select_msg")); return; }

      const eta = computeEta(type, customValue);
      if (!eta) { alert(t("eta_invalid_msg")); return; }

      try {
        const updated = await apiUpdateRequestEta(id, eta.iso, eta.label);
        const idx = state.requests.findIndex((r) => r.id === id);
        if (idx >= 0) state.requests[idx] = updated;
        renderRequestsTable();
        renderDriverRequestsTable();
      } catch (err) {
        alert(err.message);
      }
    }
  });

  const driverTransfersTableBody = document.getElementById("driverTransfersTableBody");
  if (driverTransfersTableBody) {
    driverTransfersTableBody.addEventListener("click", async (e) => {
      const viewBtn = e.target.closest("button[data-view-image]");
      if (viewBtn) {
        const id = viewBtn.getAttribute("data-view-image");
        openRequestImageById(id);
        return;
      }
      const pickupBtn = e.target.closest("button[data-transfer-pickup]");
      if (pickupBtn) {
        const id = pickupBtn.getAttribute("data-transfer-pickup");
        try {
          const updated = await apiPickupTransfer(id);
          const idx = state.transfers.findIndex((t) => t.id === id);
          if (idx >= 0) state.transfers[idx] = updated;
          renderDriverTransfersTable();
          renderTransferTables();
        } catch (err) {
          alert(err.message);
        }
      }
      const deliverBtn = e.target.closest("button[data-transfer-deliver]");
      if (deliverBtn) {
        const id = deliverBtn.getAttribute("data-transfer-deliver");
        try {
          const updated = await apiDeliverTransfer(id);
          const idx = state.transfers.findIndex((t) => t.id === id);
          if (idx >= 0) state.transfers[idx] = updated;
          renderDriverTransfersTable();
          renderTransferTables();
        } catch (err) {
          alert(err.message);
        }
      }
    });
  }

  document.getElementById("analyticsApplyBtn").addEventListener("click", () => {
    renderAnalytics();
  });
  document.getElementById("exportMonthlyReportBtn").addEventListener("click", exportMonthlyReport);

  document.getElementById("addVehicleBtn").addEventListener("click", async () => {
    const name = document.getElementById("vehNameInput").value.trim();
    const plate = document.getElementById("vehPlateInput").value.trim();
    if (!name) { alert(t("vehicle_name_required_msg")); return; }

    try {
      await apiCreateVehicle(name, plate);
      await refreshAllState();
      renderVehiclesUI();
      document.getElementById("vehNameInput").value = "";
      document.getElementById("vehPlateInput").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  const vehicleEditSelectEl = document.getElementById("vehicleEditSelect");
  if (vehicleEditSelectEl) {
    vehicleEditSelectEl.addEventListener("change", () => {
      setVehicleEditInputs(vehicleEditSelectEl.value);
    });
  }

  document.getElementById("updateVehicleBtn").addEventListener("click", async () => {
    if (!state.user || !["admin", "manager"].includes(state.user.role)) return;
    const id = document.getElementById("vehicleEditSelect").value;
    if (!id) { alert(t("select_vehicle_msg")); return; }
    const name = document.getElementById("vehEditNameInput").value.trim();
    const plate = document.getElementById("vehEditPlateInput").value.trim();
    if (!name) { alert(t("vehicle_name_required_msg")); return; }

    try {
      await apiUpdateVehicle(id, { name, plate });
      await refreshAllState();
      renderVehiclesUI();
      alert(t("vehicle_updated"));
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("deleteVehicleBtn").addEventListener("click", async () => {
    if (!state.user || !["admin", "manager"].includes(state.user.role)) return;
    const id = document.getElementById("vehicleEditSelect").value;
    if (!id) { alert(t("select_vehicle_msg")); return; }
    if (!confirm(t("delete_vehicle_confirm"))) return;

    try {
      await apiDeleteVehicle(id);
      await refreshAllState();
      renderVehiclesUI();
      alert(t("vehicle_deleted"));
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("assignVehicleBtn").addEventListener("click", async () => {
    if (!state.user || !["admin", "manager", "driver"].includes(state.user.role)) {
      alert(t("handover_not_allowed"));
      return;
    }
    const vehicleId = document.getElementById("assignVehicleSelect").value;
    const driverUserId = document.getElementById("assignDriverSelect").value;
    const note = document.getElementById("assignNoteInput").value.trim();

    if (!vehicleId) { alert(t("select_vehicle_msg")); return; }
    if (!driverUserId) { alert(t("select_driver_msg")); return; }

    if (state.user.role === "driver") {
      if (driverUserId === state.user.id) {
        alert(t("select_other_driver"));
        return;
      }
      const ownsVehicle = (state.carAssignments || []).some(
        (a) => a.vehicleId === vehicleId && a.driverUserId === state.user.id
      );
      if (!ownsVehicle) {
        alert(t("drivers_only_their_cars"));
        return;
      }
    }

    try {
      const assignment = await apiAssignVehicle(vehicleId, driverUserId, note);
      state.carAssignments = (state.carAssignments || []).filter(
        (a) => a.vehicleId !== assignment.vehicleId && a.driverUserId !== assignment.driverUserId
      );
      state.carAssignments.push(assignment);
      document.getElementById("assignNoteInput").value = "";
      renderVehiclesUI();
      alert(t("vehicle_assigned_success"));
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("addReminderBtn").addEventListener("click", async () => {
    const vehicleId = document.getElementById("remVehicleSelect").value;
    const type = document.getElementById("remTypeSelect").value;
    const dueDate = document.getElementById("remDueDateInput").value || null;
    const dueOdometerRaw = document.getElementById("remDueOdoInput").value;
    const dueOdometer = dueOdometerRaw === "" ? null : Number(dueOdometerRaw);
    const note = document.getElementById("remNoteInput").value.trim();

    if (!vehicleId) { alert(t("select_vehicle_msg")); return; }

    try {
      await apiCreateReminder({ vehicleId, type, dueDate, dueOdometer, note });
      await refreshAllState();
      renderVehiclesUI();
      document.getElementById("remDueDateInput").value = "";
      document.getElementById("remDueOdoInput").value = "";
      document.getElementById("remNoteInput").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  document.getElementById("remRefreshBtn").addEventListener("click", async () => {
    await refreshAllState();
    renderVehiclesUI();
  });

  document.getElementById("remFilterSelect").addEventListener("change", renderRemindersTable);
  document.getElementById("remVehicleFilterSelect").addEventListener("change", renderRemindersTable);

  document.getElementById("remindersTableBody").addEventListener("click", async (e) => {
    const doneBtn = e.target.closest("button[data-rem-done]");
    const delBtn = e.target.closest("button[data-rem-del]");

    if (doneBtn) {
      const id = doneBtn.getAttribute("data-rem-done");
      const r = (state.vehicleReminders || []).find(x => x.id === id);
      if (!r) return;
      try {
        await apiUpdateReminder(id, { status: r.status === "done" ? "open" : "done" });
        await refreshAllState();
        renderVehiclesUI();
      } catch (err) {
        alert(err.message);
      }
    }

    if (delBtn) {
      const id = delBtn.getAttribute("data-rem-del");
      if (!confirm(t("delete_reminder_confirm"))) return;
      try {
        await apiDeleteReminder(id);
        await refreshAllState();
        renderVehiclesUI();
      } catch (err) {
        alert(err.message);
      }
    }
  });

  const maintenanceHistorySelect = document.getElementById("maintenanceHistoryVehicleSelect");
  if (maintenanceHistorySelect) {
    maintenanceHistorySelect.addEventListener("change", renderMaintenanceHistoryTable);
  }

  const saveMaintenanceBtn = document.getElementById("saveMaintenanceBtn");
  if (saveMaintenanceBtn) {
    saveMaintenanceBtn.addEventListener("click", async () => {
      if (!state.user) return;
      const vehicleSelect = document.getElementById("maintVehicleSelect");
      const driverSelect = document.getElementById("maintDriverSelect");
      const dateInput = document.getElementById("maintDateInput");
      const nextDateInput = document.getElementById("maintNextDateInput");
      const priceInput = document.getElementById("maintPriceInput");
      const invoiceInput = document.getElementById("maintInvoiceInput");
      const noteInput = document.getElementById("maintNoteInput");
      const placeInput = document.getElementById("maintPlaceInput");
      const storeInput = document.getElementById("maintStoreInput");

      const vehicleId = vehicleSelect ? vehicleSelect.value : "";
      const maintenanceDate = dateInput ? dateInput.value : "";
      const nextMaintenanceDate = nextDateInput && nextDateInput.value ? nextDateInput.value : null;
      const invoiceNo = invoiceInput ? invoiceInput.value.trim() : "";
      const priceRaw = priceInput ? priceInput.value : "";
      const price = Number(priceRaw);
      const note = noteInput ? noteInput.value.trim() : "";
      const place = placeInput ? placeInput.value.trim() : "";
      const storeName = storeInput ? storeInput.value.trim() : "";
      const driverUserId = driverSelect ? driverSelect.value : state.user.id;

      if (!vehicleId || !maintenanceDate || !invoiceNo || !Number.isFinite(price)) {
        alert(t("maintenance_required_fields"));
        return;
      }

      try {
        await apiCreateMaintenance({
          vehicleId,
          maintenanceDate,
          nextMaintenanceDate,
          price,
          invoiceNo,
          place,
          storeName,
          note,
          driverUserId: driverUserId || undefined
        });

        await refreshAllState();
        renderVehiclesUI();
        if (invoiceInput) invoiceInput.value = "";
        if (priceInput) priceInput.value = "";
        if (noteInput) noteInput.value = "";
        if (placeInput) placeInput.value = "";
        if (storeInput) storeInput.value = "";
        alert(t("maintenance_saved"));
      } catch (err) {
        alert(err.message);
      }
    });
  }

  const maintenanceRefreshBtn = document.getElementById("maintenanceRefreshBtn");
  if (maintenanceRefreshBtn) {
    maintenanceRefreshBtn.addEventListener("click", async () => {
      await refreshAllState();
      renderVehiclesUI();
    });
  }

  const maintenanceSummaryApplyBtn = document.getElementById("maintenanceSummaryApplyBtn");
  if (maintenanceSummaryApplyBtn) {
    maintenanceSummaryApplyBtn.addEventListener("click", () => {
      refreshMaintenanceSummary();
    });
  }

  const maintenanceSummaryVehicleSelect = document.getElementById("maintenanceSummaryVehicleSelect");
  if (maintenanceSummaryVehicleSelect) {
    maintenanceSummaryVehicleSelect.addEventListener("change", () => {
      refreshMaintenanceSummary();
    });
  }

  const maintenanceExportBtn = document.getElementById("maintenanceExportBtn");
  if (maintenanceExportBtn) {
    maintenanceExportBtn.addEventListener("click", exportMaintenanceCsv);
  }

  // initial i18n
  applyTranslations();
  initFromSession();
</script>
</body>
</html>
