<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Storage Manage Method</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }

    header {
      background: #111827;
      color: white;
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    header h1 {
      font-size: 1rem;
      margin: 0;
      letter-spacing: 0.03em;
    }

    header small {
      display: block;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.8rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #e5e7eb;
      color: #111827;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: none;
      padding: 0.45rem 1.1rem; /* bigger */
      font-size: 0.85rem;       /* slightly bigger */
      cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }

    .btn-primary {
      background: #111827;
      color: white;
    }

    .btn-primary:hover {
      background: #020617;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
      transform: translateY(-1px);
    }

    .btn-sm {
      padding: 0.35rem 0.8rem;
      font-size: 0.78rem;
    }

    main {
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto 2rem;
    }

    .panel {
      background: white;
      border-radius: 0.9rem;
      padding: 0.9rem 1rem;
      margin-bottom: 0.9rem;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.06);
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      gap: 0.75rem;
    }

    .panel-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
    }

    .panel-subtitle {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .panel-section-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin: 0.5rem 0 0.3rem;
    }

    .text-muted {
      color: #9ca3af;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.6rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }

    label {
      font-size: 0.78rem;
      display: block;
      margin-bottom: 0.15rem;
      color: #374151;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.35rem 0.55rem;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
      font-size: 0.8rem;
      background: #ffffff;
    }

    textarea {
      resize: vertical;
      min-height: 40px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #111827;
      box-shadow: 0 0 0 1px #11182711;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th,
    td {
      padding: 0.35rem 0.4rem;
      text-align: left;
      border-bottom: 1px solid #f3f4f6;
      white-space: nowrap;
    }

    th {
      font-size: 0.72rem;
      font-weight: 600;
      color: #6b7280;
      background: #f9fafb;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.05rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
    }

    .pill-status {
      background: #e5e7eb;
      color: #111827;
    }

    .pill-status.pending {
      background: #fef3c7;
      color: #92400e;
    }

    .pill-status.delivered {
      background: #dcfce7;
      color: #166534;
    }

    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      margin-top: 0.4rem;
    }

    .danger {
      color: #b91c1c;
      font-weight: 600;
    }

    .success {
      color: #166534;
    }

    /* Login card */
    #loginView {
      max-width: 640px;
      margin: 2.5rem auto;
      padding: 0 1rem;
    }

    .card {
      background: white;
      border-radius: 1rem;
      padding: 1.2rem 1.5rem;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    .card h2 {
      margin: 0 0 0.5rem;
      font-size: 1.2rem;
    }

    .mt-xs {
      margin-top: 0.35rem;
    }

    .mt-sm {
      margin-top: 0.6rem;
    }

    .mt-md {
      margin-top: 0.9rem;
    }

    .mt-lg {
      margin-top: 1.2rem;
    }

    .error-text {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: #b91c1c;
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }

      main {
        padding: 0.6rem;
      }

      .panel {
        padding: 0.7rem 0.8rem;
      }

      .grid,
      .grid-2 {
        grid-template-columns: minmax(0, 1fr);
      }

      table {
        font-size: 0.75rem;
      }

      th,
      td {
        padding: 0.25rem 0.3rem;
      }
    }
  </style>
</head>
<body>
<header>
  <div>
    <h1>Storage Manage Method</h1>
    <small>Branch → Storage orders, drivers & budgets</small>
  </div>
  <div class="header-right">
    <span id="headerUserName" class="badge" style="display:none;"></span>
    <span id="headerRole" class="badge" style="display:none;"></span>
    <button id="logoutBtn" class="btn btn-secondary btn-sm" style="display:none;">
      Logout
    </button>
  </div>
</header>

<!-- LOGIN VIEW -->
<section id="loginView">
  <div class="card">
    <h2>Sign in</h2>

    <div class="mt-md grid-2">
      <div>
        <label>Username</label>
        <input id="loginNameInput" placeholder="Admin, Manager1, StaffZahra..." />
      </div>
      <div>
        <label>Password</label>
        <input id="loginPasswordInput" type="password" placeholder="••••••••" />
      </div>
    </div>

    <button id="loginBtn" class="btn btn-primary mt-md" style="width: 100%;">
      Sign in
    </button>

    <div id="loginError" class="error-text" style="display:none;"></div>
  </div>
</section>

<!-- APP VIEW -->
<main id="appView" style="display:none;">

  <!-- Inventory panel -->
  <section id="inventoryPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title">Inventory (by branch)</div>
        <div class="panel-subtitle">
          Admin & Manager can add items. Staff can view.
        </div>
      </div>
    </div>

    <div class="panel-section-title">Add / update items (Admin & Manager)</div>
    <div class="grid mt-xs">
      <div>
        <label>Item ID</label>
        <input id="itemIdInput" placeholder="ITEM-100" />
      </div>
      <div>
        <label>Name</label>
        <input id="itemNameInput" placeholder="ZIPPER MAKFI LONG YKK" />
      </div>
      <div>
        <label>Branch (storage)</label>
        <select id="itemBranchSelect"></select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label>Base quantity</label>
        <input id="itemBaseQtyInput" type="number" min="0" value="0" />
      </div>
      <div>
        <label>Minimum quantity (alert)</label>
        <input id="itemMinQtyInput" type="number" min="0" value="0" />
      </div>
      <div>
        <label>Unit cost</label>
        <input id="itemUnitCostInput" type="number" min="0" step="0.001" value="0" />
      </div>
    </div>
    <button id="addItemBtn" class="btn btn-primary mt-sm">
      Save item
    </button>

    <div class="panel-section-title mt-md">Items list</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Branch</th>
          <th>Base qty</th>
          <th>Min</th>
          <th>Unit cost</th>
        </tr>
        </thead>
        <tbody id="itemsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Users (Admin) -->
  <section id="usersPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title">Users & branches</div>
        <div class="panel-subtitle">
          Admin can create users and assign them to a branch. Drivers see all requests.
        </div>
      </div>
    </div>

    <div class="panel-section-title">Create user</div>
    <div class="grid mt-xs">
      <div>
        <label>Username</label>
        <input id="newUserName" placeholder="StaffZahra" />
      </div>
      <div>
        <label>Password</label>
        <input id="newUserPassword" placeholder="********" />
      </div>
      <div>
        <label>Role</label>
        <select id="newUserRole">
          <option value="staff">Staff</option>
          <option value="manager">Manager</option>
          <option value="driver">Driver</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label>Branch</label>
        <select id="newUserBranchSelect"></select>
      </div>
      <div></div>
      <div style="display:flex;align-items:flex-end;">
        <button id="addUserBtn" class="btn btn-primary" style="width:100%;">Create user</button>
      </div>
    </div>

    <div class="panel-section-title mt-md">Users list</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>Name</th>
          <th>Role</th>
          <th>Branch</th>
        </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Requests (staff/manager/admin) -->
  <section id="requestsPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title">Branch requests</div>
        <div class="panel-subtitle">
          Staff / Manager / Admin request items from Main Storage to their own branch.
        </div>
      </div>
    </div>

    <div class="panel-section-title">New request</div>
    <div class="grid mt-xs">
      <div>
        <label>From storage</label>
        <div id="requestFromBranchLabel" class="text-muted" style="font-size:0.8rem;"></div>
      </div>
      <div>
        <label>To branch</label>
        <div id="requestToBranchLabel" class="text-muted" style="font-size:0.8rem;"></div>
      </div>
      <div>
        <label>Item (from storage)</label>
        <select id="requestItemSelect"></select>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label>Quantity</label>
        <input id="requestQtyInput" type="number" min="1" value="1" />
      </div>
      <div>
        <label>Note</label>
        <input id="requestNoteInput" placeholder="For client order, urgent..." />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="createRequestBtn" class="btn btn-primary" style="width:100%;">
          Create request
        </button>
      </div>
    </div>

    <div class="panel-section-title mt-md">Requests from my branch</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Qty</th>
          <th>From</th>
          <th>To</th>
          <th>Status</th>
          <th>By</th>
          <th>Driver</th>
        </tr>
        </thead>
        <tbody id="requestsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Driver panel -->
  <section id="driverPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title">Driver deliveries</div>
        <div class="panel-subtitle">
          Drivers see all pending requests and mark them as delivered.
        </div>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Qty</th>
          <th>From</th>
          <th>To</th>
          <th>Requested by</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
        </thead>
        <tbody id="driverRequestsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Movements -->
  <section id="movementsPanel" class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title">Manual stock movements</div>
        <div class="panel-subtitle">
          Only Admin & Manager can record IN / OUT movements that change stock.
        </div>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label>Item</label>
        <select id="movementItemSelect"></select>
      </div>
      <div>
        <label>Type</label>
        <select id="movementTypeSelect">
          <option value="IN">IN (add)</option>
          <option value="OUT">OUT (remove)</option>
        </select>
      </div>
      <div>
        <label>Quantity</label>
        <input id="movementQtyInput" type="number" min="1" value="1" />
      </div>
    </div>
    <div class="grid mt-xs">
      <div>
        <label>Note</label>
        <input id="movementNoteInput" placeholder="Adjustment, correction..." />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="addMovementBtn" class="btn btn-primary" style="width:100%;">
          Save movement
        </button>
      </div>
    </div>

    <div class="panel-section-title mt-md">Recent movements</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>ID</th>
          <th>Item</th>
          <th>Type</th>
          <th>Qty</th>
          <th>Branch</th>
          <th>User</th>
          <th>Time</th>
        </tr>
        </thead>
        <tbody id="movementsTableBody"></tbody>
      </table>
    </div>
  </section>

  <!-- Budgets (Admin) -->
  <section id="budgetPanel" class="panel" style="display:none;">
    <div class="panel-header">
      <div>
        <div class="panel-title">Branch budgets</div>
        <div class="panel-subtitle">
          Admin can record monthly planned budgets by branch.
        </div>
      </div>
    </div>

    <div class="grid mt-xs">
      <div>
        <label>Branch</label>
        <select id="budgetBranchSelect"></select>
      </div>
      <div>
        <label>Month (YYYY-MM)</label>
        <input id="budgetMonthInput" placeholder="2025-01" />
      </div>
      <div>
        <label>Planned budget</label>
        <input id="budgetPlannedInput" type="number" min="0" step="0.01" />
      </div>
    </div>
    <button id="saveBudgetBtn" class="btn btn-primary mt-sm">
      Save budget
    </button>

    <div class="panel-section-title mt-md">Budgets</div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>Branch</th>
          <th>Month</th>
          <th>Planned</th>
        </tr>
        </thead>
        <tbody id="budgetsTableBody"></tbody>
      </table>
    </div>
  </section>

</main>

<script>
  const API_BASE = "/api";

  const state = {
    user: null,
    branches: [],
    users: [],
    items: [],
    movements: [],
    budgets: [],
    requests: []
  };

  // ----- Helpers -----
  function getBranchName(id) {
    const b = state.branches.find((x) => x.id === id);
    return b ? b.name : id || "";
  }

  function getUserName(id) {
    const u = state.users.find((x) => x.id === id);
    return u ? u.name : id || "";
  }

  function getItemById(id) {
    return state.items.find((x) => x.id === id);
  }

  function formatDateTime(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }

  function getMainStorageId() {
    const byName = state.branches.find((b) =>
      (b.name || "").toLowerCase().includes("main")
    );
    if (byName) return byName.id;
    return state.branches[0] ? state.branches[0].id : null;
  }

  // ----- API calls -----
  async function apiLogin(name, password) {
    const res = await fetch(`${API_BASE}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, password })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Login failed");
    return body;
  }

  async function apiLoadState() {
    const res = await fetch(`${API_BASE}/state`);
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Load state failed");
    return body;
  }

  async function apiCreateUser(name, role, password, branchId) {
    const res = await fetch(`${API_BASE}/users`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name,
        role,
        password,
        branchId,
        adminUserId: state.user.id
      })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create user failed");
    return body;
  }

  async function apiCreateItem(data) {
    const res = await fetch(`${API_BASE}/items`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Create item failed");
    return body;
  }

  async function apiCreateMovement(itemId, type, qty, note) {
    const res = await fetch(`${API_BASE}/movements`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        itemId,
        type,
        qty,
        note,
        userId: state.user.id
      })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Movement failed");
    return body;
  }

  async function apiCreateRequest(itemId, qty, note) {
    const res = await fetch(`${API_BASE}/requests`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        itemId,
        qty,
        note,
        userId: state.user.id
      })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Request failed");
    return body;
  }

  async function apiDeliverRequest(id) {
    const res = await fetch(`${API_BASE}/requests/${id}/deliver`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ driverUserId: state.user.id })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Deliver failed");
    return body; // { request, movements: [...] }
  }

  async function apiSaveBudget(branchId, month, planned) {
    const res = await fetch(`${API_BASE}/budgets`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        branchId,
        month,
        planned,
        adminUserId: state.user.id
      })
    });
    const body = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(body.error || "Budget save failed");
    return body;
  }

  // ----- Render functions -----
  function renderHeader() {
    const headerUser = document.getElementById("headerUserName");
    const headerRole = document.getElementById("headerRole");
    const logoutBtn = document.getElementById("logoutBtn");

    if (!state.user) {
      headerUser.style.display = "none";
      headerRole.style.display = "none";
      logoutBtn.style.display = "none";
      return;
    }

    headerUser.textContent = state.user.name;
    headerUser.style.display = "inline-flex";

    const branchText = state.user.branchId
      ? ` | Branch: ${getBranchName(state.user.branchId)}`
      : "";
    headerRole.textContent = `Role: ${state.user.role}${branchText}`;
    headerRole.style.display = "inline-flex";

    logoutBtn.style.display = "inline-flex";
  }

  function renderBranchSelects() {
    const selects = [
      document.getElementById("itemBranchSelect"),
      document.getElementById("budgetBranchSelect"),
      document.getElementById("newUserBranchSelect")
    ];

    selects.forEach((sel) => {
      if (!sel) return;
      sel.innerHTML = "";
      state.branches.forEach((b, idx) => {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.name;
        if (idx === 0) opt.selected = true;
        sel.appendChild(opt);
      });
    });

    const fromLabel = document.getElementById("requestFromBranchLabel");
    const toLabel = document.getElementById("requestToBranchLabel");
    if (fromLabel) {
      const mainId = getMainStorageId();
      fromLabel.textContent = getBranchName(mainId);
    }
    if (toLabel && state.user && state.user.branchId) {
      toLabel.textContent = getBranchName(state.user.branchId);
    }
  }

  function renderItemsTable() {
    const tbody = document.getElementById("itemsTableBody");
    tbody.innerHTML = "";
    const items = [...state.items].sort((a, b) =>
      a.name.localeCompare(b.name)
    );
    if (!items.length) {
      const tr = document.createElement("tr");
      tr.innerHTML =
        '<td colspan="6" class="text-muted">No items defined.</td>';
      tbody.appendChild(tr);
      return;
    }
    items.forEach((it) => {
      const tr = document.createElement("tr");
      const low = it.baseQty <= it.minQty && it.minQty > 0;
      tr.innerHTML = `
        <td>${it.id}</td>
        <td>${it.name}</td>
        <td>${getBranchName(it.branchId)}</td>
        <td${low ? ' class="danger"' : ""}>${it.baseQty}</td>
        <td>${it.minQty}</td>
        <td>${it.unitCost}</td>
      `;
      tbody.appendChild(tr);
    });

    // fill movement item select (any branch)
    const moveSelect = document.getElementById("movementItemSelect");
    if (moveSelect) {
      moveSelect.innerHTML = "";
      state.items.forEach((it, idx) => {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = `${it.name} (${getBranchName(it.branchId)})`;
        if (idx === 0) opt.selected = true;
        moveSelect.appendChild(opt);
      });
    }
  }

  function fillRequestItemsFromStorage() {
    const itemSel = document.getElementById("requestItemSelect");
    if (!itemSel) return;
    const storageId = getMainStorageId();
    itemSel.innerHTML = "";
    const items = state.items.filter((it) => it.branchId === storageId);
    items.forEach((it, idx) => {
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = `${it.name} (Main Storage)`;
      if (idx === 0) opt.selected = true;
      itemSel.appendChild(opt);
    });
  }

  function renderUsersTable() {
    const tbody = document.getElementById("usersTableBody");
    tbody.innerHTML = "";
    const users = [...state.users].sort((a, b) =>
      a.name.localeCompare(b.name)
    );
    users.forEach((u) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.name}</td>
        <td>${u.role}</td>
        <td>${getBranchName(u.branchId)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderRequestsTable() {
    const tbody = document.getElementById("requestsTableBody");
    tbody.innerHTML = "";
    const all = [...state.requests].sort(
      (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
    );

    const visible =
      state.user.role === "driver"
        ? all
        : all.filter((r) => r.toBranchId === state.user.branchId);

    if (!visible.length) {
      const tr = document.createElement("tr");
      tr.innerHTML =
        '<td colspan="8" class="text-muted">No requests yet.</td>';
      tbody.appendChild(tr);
      return;
    }

    visible.forEach((r) => {
      const item = getItemById(r.itemId);
      const driverName = r.driverUserId ? getUserName(r.driverUserId) : "";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${item ? item.name : r.itemId}</td>
        <td>${r.qty}</td>
        <td>${getBranchName(r.fromBranchId)}</td>
        <td>${getBranchName(r.toBranchId)}</td>
        <td><span class="pill pill-status ${r.status}">${r.status}</span></td>
        <td>${getUserName(r.createdByUserId)}</td>
        <td>${driverName}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDriverRequestsTable() {
    const tbody = document.getElementById("driverRequestsTableBody");
    tbody.innerHTML = "";
    const pending = state.requests.filter((r) => r.status === "pending");
    if (!pending.length) {
      const tr = document.createElement("tr");
      tr.innerHTML =
        '<td colspan="8" class="text-muted">No pending requests.</td>';
      tbody.appendChild(tr);
      return;
    }
    pending.forEach((r) => {
      const item = getItemById(r.itemId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${item ? item.name : r.itemId}</td>
        <td>${r.qty}</td>
        <td>${getBranchName(r.fromBranchId)}</td>
        <td>${getBranchName(r.toBranchId)}</td>
        <td>${getUserName(r.createdByUserId)}</td>
        <td><span class="pill pill-status ${r.status}">${r.status}</span></td>
        <td><button class="btn btn-primary btn-sm" data-req-id="${r.id}">Deliver</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderMovementsTable() {
    const tbody = document.getElementById("movementsTableBody");
    tbody.innerHTML = "";
    const moves = [...state.movements]
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .slice(0, 50);

    if (!moves.length) {
      const tr = document.createElement("tr");
      tr.innerHTML =
        '<td colspan="7" class="text-muted">No movements recorded.</td>';
      tbody.appendChild(tr);
      return;
    }

    moves.forEach((m) => {
      const item = getItemById(m.itemId);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.id}</td>
        <td>${item ? item.name : m.itemId}</td>
        <td>${m.type}</td>
        <td>${m.qty}</td>
        <td>${getBranchName(m.branchId)}</td>
        <td>${getUserName(m.userId)}</td>
        <td>${formatDateTime(m.createdAt)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderBudgetsTable() {
    const tbody = document.getElementById("budgetsTableBody");
    tbody.innerHTML = "";
    const budgets = [...state.budgets].sort((a, b) =>
      (a.month || "").localeCompare(b.month || "")
    );
    if (!budgets.length) {
      const tr = document.createElement("tr");
      tr.innerHTML =
        '<td colspan="3" class="text-muted">No budgets recorded.</td>';
      tbody.appendChild(tr);
      return;
    }
    budgets.forEach((b) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${getBranchName(b.branchId)}</td>
        <td>${b.month}</td>
        <td>${b.planned}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ----- UI toggling -----
  function showApp() {
    document.getElementById("loginView").style.display = "none";
    document.getElementById("appView").style.display = "block";

    const isAdmin = state.user.role === "admin";
    const isManager = state.user.role === "manager";
    const isDriver = state.user.role === "driver";

    document.getElementById("usersPanel").style.display = isAdmin
      ? "block"
      : "none";
    document.getElementById("budgetPanel").style.display = isAdmin
      ? "block"
      : "none";
    document.getElementById("driverPanel").style.display = isDriver
      ? "block"
      : "none";

    document.getElementById("requestsPanel").style.display = isDriver
      ? "none"
      : "block";
    document.getElementById("inventoryPanel").style.display = isDriver
      ? "none"
      : "block";
    document.getElementById("movementsPanel").style.display =
      isAdmin || isManager ? "block" : "none";
  }

  function resetLoginForm() {
    document.getElementById("loginNameInput").value = "";
    document.getElementById("loginPasswordInput").value = "";
    document.getElementById("loginError").style.display = "none";
  }

  function logout() {
    state.user = null;
    state.branches = [];
    state.users = [];
    state.items = [];
    state.movements = [];
    state.budgets = [];
    state.requests = [];
    document.getElementById("appView").style.display = "none";
    document.getElementById("loginView").style.display = "block";
    renderHeader();
    resetLoginForm();
  }

  // ----- Event wiring -----
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const name = document.getElementById("loginNameInput").value.trim();
    const password = document.getElementById("loginPasswordInput").value;
    const errorEl = document.getElementById("loginError");
    errorEl.style.display = "none";
    errorEl.textContent = "";
    if (!name || !password) {
      errorEl.textContent = "Enter username and password.";
      errorEl.style.display = "block";
      return;
    }
    try {
      const user = await apiLogin(name, password);
      state.user = user;
      const all = await apiLoadState();
      state.branches = all.branches || [];
      state.users = all.users || [];
      state.items = all.items || [];
      state.movements = all.movements || [];
      state.budgets = all.budgets || [];
      state.requests = all.requests || [];

      renderHeader();
      renderBranchSelects();
      renderItemsTable();
      fillRequestItemsFromStorage();
      renderUsersTable();
      renderRequestsTable();
      renderDriverRequestsTable();
      renderMovementsTable();
      renderBudgetsTable();
      showApp();
    } catch (e) {
      errorEl.textContent = e.message;
      errorEl.style.display = "block";
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", logout);

  // create user
  document.getElementById("addUserBtn").addEventListener("click", async () => {
    if (!state.user || state.user.role !== "admin") {
      alert("Only admin can create users.");
      return;
    }
    const name = document.getElementById("newUserName").value.trim();
    const role = document.getElementById("newUserRole").value;
    const password = document
      .getElementById("newUserPassword")
      .value.trim();
    const branchId = document.getElementById("newUserBranchSelect").value;

    if (!name || !password) {
      alert("Name and password required.");
      return;
    }
    try {
      const newUser = await apiCreateUser(name, role, password, branchId);
      state.users.push(newUser);
      renderUsersTable();
      document.getElementById("newUserName").value = "";
      document.getElementById("newUserPassword").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  // create item
  document.getElementById("addItemBtn").addEventListener("click", async () => {
    if (
      !state.user ||
      (state.user.role !== "admin" && state.user.role !== "manager")
    ) {
      alert("Only admin/manager can create items.");
      return;
    }
    const id = document.getElementById("itemIdInput").value.trim();
    const name = document.getElementById("itemNameInput").value.trim();
    const branchId = document.getElementById("itemBranchSelect").value;
    const baseQty = Number(
      document.getElementById("itemBaseQtyInput").value || "0"
    );
    const minQty = Number(
      document.getElementById("itemMinQtyInput").value || "0"
    );
    const unitCost = Number(
      document.getElementById("itemUnitCostInput").value || "0"
    );

    if (!id || !name) {
      alert("Item ID and name required.");
      return;
    }

    try {
      const newItem = await apiCreateItem({
        id,
        name,
        branchId,
        baseQty,
        minQty,
        unitCost,
        managerUserId: state.user.id
      });
      state.items.push(newItem);
      renderItemsTable();
      fillRequestItemsFromStorage();
      document.getElementById("itemIdInput").value = "";
      document.getElementById("itemNameInput").value = "";
    } catch (e) {
      alert(e.message);
    }
  });

  // manual movement (Admin & Manager)
  document
    .getElementById("addMovementBtn")
    .addEventListener("click", async () => {
      if (
        !state.user ||
        (state.user.role !== "admin" && state.user.role !== "manager")
      ) {
        alert("Only admin/manager can record movements.");
        return;
      }

      const itemId = document.getElementById("movementItemSelect").value;
      const type = document.getElementById("movementTypeSelect").value;
      const qty = Number(
        document.getElementById("movementQtyInput").value || "1"
      );
      const note = document
        .getElementById("movementNoteInput")
        .value.trim();
      if (!itemId || !qty || qty <= 0) {
        alert("Item and quantity required.");
        return;
      }
      try {
        await apiCreateMovement(itemId, type, qty, note);
        const all = await apiLoadState();
        state.items = all.items || [];
        state.movements = all.movements || [];
        renderItemsTable();
        fillRequestItemsFromStorage();
        renderMovementsTable();
        document.getElementById("movementQtyInput").value = "1";
        document.getElementById("movementNoteInput").value = "";
      } catch (e) {
        alert(e.message);
      }
    });

  // create request
  document
    .getElementById("createRequestBtn")
    .addEventListener("click", async () => {
      if (!state.user || state.user.role === "driver") {
        alert("Drivers cannot create requests.");
        return;
      }
      if (!state.user.branchId) {
        alert("Your user is not assigned to a branch. Ask admin.");
        return;
      }

      const itemId = document.getElementById("requestItemSelect").value;
      const qty = Number(
        document.getElementById("requestQtyInput").value || "1"
      );
      const note = document
        .getElementById("requestNoteInput")
        .value.trim();

      if (!itemId || !qty || qty <= 0) {
        alert("Item and quantity required.");
        return;
      }

      try {
        const req = await apiCreateRequest(itemId, qty, note);
        state.requests.push(req);
        renderRequestsTable();
        renderDriverRequestsTable();
        document.getElementById("requestQtyInput").value = "1";
        document.getElementById("requestNoteInput").value = "";
      } catch (e) {
        alert(e.message);
      }
    });

  // driver deliver
  document
    .getElementById("driverRequestsTableBody")
    .addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-req-id]");
      if (!btn) return;
      const id = btn.getAttribute("data-req-id");
      if (!confirm("Mark this request as delivered?")) return;
      try {
        await apiDeliverRequest(id);
        const all = await apiLoadState();
        state.items = all.items || [];
        state.movements = all.movements || [];
        state.requests = all.requests || [];

        renderItemsTable();
        fillRequestItemsFromStorage();
        renderDriverRequestsTable();
        renderRequestsTable();
        renderMovementsTable();
      } catch (err) {
        alert(err.message);
      }
    });

  // save budget
  document
    .getElementById("saveBudgetBtn")
    .addEventListener("click", async () => {
      const branchId = document.getElementById("budgetBranchSelect").value;
      const month = document.getElementById("budgetMonthInput").value.trim();
      const planned = Number(
        document.getElementById("budgetPlannedInput").value || "0"
      );
      if (!month) {
        alert("Month required (e.g. 2025-01).");
        return;
      }
      try {
        const b = await apiSaveBudget(branchId, month, planned);
        const existingIndex = state.budgets.findIndex(
          (x) =>
            x.id === b.id ||
            (x.branchId === b.branchId && x.month === b.month)
        );
        if (existingIndex >= 0) state.budgets[existingIndex] = b;
        else state.budgets.push(b);
        renderBudgetsTable();
      } catch (e) {
        alert(e.message);
      }
    });
</script>
</body>
</html>
